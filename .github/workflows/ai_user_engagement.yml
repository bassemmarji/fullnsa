name: AI-Powered User Engagement Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "Full-NSA"
      model_name:
        description: "Ollama model to use"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  collect-engagement-data:
    name: Collect Salesforce User Engagement Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check.outputs.has_data }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node + Salesforce CLI
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI + jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          npm install -g @salesforce/cli

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url \
            --alias "${{ github.event.inputs.org_alias }}" \
            --sfdx-url-stdin

      - name: ðŸš€ Query User Engagement Data
        shell: bash
        run: |
          set -e
          mkdir -p "$DATA_DIR"
          echo "ðŸ“Š Collecting engagement metrics..."

          # ðŸ§‘â€ðŸ’» Active Users
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, Name, Username, Profile.Name, IsActive, LastLoginDate, CreatedDate FROM User WHERE IsActive = true LIMIT 2000" \
            > "$DATA_DIR/users.json"

          # ðŸ”‘ Login History (last 30 days)
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT UserId, LoginTime, LoginType, SourceIp, Platform FROM LoginHistory WHERE LoginTime = LAST_N_DAYS:30 LIMIT 5000" \
            > "$DATA_DIR/login_history.json"

          # ðŸ“ˆ Object Activity (e.g., Tasks, Opportunities, Cases)
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT OwnerId, COUNT(Id) count FROM Task WHERE CreatedDate = LAST_N_DAYS:30 GROUP BY OwnerId" \
            > "$DATA_DIR/task_activity.json"

          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT OwnerId, COUNT(Id) count FROM Opportunity WHERE CreatedDate = LAST_N_DAYS:30 GROUP BY OwnerId" \
            > "$DATA_DIR/opportunity_activity.json"

          echo "âœ… Data collection completed."

      - name: Validate Data Availability
        id: check
        run: |
          user_count=$(jq -r '.result.records | length' "$DATA_DIR/users.json")
          echo "Users: $user_count"
          if [ "$user_count" -gt 0 ]; then
            echo "âœ… Engagement data available"
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No engagement data found"
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: engagement-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-ai:
    name: Analyze Engagement (AI)
    runs-on: ubuntu-latest
    needs: collect-engagement-data
    if: needs.collect-engagement-data.outputs.has_data == 'true'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: engagement-data
          path: ${{ env.DATA_DIR }}

      - name: Setup Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          for i in {1..20}; do
            if curl -s http://localhost:11434/api/version >/dev/null; then break; fi
            sleep 3
          done
          ollama pull "${{ github.event.inputs.model_name }}"

      - name: ðŸ“Š Pre-Analysis - Generate Structured Metrics
        shell: bash
        run: |
          echo "ðŸ” Aggregating user activity..."

          jq -n \
            --slurpfile users "$DATA_DIR/users.json" \
            --slurpfile logins "$DATA_DIR/login_history.json" \
            --slurpfile tasks "$DATA_DIR/task_activity.json" \
            --slurpfile opps "$DATA_DIR/opportunity_activity.json" '
            def safe(x): if (x|type)=="array" then x else [] end;
            def recs(x): if x[0].result? and x[0].result.records? then x[0].result.records else [] end;

            ($users | recs(.)) as $u |
            ($logins | recs(.)) as $l |
            ($tasks | recs(.)) as $t |
            ($opps | recs(.)) as $o |

            # Build engagement profile per user
            $u | map({
              userId: .Id,
              name: .Name,
              profile: .Profile.Name,
              isActive: .IsActive,
              lastLogin: .LastLoginDate,
              loginCount30d: ($l | map(select(.UserId == .Id)) | length),
              tasksCreated30d: ($t | map(select(.OwnerId == .Id)) | map(.count|tonumber) | add // 0),
              opportunitiesCreated30d: ($o | map(select(.OwnerId == .Id)) | map(.count|tonumber) | add // 0)
            })' > "$DATA_DIR/user_engagement.json"

          echo "âœ… Computed per-user engagement statistics."

      - name: ðŸ§  AI Analysis
        shell: bash
        run: |
          REPORT="user_engagement_report_$(date +%Y%m%d_%H%M%S).md"
          MODEL="${{ github.event.inputs.model_name }}"

          SYSTEM_PROMPT="You are a Salesforce adoption consultant. Provide engagement insights as Markdown tables and bullet recommendations."

          USER_PROMPT=$(cat << 'EOP'
          Generate a Salesforce User Engagement Report including:

          ## ðŸ“Š Summary Metrics
          | Metric | Value |
          |---------|-------|
          | Active Users | X |
          | Inactive Users (no login 30d) | X |
          | Avg Logins per User | X |
          | Avg Tasks per User | X |
          | Avg Opportunities per User | X |

          ## ðŸ§‘â€ðŸ’» Top Engaged Users
          | Name | Logins | Tasks | Opportunities | Profile | Status |
          |------|--------|--------|---------------|----------|---------|

          ## âš ï¸ Inactive / Low Engagement Users
          | Name | Last Login | Logins | Tasks | Opportunities | Profile |
          |------|-------------|--------|--------|---------------|----------|

          ## ðŸ’¡ Recommendations
          - Identify low engagement profiles and schedule enablement.
          - Suggest automation or UI improvements.
          - Highlight active user patterns to replicate.

          Provide data-driven commentary only (no generic advice).
          EOP
          )

          cat > prompt.json << EOF
          {
            "model": "$MODEL",
            "system": "$SYSTEM_PROMPT",
            "prompt": "$USER_PROMPT\n\n### USER DATA:\n$(jq -c . "$DATA_DIR/user_engagement.json")",
            "options": {"temperature": 0.2, "top_p": 0.9, "num_predict": 2000},
            "stream": false
          }
          EOF

          ollama_response=$(curl -s http://localhost:11434/api/generate \
            -H "Content-Type: application/json" \
            -d @prompt.json | jq -r '.response // empty')

          echo "# ðŸ§  Salesforce User Engagement Report" > "$REPORT"
          echo "**Model:** $MODEL  " >> "$REPORT"
          echo "**Generated:** $(date -u)" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "$ollama_response" >> "$REPORT"

          cat "$REPORT"

      - uses: actions/upload-artifact@v4
        with:
          name: ai-engagement-report
          path: user_engagement_report_*.md
          retention-days: 14
