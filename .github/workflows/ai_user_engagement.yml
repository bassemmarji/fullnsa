name: AI-Powered User Engagement Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "Full-NSA"
      days_back:
        description: "Days back to analyze"
        required: true
        default: "30"
      model_name:
        description: "Ollama model to use"
        required: true
        default: "llama3:8b"

env:
  DATA_DIR: ./data

jobs:
  collect-engagement-data:
    name: Collect Salesforce Engagement Data
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ Setup
        run: |
          mkdir -p $DATA_DIR

      - name: ðŸ§© Authenticate to Salesforce
        run: |
          echo "Authenticating..."
          sfdx force:auth:web:login -a ${{ github.event.inputs.org_alias }}

      - name: ðŸ§± Discover Custom Objects
        shell: bash
        run: |
          echo "ðŸ” Fetching deployed custom objects..."
          sfdx force:data:soql:query \
            -q "SELECT QualifiedApiName FROM EntityDefinition WHERE IsCustomObject = true AND DeploymentStatus = 'Deployed' AND NamespacePrefix = null" \
            -u ${{ github.event.inputs.org_alias }} --json > "$DATA_DIR/custom_objects.json"

          echo "ðŸ“¦ Discovered custom objects:"
          jq -r '.result.records[].QualifiedApiName' "$DATA_DIR/custom_objects.json"

      - name: ðŸŽ¯ Collect Standard Object Activity
        shell: bash
        run: |
          declare -a std_objects=("Account" "Contact" "Opportunity" "Case" "Task" "Event" "Lead")
          for obj in "${std_objects[@]}"; do
            echo "ðŸ“¥ Collecting activity for $obj..."
            sfdx force:data:soql:query \
              -q "SELECT Id, OwnerId, CreatedDate FROM $obj WHERE CreatedDate = LAST_N_DAYS:${{ github.event.inputs.days_back }}" \
              -u ${{ github.event.inputs.org_alias }} --json > "$DATA_DIR/${obj}_created.json" || true

            sfdx force:data:soql:query \
              -q "SELECT Id, OwnerId, LastModifiedDate FROM $obj WHERE LastModifiedDate = LAST_N_DAYS:${{ github.event.inputs.days_back }}" \
              -u ${{ github.event.inputs.org_alias }} --json > "$DATA_DIR/${obj}_modified.json" || true
          done

      - name: ðŸŽ¯ Collect Custom Object Activity
        shell: bash
        run: |
          echo "ðŸ“¥ Collecting data for custom objects..."
          jq -r '.result.records[].QualifiedApiName' "$DATA_DIR/custom_objects.json" | while read obj; do
            echo "ðŸ§© Processing $obj..."
            # Verify OwnerId exists (prevents query errors)
            if sfdx force:data:soql:query -q "SELECT QualifiedApiName FROM FieldDefinition WHERE EntityDefinition.QualifiedApiName = '$obj' AND QualifiedApiName = 'OwnerId'" -u ${{ github.event.inputs.org_alias }} --json | jq -e '.result.records | length > 0' >/dev/null; then
              echo "âœ… $obj has OwnerId, querying data..."
              sfdx force:data:soql:query \
                -q "SELECT Id, OwnerId, CreatedDate FROM $obj WHERE CreatedDate = LAST_N_DAYS:${{ github.event.inputs.days_back }}" \
                -u ${{ github.event.inputs.org_alias }} --json > "$DATA_DIR/${obj}_created.json" || true

              sfdx force:data:soql:query \
                -q "SELECT Id, OwnerId, LastModifiedDate FROM $obj WHERE LastModifiedDate = LAST_N_DAYS:${{ github.event.inputs.days_back }}" \
                -u ${{ github.event.inputs.org_alias }} --json > "$DATA_DIR/${obj}_modified.json" || true
            else
              echo "âš ï¸ Skipping $obj (no OwnerId field)"
            fi
          done

      - name: ðŸ§‘â€ðŸ’» Collect User Data
        shell: bash
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, Name, Username, Email, Profile.Name, UserRole.Name, IsActive, LastLoginDate, CreatedDate FROM User WHERE IsActive = true" \
            -u ${{ github.event.inputs.org_alias }} --json > "$DATA_DIR/users.json"

      - name: ðŸ“¦ Upload Engagement Data
        uses: actions/upload-artifact@v4
        with:
          name: engagement-data
          path: ${{ env.DATA_DIR }}
          retention-days: 14

      - name: âœ… Set Output
        id: check
        run: |
          total_files=$(ls $DATA_DIR | wc -l)
          if [ $total_files -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

    outputs:
      has_data: ${{ steps.check.outputs.has_data }}

  analyze-ai:
    name: Analyze Engagement with AI
    runs-on: ubuntu-latest
    needs: collect-engagement-data
    if: needs.collect-engagement-data.outputs.has_data == 'true'

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: engagement-data
          path: ${{ env.DATA_DIR }}

      - name: Setup Ollama
        shell: bash
        run: |
          echo "âš™ï¸ Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > ollama.log 2>&1 &
          echo "â³ Waiting for Ollama to start..."
          for i in {1..60}; do
            if curl -s http://localhost:11434/api/version >/dev/null 2>&1; then
              echo "âœ… Ollama API is online."
              break
            fi
            sleep 3
          done
          echo "â¬‡ï¸ Pulling model: ${{ github.event.inputs.model_name }}"
          ollama pull "${{ github.event.inputs.model_name }}" || exit 1

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: ðŸ“Š Aggregate Engagement Data
        shell: bash
        run: |
          echo "ðŸ”„ Aggregating engagement across all objects..."
          jq -n '[inputs | select(.result.records != null) | .result.records[] | select(.OwnerId != null) | {object: input_filename, owner: .OwnerId}]' $DATA_DIR/*_created.json $DATA_DIR/*_modified.json > $DATA_DIR/all_activity.json
          echo "âœ… Aggregated activities: $(jq length $DATA_DIR/all_activity.json)"

          jq -n --slurpfile users "$DATA_DIR/users.json" --slurpfile activities "$DATA_DIR/all_activity.json" '
            ($users[0].result.records) as $u |
            $u | map({
              userId: .Id,
              name: .Name,
              email: .Email,
              profile: .Profile.Name,
              role: (.UserRole.Name // "No Role"),
              totalActivity: ($activities[0] | map(select(.owner == .Id)) | length)
            }) | sort_by(-.totalActivity)
          ' > "$DATA_DIR/user_engagement.json"

          echo "âœ… User engagement file created"
          jq -r '.[:10] | .[] | "\(.name): \(.totalActivity) activities"' "$DATA_DIR/user_engagement.json"

      - name: ðŸ§  AI Analysis (Robust)
        shell: bash
        run: |
          REPORT="user_engagement_report_$(date +%Y%m%d_%H%M%S).md"
          MODEL="${{ github.event.inputs.model_name }}"
          DAYS="${{ github.event.inputs.days_back }}"
          SYSTEM_PROMPT="You are a Salesforce adoption consultant analyzing user engagement data. Provide actionable insights based on the data provided."

          USER_PROMPT=$(cat << EOP
          Analyze Salesforce user engagement data across both standard and custom objects for the past $DAYS days.

          ## Report Structure:
          - ðŸ“Š Executive Summary
          - ðŸ“ˆ Engagement Metrics
          - ðŸ† Top Engaged Users
          - âš ï¸ Low Engagement Users
          - ðŸ’¡ Recommendations
          EOP
          )

          DATA=$(jq -c 'if length > 50 then .[:50] else . end' "$DATA_DIR/user_engagement.json")
          cat > prompt.json << EOF
          {
            "model": "$MODEL",
            "system": "$SYSTEM_PROMPT",
            "prompt": "$USER_PROMPT\\n\\n### DATA:\\n$DATA",
            "options": { "temperature": 0.3 },
            "stream": false
          }
          EOF

          RESPONSE_FILE="ollama_response.json"
          if ! curl -sS http://localhost:11434/api/generate \
            -H "Content-Type: application/json" \
            -d @prompt.json > "$RESPONSE_FILE"; then
            echo "âŒ Ollama call failed"
            exit 1
          fi

          if ! jq empty "$RESPONSE_FILE" >/dev/null 2>&1; then
            echo "âš ï¸ Invalid JSON from Ollama"
            ollama_response=$(cat "$RESPONSE_FILE")
          else
            ollama_response=$(jq -r '.response // .error // "No response"' "$RESPONSE_FILE")
          fi

          echo "# ðŸ§  Salesforce Engagement Report" > "$REPORT"
          echo "" >> "$REPORT"
          echo "**Org:** ${{ github.event.inputs.org_alias }}  " >> "$REPORT"
          echo "**Period:** Last $DAYS days  " >> "$REPORT"
          echo "**Model:** $MODEL  " >> "$REPORT"
          echo "" >> "$REPORT"
          echo "$ollama_response" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "âœ… Report generated at $(date)" >> "$REPORT"

      - uses: actions/upload-artifact@v4
        with:
          name: ai-engagement-report
          path: user_engagement_report_*.md
          retention-days: 14
