name: AI-Powered User Engagement Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "Full-NSA"
      model_name:
        description: "Ollama model to use"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  collect-engagement-data:
    name: Collect Salesforce User Engagement Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check.outputs.has_data }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node + Salesforce CLI
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI + jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          npm install -g @salesforce/cli

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url \
            --alias "${{ github.event.inputs.org_alias }}" \
            --sfdx-url-stdin

      - name: üöÄ Collect Engagement Data
        shell: bash
        run: |
          set -e
          mkdir -p "$DATA_DIR"
          echo "üìä Collecting user + object engagement data..."

          # üßë‚Äçüíª Active Non-Admin Users
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, Name, Username, Profile.Name, IsActive, LastLoginDate FROM User WHERE IsActive = true AND Profile.Name NOT LIKE '%Admin%'" \
            > "$DATA_DIR/users.json"

          # üîë Login Activity (last 30 days)
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT UserId, LoginTime, LoginType FROM LoginHistory WHERE LoginTime = LAST_N_DAYS:30 LIMIT 10000" \
            > "$DATA_DIR/login_history.json"

          # üìã Task Activity (last 30 days)
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT OwnerId, COUNT(Id) total FROM Task WHERE CreatedDate = LAST_N_DAYS:30 GROUP BY OwnerId" \
            > "$DATA_DIR/task_activity.json"

          # üß© Discover User-Owned Objects (standard + custom)
          echo "üîç Detecting customizable objects..."
          sf data query --use-tooling-api --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT QualifiedApiName FROM EntityDefinition WHERE IsCustomSetting = false AND IsCustomizable = true AND NamespacePrefix = null AND DeploymentStatus = 'Deployed'" \
            > "$DATA_DIR/entity_defs.json"

          jq -r '.result.records[].QualifiedApiName' "$DATA_DIR/entity_defs.json" > "$DATA_DIR/object_list.txt"
          echo "‚úÖ Found $(wc -l < "$DATA_DIR/object_list.txt") objects."

          # üî¢ Query Activity for Each Object
          > "$DATA_DIR/object_activity.json"
          while IFS= read -r obj; do
            echo "üì¶ Querying: $obj"
            sf data query --target-org "${{ github.event.inputs.org_alias }}" \
              --result-format json \
              --query "SELECT CreatedById, COUNT(Id) total FROM $obj WHERE CreatedDate = LAST_N_DAYS:30 GROUP BY CreatedById" \
              >> "$DATA_DIR/object_activity.json" 2>/dev/null || true
          done < "$DATA_DIR/object_list.txt"

          echo "‚úÖ Data collection complete."

      - name: Validate Data Availability
        id: check
        run: |
          user_count=$(jq -r '.result.records | length' "$DATA_DIR/users.json")
          echo "Users: $user_count"
          if [ "$user_count" -gt 0 ]; then
            echo "‚úÖ Engagement data available"
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No engagement data found"
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: engagement-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-ai:
    name: Analyze Engagement (AI)
    runs-on: ubuntu-latest
    needs: collect-engagement-data
    if: needs.collect-engagement-data.outputs.has_data == 'true'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: engagement-data
          path: ${{ env.DATA_DIR }}

      - name: Setup Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          for i in {1..20}; do
            if curl -s http://localhost:11434/api/version >/dev/null; then break; fi
            sleep 3
          done
          ollama pull "${{ github.event.inputs.model_name }}"

      - name: üìä Pre-Analysis - Compute Engagement Scores
        shell: bash
        run: |
          echo "üîç Aggregating engagement metrics..."
          jq -n \
            --slurpfile users "$DATA_DIR/users.json" \
            --slurpfile logins "$DATA_DIR/login_history.json" \
            --slurpfile tasks "$DATA_DIR/task_activity.json" \
            --slurpfile objects "$DATA_DIR/object_activity.json" '
            def recs(x): if x[0].result? and x[0].result.records? then x[0].result.records else [] end;
            ($users | recs(.)) as $u |
            ($logins | recs(.)) as $l |

