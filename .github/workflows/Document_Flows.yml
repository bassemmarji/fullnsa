name: Document Flows

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday at midnight

env:
  ORG_ALIAS: org_alias
  REPORT_RECIPIENT: "bassemmarji@gmail.com"

jobs:
  document_org_flows:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Install Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 'Install sfdx CLI'
        run: npm install sfdx-cli --global

      - name: 'Install flowdoc Plugin'
        run: echo "Y" | sfdx plugins:install sfdx-flowdoc-plugin

      - name: 'Install jq'
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 'Authorize to the Org'
        run: echo "${{ secrets.ORG_SFDX_URL }}" | sfdx auth:sfdxurl:store --alias $ORG_ALIAS --setdefault --noprompt

      - name: 'Validate Authorized Org'
        run: sfdx force:org:list

      - name: 'Create project with manifest'
        run: |
          mkdir -p org-metadata
          cd org-metadata
          cat > sfdx-project.json <<EOF
{
  "packageDirectories": [
    {
      "path": "force-app",
      "default": true
    }
  ],
  "namespace": "",
  "sourceApiVersion": "60.0"
}
EOF

          mkdir -p config
          cat > config/package.xml <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
  <types>
    <members>*</members>
    <name>Flow</name>
  </types>
  <version>60.0</version>
</Package>
EOF

      - name: 'Retrieve Metadata (including flows)'
        run: |
          cd org-metadata
          sfdx force:source:retrieve -x config/package.xml -u $ORG_ALIAS

      - name: 'List Retrieved Flows'
        run: |
          echo "üìÑ Listing retrieved flows:"
          find org-metadata/force-app/main/default/flows -name "*.flow-meta.xml"

      - name: 'Generate Flow Documents'
        run: |
          mkdir -p $GITHUB_WORKSPACE/flowDocuments
          cd org-metadata

          # Generate diagram for one specific flow
          FLOW_PATH="force-app/main/default/flows/NSA_Deactivate_Plan.flow-meta.xml"

          if [ -f "$FLOW_PATH" ]; then
            echo "‚úÖ Generating diagram for flow at: $FLOW_PATH"
            sfdx flow:diagram --sourcefile "$FLOW_PATH" --outputdir "$GITHUB_WORKSPACE/flowDocuments"
          else
            echo "‚ùå Flow file NOT found at: $FLOW_PATH"
            exit 1
          fi

      - name: 'List Generated Files'
        run: |
          echo "üìÑ Listing generated flow documents:"
          ls -la $GITHUB_WORKSPACE/flowDocuments

      # Optional: Upload results as artifact
      - name: 'Upload Flow Documents'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flow-documents
          path: $GITHUB_WORKSPACE/flowDocuments/
