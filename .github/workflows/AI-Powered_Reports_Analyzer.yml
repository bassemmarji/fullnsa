name: AI-Powered Reports Analyzer (Enhanced Full)

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        description: "Ollama model"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  collect-and-analyze-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create data directory
        run: mkdir -p $DATA_DIR

      ##############################################
      # Queries
      ##############################################

      - name: Query Reports
        run: |
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, Name, DeveloperName, Format, CreatedDate, LastRunDate, OwnerId, NamespacePrefix FROM Report" \
            > "$DATA_DIR/reports_raw.json"

      - name: Query Folders
        run: |
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, Name FROM Folder WHERE Type = 'Report'" \
            > "$DATA_DIR/report_folders.json"

      - name: Query Users
        run: |
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, Name FROM User" \
            > "$DATA_DIR/users.json"

      - name: Query Report Events (Last 365 Days)
        run: |
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, CreatedDate, ReportId, UserId FROM ReportEvent WHERE CreatedDate = LAST_N_DAYS:365 LIMIT 50000" \
            > "$DATA_DIR/report_events.json"

      ##############################################
      # Enrich Reports + Usage Stats
      ##############################################

      - name: Enrich Reports + Compute Usage Stats
        run: |
          jq -s '
            # Input files
            (. [0] | if has("result") then .result.records else .records // [] end) as $reports |
            (. [1] | if has("result") then .result.records else .records // [] end) as $folders |
            (. [2] | if has("result") then .result.records else .records // [] end) as $users |
            (. [3] | if has("result") then .result.records else .records // [] end) as $events |

            # Lookup maps
            ($folders | map(select(.Id != null) | {(.Id): .Name}) | add // {}) as $foldersMap |
            ($users   | map(select(.Id != null) | {(.Id): .Name}) | add // {}) as $usersMap |

            #####################################################
            # Enriched Reports
            #####################################################
            def enrichReport:
              map({
                Id: .Id,
                Name: .Name,
                DeveloperName: .DeveloperName,
                Format: .Format,
                OwnerId: .OwnerId,
                OwnerName:
                  (if (.OwnerId // null) != null and ($usersMap[.OwnerId] // null) != null
                   then $usersMap[.OwnerId]
                   else "Unknown Owner"
                   end),
                Package: (.NamespacePrefix // "Unmanaged"),
                LastRunDays:
                  (if .LastRunDate == null then null
                   else ((now - ((.LastRunDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                   end),
                CreatedDays:
                  (if .CreatedDate == null then null
                   else ((now - ((.CreatedDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                   end)
              });

            #####################################################
            # Usage Stats from ReportEvent
            #####################################################
            def usageStats:
              def cutoff(days): (now - (days * 86400));

              def filterEvents(days):
                map(select((.CreatedDate | fromdateiso8601) >= cutoff(days)));

              def countByReport:
                group_by(.ReportId)
                | map({ reportId: .[0].ReportId, count: length })
                | sort_by(.count)
                | reverse;

              {
                lastWeek:  ($events | filterEvents(7)   | countByReport),
                lastMonth: ($events | filterEvents(30)  | countByReport),
                lastYear:  ($events | filterEvents(365) | countByReport)
              };

            {
              reports: ($reports | enrichReport),
              usage: usageStats
            }
          ' \
          "$DATA_DIR/reports_raw.json" \
          "$DATA_DIR/report_folders.json" \
          "$DATA_DIR/users.json" \
          "$DATA_DIR/report_events.json" \
          > "$DATA_DIR/reports_enriched.json"

      ##############################################
      # Upload Artifacts
      ##############################################

      - name: Upload Enriched Reports
        uses: actions/upload-artifact@v4
        with:
          name: reports_enriched
          path: $DATA_DIR/reports_enriched.json

      ##############################################
      # AI Analysis (optional)
      ##############################################

      - name: Run AI Analysis
        run: |
          SUMMARY=$(jq -r '
            def reportUsage(title; arr):
              "\(title):\n" +
              (arr | map("  - \(.reportId): \(.count) runs") | join("\n")) + "\n";

            "## Report Usage Summary\n"
            + reportUsage("Last Week"; .usage.lastWeek)
            + reportUsage("Last Month"; .usage.lastMonth)
            + reportUsage("Last Year"; .usage.lastYear)
          ' $DATA_DIR/reports_enriched.json)

          echo "$SUMMARY" > $DATA_DIR/report_analysis.md

      - name: Upload AI Analysis
        uses: actions/upload-artifact@v4
        with:
          name: report_analysis
          path: $DATA_DIR/report_analysis.md
