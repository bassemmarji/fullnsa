name: AI-Powered Reports Analyzer (Enhanced)

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        description: "Ollama model"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  collect-and-analyze-reports:
    name: Collect + Analyze Reports (Hardis + Metadata)
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check.outputs.has_data }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install SF CLI & tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          npm install -g @salesforce/cli

      - name: Install sfdx-hardis plugin
        run: sf plugins install sfdx-hardis

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url \
            --alias "${{ github.event.inputs.org_alias }}" \
            --sfdx-url-stdin

      - name: Create data directory
        run: mkdir -p "$DATA_DIR"

      # -----------------------------------------------------------
      # METADATA COLLECTION (without ReportEvent)
      # -----------------------------------------------------------

      - name: Query Reports Metadata
        run: |
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, DeveloperName, Name, NamespacePrefix, Description, Format, FolderName, LastRunDate, LastViewedDate, LastReferencedDate FROM Report LIMIT 5000" \
            > "$DATA_DIR/reports.json"

      - name: Query Dashboard Usage (DashboardComponent)
        run: |
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, DashboardId, CustomReportId FROM DashboardComponent LIMIT 5000" \
            > "$DATA_DIR/dashboard_components.json"

      # -----------------------------------------------------------
      # HARDIS ANALYSIS
      # -----------------------------------------------------------

      - name: Run sfdx-hardis Report Analysis
        run: |
          sfdx-hardis org:report:analyze \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --outputfile "$DATA_DIR/hardis_report.json" \
            --json

      # -----------------------------------------------------------
      # CHECK FOR DATA
      # -----------------------------------------------------------

      - name: Check if reports exist
        id: check
        run: |
          count=$(jq '.result.records | length // 0' "$DATA_DIR/reports.json")
          if [ "$count" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: raw-and-hardis-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-with-ai:
    name: AI-Powered Insight Generation
    runs-on: ubuntu-latest
    needs: collect-and-analyze-reports
    if: needs.collect-and-analyze-reports.outputs.has_data == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: raw-and-hardis-data
          path: ${{ env.DATA_DIR }}

      # -----------------------------------------------------------
      # OLLAMA SETUP
      # -----------------------------------------------------------

      - name: Setup Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          for i in {1..20}; do
            if curl -s http://localhost:11434/api/version >/dev/null; then break; fi
            sleep 2
          done
          ollama pull "${{ github.event.inputs.model_name }}"

      # -----------------------------------------------------------
      # DATA PREPROCESSING (Recency + Dashboard Usage)
      # -----------------------------------------------------------

      - name: Preprocess Data
        run: |
          rec_reports() { jq '.result.records // .records // []' "$DATA_DIR/reports.json"; }
          rec_dash() { jq '.result.records // .records // []' "$DATA_DIR/dashboard_components.json"; }

          # 1. DASHBOARD USAGE MAP
          rec_dash | jq '
            group_by(.CustomReportId) |
            map({reportId: .[0].CustomReportId, dashboardCount: length})
          ' > "$DATA_DIR/dashboard_usage.json"

          # 2. ENRICH REPORTS WITH DASHBOARD USAGE + RECENCY SCORE
          # Recency Score: 3 = active, 2 = viewed, 1 = referenced, 0 = stale
          jq -s '
            (.[0].result.records // .[0].records // []) as $reports |
            (.[1] // []) as $dash |

            $reports | map(
              . as $r |

              # dashboard usage
              ($dash | map(select(.reportId == $r.Id)) | .[0].dashboardCount // 0) as $dashCount |

              # recency score
              (if $r.LastRunDate != null then 3
               elif $r.LastViewedDate != null then 2
               elif $r.LastReferencedDate != null then 1
               else 0 end) as $recency |

              $r + {
                dashboardUsage: $dashCount,
                recencyScore: $recency
              }
            )
          ' "$DATA_DIR/reports.json" "$DATA_DIR/dashboard_usage.json" \
            > "$DATA_DIR/reports_enriched.json"

          # INVALID REPORTS
          jq '
            map(select(
              (.Description == null or .Description == "") and
              (.LastViewedDate == null and .LastReferencedDate == null)
            ))
          ' "$DATA_DIR/reports_enriched.json" > "$DATA_DIR/invalid_reports.json"

          # TOP 20 STALE REPORTS
          jq 'sort_by(.recencyScore) | .[0:20]' "$DATA_DIR/reports_enriched.json" > "$DATA_DIR/stale_reports.json"

          # TOP 20 ACTIVE REPORTS
          jq 'sort_by(.recencyScore) | reverse | .[0:20]' "$DATA_DIR/reports_enriched.json" > "$DATA_DIR/top_reports.json"

          # FORMAT CATEGORIES
          jq '
            group_by(.Format) |
            map({format: .[0].Format, count: length})
          ' "$DATA_DIR/reports_enriched.json" > "$DATA_DIR/reports_by_category.json"

          # HARDIS FINDINGS
          jq '.result.findings // .findings // []' "$DATA_DIR/hardis_report.json" > "$DATA_DIR/hardis_findings.json"

      # -----------------------------------------------------------
      # AI ANALYSIS
      # -----------------------------------------------------------

      - name: AI Analysis
        run: |
          MODEL="${{ github.event.inputs.model_name }}"
          REPORT="salesforce_reports_analysis_$(date +%Y%m%d_%H%M%S).md"

          CONTEXT=$(jq -nc '{
            enriched: $enriched[0],
            stale: $stale[0],
            top: $top[0],
            categories: $categories[0],
            invalid: $invalid[0],
            hardis: $hardis[0]
          }' \
            --slurpfile enriched "$DATA_DIR/reports_enriched.json" \
            --slurpfile stale "$DATA_DIR/stale_reports.json" \
            --slurpfile top "$DATA_DIR/top_reports.json" \
            --slurpfile categories "$DATA_DIR/reports_by_category.json" \
            --slurpfile invalid "$DATA_DIR/invalid_reports.json" \
            --slurpfile hardis "$DATA_DIR/hardis_findings.json")

          PROMPT=$(cat << 'EOF'
          You are a Senior Salesforce Governance Analyst.
          
          Analyze the following dataset based on:
          - enriched report metadata (recencyScore, dashboardUsage, description quality)
          - stale vs active reports
          - invalid reports
          - reports by format
          - sfdx-hardis findings (security risks, technical debt)
          
          Produce a high-quality **Markdown report** with:
          1. Executive Summary
          2. Invalid or High-Risk Reports
          3. Stale Reports (Top 20)
          4. Most Active Reports (Top 20)
          5. Reports by Format
          6. sfdx-hardis Findings Summary
          7. Actionable Recommendations
          EOF
          )

          RESPONSE=$(curl -s http://localhost:11434/api/generate \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg model "$MODEL" --arg prompt "$PROMPT\n\nCONTEXT:\n$CONTEXT" '{model: $model, prompt: $prompt, stream: false}')" \
            | jq -r '.response')

          {
            echo "# Salesforce Reports Governance Report"
            echo "**Generated:** $(date -u)"
            echo ""
            echo "$RESPONSE"
          } > "$REPORT"

      - uses: actions/upload-artifact@v4
        with:
          name: salesforce-reports-analysis
          path: salesforce_reports_analysis_*.md
          retention-days: 14
