name: AI-Powered Reports Analyzer (Enhanced)

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        description: "Ollama model"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  collect-metadata:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create data directory
        run: mkdir -p ${{ env.DATA_DIR }}

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Install Dependencies
        run: |
          echo "Installing jq and XML tools..."
          sudo apt-get update -qq
          sudo apt-get install -y jq libxml2-utils

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "${{ github.event.inputs.org_alias }}"

      - name: Fetch Reports Metadata
        run: |
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, Name, DeveloperName, FolderName, Format, CreatedDate, LastRunDate, OwnerId, NamespacePrefix FROM Report WHERE DeveloperName != null" \
            --result-format json > ${{ env.DATA_DIR }}/reports_raw.json

          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, Name FROM User" \
            --result-format json > ${{ env.DATA_DIR }}/users.json

          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, Name FROM Folder WHERE Type = 'Report'" \
            --result-format json > ${{ env.DATA_DIR }}/report_folders.json

          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, CreatedDate, ReportId, UserId FROM ReportEvent LIMIT 50000" \
            --result-format json > ${{ env.DATA_DIR }}/report_events.json

      - name: Retrieve Reports with Folder Paths
        shell: bash
        run: |
          set -euo pipefail
          ROOT_DIR="$PWD"
          mkdir -p manifest force-app
      
          # Reports list (from already-fetched reports_raw.json)
          jq '.result.records
              | map(select(.DeveloperName != null))
              | map({
                  reportDev: .DeveloperName,
                  folderName: (.FolderName // "Unfiled Public Reports")
                })' \
            ${{ env.DATA_DIR }}/reports_raw.json > temp_reports.json
      
          # Folder Name → DeveloperName map
          # IMPORTANT: filter out null DeveloperName to avoid jq crash
          jq '.result.records
              | map(select(.DeveloperName != null and .Name != null))
              | map({ key: .Name, value: .DeveloperName })
              | from_entries' \
            ${{ env.DATA_DIR }}/report_folders.json > temp_folder_map.json
      
          # Generate report metadata paths
          jq -r --slurpfile folderMap temp_folder_map.json '
            .[] |
            (
              if .folderName == "Unfiled Public Reports"
                 or .folderName == "Public Reports"
              then "unfiled$public"
              elif ($folderMap[0][.folderName] // null) != null
              then $folderMap[0][.folderName]
              else "unfiled$public"
              end
            ) as $folderDev |
            "\($folderDev)/\(.reportDev)"
          ' temp_reports.json > report_paths.txt
      
          rm temp_reports.json temp_folder_map.json
      
          PATH_COUNT=$(wc -l < report_paths.txt | tr -d '[:space:]')
          echo "Generated $PATH_COUNT report paths"
      
          if [ "$PATH_COUNT" -eq 0 ]; then
            echo "No report paths generated – skipping retrieve"
            exit 0
          fi
      
          # Build package.xml
          {
            echo '<?xml version="1.0" encoding="UTF-8"?>'
            echo '<Package xmlns="http://soap.sforce.com/2006/04/metadata">'
            echo '  <types>'
            while IFS= read -r path; do
              [ -n "$path" ] && echo "    <members>$path</members>"
            done < report_paths.txt
            echo '    <name>Report</name>'
            echo '  </types>'
            echo '  <version>59.0</version>'
            echo '</Package>'
          } > manifest/package.xml
      
          if [ ! -f sfdx-project.json ]; then
            printf '%s\n' '{ "packageDirectories": [{"path": "force-app","default": true }], "sourceApiVersion": "59.0"}' > sfdx-project.json
          fi
      
          sf project retrieve start \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --manifest manifest/package.xml || echo "Some reports failed to retrieve"
      
          mkdir -p "$ROOT_DIR/${{ env.DATA_DIR }}/report_metadata"
          find force-app -type f \( -name "*.report-meta.xml" -o -name "*.reportFolder-meta.xml" \) \
            -exec cp --parents {} "$ROOT_DIR/${{ env.DATA_DIR }}/report_metadata/" \; 2>/dev/null || true
      
          TOTAL=$(find "$ROOT_DIR/${{ env.DATA_DIR }}/report_metadata" -type f | wc -l | tr -d '[:space:]')
          echo "Retrieved $TOTAL report metadata files"

      - name: Parse Salesforce Report XML (JSON)
        shell: bash
        run: |
          set -euo pipefail
          REPORT_ROOT="${{ env.DATA_DIR }}/report_metadata/force-app/main/default/reports"
          OUT="${{ env.DATA_DIR }}/report_json_analysis"
          mkdir -p "$OUT"
      
          echo "[]" > "$OUT/report_fields.json"
      
          find "$REPORT_ROOT" -name "*.report-meta.xml" | while read -r file; do
            report_path="${file#*/reports/}"
            report_name="$(basename "$file" .report-meta.xml)"
      
            api_version="$(xmllint --xpath 'string(//apiVersion)' "$file" 2>/dev/null || true)"
            report_type="$(xmllint --xpath 'string(//reportType)' "$file" 2>/dev/null || true)"
      
            api_version="${api_version:-Unknown}"
            report_type="${report_type:-Unknown}"
      
            FIELDS=$(xmllint --xpath '
              //columns/field/text() |
              //filter/field/text() |
              //summaryFormula/field/text() |
              //rowLevelFormula/field/text() |
              //bucketField/sourceColumnName/text()
            ' "$file" 2>/dev/null || true)
      
            FIELD_JSON="[]"
            if [[ -n "$FIELDS" ]]; then
              FIELD_JSON=$(echo "$FIELDS" | tr ' ' '\n' | sed '/^$/d' | sort -u |
                jq -R -s -c 'split("\n") | map({
                  field: .,
                  type:
                    (if test("__c$") then "custom"
                     elif test("^(Id|CreatedById|LastModifiedById)$") then "system"
                     elif test("^[A-Z][A-Za-z0-9_.]+$") then "standard"
                     else "legacy_or_unknown" end)
                })')
            fi
      
            jq --arg path "$report_path" \
               --arg name "$report_name" \
               --arg api "$api_version" \
               --arg rt "$report_type" \
               --argjson fields "$FIELD_JSON" \
               '. += [{
                 report_path: $path,
                 report_name: $name,
                 api_version: $api,
                 report_type: $rt,
                 fields: $fields
               }]' "$OUT/report_fields.json" > "$OUT/tmp.json" && mv "$OUT/tmp.json" "$OUT/report_fields.json"
          done
      
          jq 'group_by(.api_version) | map({api_version: .[0].api_version, count: length})' \
            "$OUT/report_fields.json" > "$OUT/reports_by_api_version.json"
      
          jq 'group_by(.report_type) | map({base_object: .[0].report_type, count: length})' \
            "$OUT/report_fields.json" > "$OUT/reports_by_base_object.json"
      
          jq '[.[] | .fields[]?] |
              group_by(.field, .type) |
              map({field: .[0].field, type: .[0].type, count: length})' \
            "$OUT/report_fields.json" > "$OUT/field_usage_summary.json"
      
          echo "JSON parsing complete:"
          ls -l "$OUT"
      

      - name: Upload Metadata Artifact (JSON)
        uses: actions/upload-artifact@v4
        with:
          name: raw_metadata_json
          path: |
            ${{ env.DATA_DIR }}/reports_raw.json
            ${{ env.DATA_DIR }}/report_events.json
            ${{ env.DATA_DIR }}/users.json
            ${{ env.DATA_DIR }}/report_folders.json
            ${{ env.DATA_DIR }}/report_json_analysis/report_fields.json
            ${{ env.DATA_DIR }}/report_json_analysis/reports_by_api_version.json
            ${{ env.DATA_DIR }}/report_json_analysis/reports_by_base_object.json
            ${{ env.DATA_DIR }}/report_json_analysis/field_usage_summary.json

  ai-analysis:
    runs-on: ubuntu-latest
    needs: collect-metadata
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create data directory
        run: mkdir -p ${{ env.DATA_DIR }}

      - name: Download Metadata Artifact
        uses: actions/download-artifact@v4
        with:
          name: raw_metadata_json
          path: ${{ env.DATA_DIR }}

      - name: List files in data
        run: ls -l ${{ env.DATA_DIR }}

      - name: Install Ollama CLI
        run: |
          curl -fsSL https://ollama.com/install.sh | sudo bash
          ollama --version
          
      - name: Start Ollama Service
        run: |
          ollama serve &
          sleep 5

      - name: Enrich Reports
        run: |
          jq -s '
            (.[2].result.records | map({(.Id): .Name}) | add) as $users |
            (.[0].result.records) |
            map({
              Id,
              Name,
              FolderName: (.FolderName // "Unspecified"),
              DeveloperName,
              Format,
              OwnerName: ($users[.OwnerId] // "Unknown Owner"),
              Package: (.NamespacePrefix // "Unmanaged"),
              LastRunDays: null,
              CreatedDays:
                (
                  if .CreatedDate == null then null
                  else
                    ((now - (
                      .CreatedDate
                      | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")
                      | fromdateiso8601
                    )) / 86400 | floor)
                  end
                )
            })
          ' \
            data/reports_raw.json \
            data/report_folders.json \
            data/users.json \
          > data/reports_enriched.json

      - name: Generate Summary Stats
        run: |
          jq '{
            totalReports: length,
            neverRun: map(select(.LastRunDays == null)) | length,
            staleReports: map(
              select(
                (.LastRunDays == null) or (.LastRunDays > 180)
              )
            ) | length
          }' data/reports_enriched.json > data/summary_stats.json

      - name: Reports by Folder
        run: |
          jq '[.[] | .FolderName // "Unspecified"] | group_by(.) | map({folder: .[0], count: length})' \
            data/reports_enriched.json > data/reports_by_folder.json

      - name: Reports by Format
        run: |
          jq 'map(select(.Format != null)) | group_by(.Format) | map({ format: .[0].Format, count: length }) | sort_by(.count) | reverse' \
            data/reports_enriched.json > data/reports_by_format.json

      - name: Reports by Owner
        run: |
          jq 'group_by(.OwnerName) | map({ owner: .[0].OwnerName, count: length }) | sort_by(.count) | reverse' \
            data/reports_enriched.json > data/reports_by_owner.json

      - name: Reports by Package
        run: |
          jq 'group_by(.Package) | map({ package: .[0].Package, count: length }) | sort_by(.count) | reverse' \
            data/reports_enriched.json > data/reports_by_package.json

      # --- New analyses from Parse Salesforce Report XML JSON ---
      - name: Reports by API Version
        run: |
          jq '.' data/report_json_analysis/reports_by_api_version.json > data/reports_by_api_version.json

      - name: Reports by Base Object
        run: |
          jq '.' data/report_json_analysis/reports_by_base_object.json > data/reports_by_base_object.json

      - name: Field Usage Summary
        run: |
          jq '.' data/report_json_analysis/field_usage_summary.json > data/field_usage_summary.json

      - name: Detailed Report Fields JSON
        run: |
          cp data/report_json_analysis/report_fields.json data/report_fields.json

      - name: Generate Summary Table (Markdown)
        run: |
          jq -r '
            "Metric | Value\n--- | ---\n" +
            "Total Reports | " + (.totalReports | tostring) + "\n" +
            "Never Run | " + (.neverRun | tostring) + "\n" +
            "Stale (>180 days) | " + (.staleReports | tostring)
          ' data/summary_stats.json > data/summary_table.md

      - name: Generate Distribution Tables (Markdown)
        run: |
          # Folder
          {
            echo "Folder | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.folder) | \(.count)"' data/reports_by_folder.json
          } > data/folder_table.md

          # Format
          {
            echo "Format | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.format // "Unknown") | \(.count)"' data/reports_by_format.json
          } > data/format_table.md

          # Owner
          {
            echo "Owner | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.owner) | \(.count)"' data/reports_by_owner.json
          } > data/owner_table.md

          # Package
          {
            echo "Package | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.package) | \(.count)"' data/reports_by_package.json
          } > data/package_table.md

      - name: Build AI Executive Summary
        run: |
          MODEL="${{ github.event.inputs.model_name }}"
          CONTEXT=$(jq -s -r '
            .[0] as $stats |
            .[1] as $folders |
            .[2] as $formats |
            .[3] as $owners |
            .[4] as $packages |
            "# Salesforce Reports Analysis Data\n\n" +
            "## Overall Statistics\n" +
            "- Total reports: \($stats.totalReports)\n" +
            "- Never run: \($stats.neverRun) (\($stats.neverRun / ($stats.totalReports | if . == 0 then 1 else . end) * 100 | floor)%)\n" +
            "- Stale reports (>180d): \($stats.staleReports) (\($stats.staleReports / ($stats.totalReports | if . == 0 then 1 else . end) * 100 | floor)%)\n\n" +
            "## Top Folders by Report Count\n" +
            ($folders | sort_by(.count) | reverse | .[0:5] | map("- \(.folder): \(.count) reports") | join("\n")) +
            "\n\n## Report Formats\n" +
            ($formats | map("- \(.format // "Unknown"): \(.count) reports") | join("\n")) +
            "\n\n## Top Report Owners\n" +
            ($owners | .[0:5] | map("- \(.owner): \(.count) reports") | join("\n")) +
            "\n\n## Package (Namespace) Distribution\n" +
            ($packages | map("- \(.package): \(.count) reports") | join("\n")) +
            "\n\n## Analysis Request\n" +
            "Based on this data, provide:\n" +
            "1. Key insights about report usage, ownership concentration, and package health\n" +
            "2. Actionable recommendations (e.g., consolidate underactive owners, review managed packages)\n" +
            "3. Risks: too many unmanaged reports, stale reports in critical packages, etc.\n" +
            "4. Best practices for governance and cleanup\n\n" +
            "Keep the summary concise (3-5 paragraphs) and business-focused."
          ' \
            data/summary_stats.json \
            data/reports_by_folder.json \
            data/reports_by_format.json \
            data/reports_by_owner.json \
            data/reports_by_package.json)
          echo "$CONTEXT" | ollama run "$MODEL" > data/ai_summary.md

      - name: Build Final Markdown Report
        run: |
          {
            echo "# AI-Powered Reports Analysis"
            echo
            echo "## Executive Summary"
            cat "$DATA_DIR/ai_summary.md"
            echo
            echo "## Summary Statistics"
            echo "Metric | Value"
            echo "--- | ---"
            jq -r '[
              "Total Reports | " + (.totalReports | tostring),
              "Never Run | " + (.neverRun | tostring),
              "Stale (>180 days) | " + (.staleReports | tostring)
            ] | .[]' "$DATA_DIR/summary_stats.json"
            echo
            echo "## Reports by Folder"
            echo "Folder | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.folder) | \(.count)"' "$DATA_DIR/reports_by_folder.json"
            echo
            echo "## Reports by Format"
            echo "Format | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.format // "Unknown") | \(.count)"' "$DATA_DIR/reports_by_format.json"
            echo
            echo "## Reports by Owner"
            echo "Owner | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.owner) | \(.count)"' "$DATA_DIR/reports_by_owner.json"
            echo
            echo "## Reports by Package"
            echo "Package | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.package) | \(.count)"' "$DATA_DIR/reports_by_package.json"
            echo
            echo "## Reports by API Version"
            echo "API Version | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.api_version) | \(.count)"' "$DATA_DIR/reports_by_api_version.json"
            echo
            echo "## Reports by Base Object"
            echo "Base Object | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.base_object) | \(.count)"' "$DATA_DIR/reports_by_base_object.json"
            echo
            echo "## Field Usage Summary"
            echo "Field | Type | Count"
            echo "--- | --- | ---"
            jq -r '.[] | "\(.field) | \(.type) | \(.count)"' "$DATA_DIR/field_usage_summary.json"
            echo
            echo "*(Full data available in artifacts)*"
          } > final_report.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final_report
          path: final_report.md

      - name: Upload JSON and Markdown Data Files
        uses: actions/upload-artifact@v4
        with:
          name: report_data
          path: |
            data/reports_enriched.json
            data/summary_stats.json
            data/reports_by_folder.json
            data/reports_by_format.json
            data/reports_by_owner.json
            data/reports_by_package.json
            data/reports_by_api_version.json
            data/reports_by_base_object.json
            data/field_usage_summary.json
            data/report_fields.json
            data/ai_summary.md
            data/folder_table.md
            data/format_table.md
            data/owner_table.md
            data/package_table.md
