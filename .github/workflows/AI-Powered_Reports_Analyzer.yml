# AI-Powered Reports Analyzer (Enhanced Full)
name: AI-Powered Reports Analyzer (Enhanced Full)

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        description: "Ollama model"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  analyze-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create data directory
        run: mkdir -p "$DATA_DIR"

      ###########################################################################
      # INSTALL CLI TOOLS
      ###########################################################################
      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Install Hardis CLI
        run: |
          npm install -g hardis
          hardis --version
          
      - name: Install Ollama CLI
        run: |
          # GitHub Actions runner is non-root → install to /usr/local/bin with sudo
          curl -fsSL https://ollama.com/install.sh | sudo bash
          ollama --version

      ###########################################################################
      # AUTHENTICATE TO SALESFORCE
      ###########################################################################
      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "${{ github.event.inputs.org_alias }}"
          sf org display --target-org "${{ github.event.inputs.org_alias }}"

      ###########################################################################
      # FETCH REPORT METADATA AND EVENTS
      ###########################################################################
      - name: Fetch Reports
        run: |
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, Name, FolderName, DeveloperName, Format, CreatedDate, LastRunDate, OwnerId FROM Report" \
            > "$DATA_DIR/reports_raw.json"

          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, CreatedDate, ReportId, UserId FROM ReportEvent LIMIT 50000" \
            > "$DATA_DIR/report_events.json"

      ###########################################################################
      # RUN HARDIS ANALYZER
      ###########################################################################
      - name: Run Hardis Analyzer
        id: hardis
        continue-on-error: true
        run: |
          npx hardis org:report:analyze \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --format json \
            --outputfile "$DATA_DIR/hardis_report.json"
      
      - name: Validate Hardis Output
        run: |
          if [ "${{ steps.hardis.outcome }}" != "success" ]; then
            echo "::warning::Hardis analysis failed or was skipped"
            echo '{"status":"failed","findings":[],"error":"Analysis did not complete"}' \
              > "$DATA_DIR/hardis_report.json"
          fi

      - name: Extract Hardis Findings
        run: jq '.findings // []' "$DATA_DIR/hardis_report.json" > "$DATA_DIR/hardis_findings.json"

      ###########################################################################
      # ENRICH REPORTS + MERGE HARDIS FINDINGS
      ###########################################################################
      - name: Enrich Reports with Metadata
        run: |
          jq -s '
            reduce .[0].result.records[] as $r (
              [];
              . + [{
                Id: $r.Id,
                Name: $r.Name,
                FolderName: $r.FolderName,
                DeveloperName: $r.DeveloperName,
                Format: $r.Format,
                LastRunDays: (
                  if $r.LastRunDate == null then null
                  else ((now - (($r.LastRunDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                  end
                ),
                CreatedDays: (
                  if $r.CreatedDate == null then null
                  else ((now - (($r.CreatedDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                  end
                ),
                OwnerId: $r.OwnerId
              }]
            )
          ' "$DATA_DIR/reports_raw.json" "$DATA_DIR/report_events.json" > "$DATA_DIR/reports_enriched.json"

      - name: Merge Hardis Findings by Report ID
        run: |
          jq '
            # Build map: ReportId → [findings]
            (input | group_by(.reportId) | map({key: .[0].reportId, value: .}) | from_entries) as $hardisMap |
            map(
              .HardisWarnings = ($hardisMap[.Id] // [])
            )
          ' "$DATA_DIR/reports_enriched.json" "$DATA_DIR/hardis_findings.json" > "$DATA_DIR/reports_enriched_with_hardis.json"
          mv "$DATA_DIR/reports_enriched_with_hardis.json" "$DATA_DIR/reports_enriched.json"

      ###########################################################################
      # SUMMARY STATISTICS
      ###########################################################################
      - name: Generate Summary Stats
        run: |
          jq '{
            totalReports: length,
            neverRun: map(select(.LastRunDays == null)) | length,
            staleReports: map(select(.LastRunDays != null and .LastRunDays > 180)) | length,
            withHardisWarnings: map(select(.HardisWarnings | length > 0)) | length
          }' "$DATA_DIR/reports_enriched.json" > "$DATA_DIR/summary_stats.json"

      ###########################################################################
      # DISTRIBUTION BY FOLDER
      ###########################################################################
      - name: Reports by Folder
        run: |
          jq '[.[] | .FolderName // "Unspecified"] | group_by(.) | map({folder: .[0], count: length})' \
            "$DATA_DIR/reports_enriched.json" > "$DATA_DIR/reports_by_folder.json"

      ###########################################################################
      # GENERATE MARKDOWN TABLES
      ###########################################################################
      - name: Generate Summary Table (Markdown)
        run: |
          jq -r '
            "Metric | Value\n--- | ---\n" +
            "Total Reports | " + (.totalReports | tostring) + "\n" +
            "Never Run | " + (.neverRun | tostring) + "\n" +
            "Stale (>180 days) | " + (.staleReports | tostring) + "\n" +
            "Reports with Hardis Warnings | " + (.withHardisWarnings | tostring)
          ' "$DATA_DIR/summary_stats.json" > "$DATA_DIR/summary_table.md"

      - name: Generate Folder Distribution Table (Markdown)
        run: |
          {
            echo "Folder | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.folder) | \(.count)"' "$DATA_DIR/reports_by_folder.json"
          } > "$DATA_DIR/folder_table.md"

      ###########################################################################
      # AI EXECUTIVE SUMMARY
      ###########################################################################
      - name: Build AI Summary
        run: |
          MODEL="${{ github.event.inputs.model_name }}"
          CONTEXT=$(jq -r '
            "Total reports: " + (.totalReports | tostring) + "\n" +
            "Never run: " + (.neverRun | tostring) + "\n" +
            "Stale (>180d): " + (.staleReports | tostring) + "\n" +
            "Reports w/ Hardis warnings: " + (.withHardisWarnings | tostring)
          ' "$DATA_DIR/summary_stats.json")
          echo "$CONTEXT" | ollama run "$MODEL" > "$DATA_DIR/ai_summary.md"

      ###########################################################################
      # BUILD FINAL MARKDOWN REPORT
      ###########################################################################
      - name: Build Final Markdown Report
        run: |
          {
            echo "# AI-Powered Reports Analysis"
            echo
            echo "## Executive Summary"
            cat "$DATA_DIR/ai_summary.md"
            echo
            echo "## Summary Statistics"
            cat "$DATA_DIR/summary_table.md"
            echo
            echo "## Reports by Folder"
            cat "$DATA_DIR/folder_table.md"
            echo
            echo "## Detailed Enriched Report (Preview - Top 10)"
            echo "| Id | Name | Folder | Format | Last Run (Days Ago) | Created (Days Ago) | Hardis Warnings |"
            echo "|---|---|---|---|---|---|---|"
            jq -r '.[0:10][] | 
              "| \(.Id) | \(.Name // "") | \(.FolderName // "Unspecified") | \(.Format // "") | \(.LastRunDays // "null") | \(.CreatedDays // "null") | \((.HardisWarnings | length) // 0) |"
            ' "$DATA_DIR/reports_enriched.json" || echo "| _Failed to render preview_ |"
            echo
            echo "*(Full data available in artifacts)*"
            echo
            echo "## Appendix: Full Enriched Report (JSON)"
            echo '```json'
            cat "$DATA_DIR/reports_enriched.json"
            echo '```'
          } > final_report.md

      ###########################################################################
      # UPLOAD ARTIFACTS
      ###########################################################################
      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: report
          path: final_report.md

      - name: Upload JSON and Markdown Data Files
        uses: actions/upload-artifact@v4
        with:
          name: report_data
          path: |
            data/reports_raw.json
            data/report_events.json
            data/reports_enriched.json
            data/hardis_findings.json
            data/summary_stats.json
            data/reports_by_folder.json
            data/summary_table.md
            data/folder_table.md
            data/ai_summary.md
