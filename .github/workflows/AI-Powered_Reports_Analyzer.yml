# AI-Powered Reports Analyzer (Fixed Version)
# Full corrected pipeline with sf for auth/queries and sfdx for Hardis

name: AI-Powered Reports Analyzer (Enhanced Fixed)

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        description: "Ollama model"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  analyze-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create data directory
        run: mkdir -p "$DATA_DIR"

      - name: Install Salesforce CLI (sf) for auth & queries
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "${{ github.event.inputs.org_alias }}"
          sf org display --target-org "${{ github.event.inputs.org_alias }}"

      - name: Install sfdx + Hardis (LOCAL) for analysis only
        run: |
          npm install sfdx-cli --save-dev
          npm install sfdx-hardis --save-dev
          npx sfdx --version
          npx sfdx hardis:version

      ###########################################################################
      # COLLECT REPORT METADATA
      ###########################################################################
      - name: Create data directory
        run: mkdir -p "$DATA_DIR"
        
      - name: Fetch Reports
        run: |
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, Name, LastViewedDate, LastRunDate, OwnerId, DeveloperName, Format, CreatedDate FROM Report" \
            > "$DATA_DIR/reports_raw.json"
            
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --result-format json \
            --query "SELECT Id, CreatedDate, ReportId, UserId FROM ReportEvent LIMIT 50000" \
            > $DATA_DIR/report_events.json

      ###########################################################################
      # RUN HARDIS REPORT ANALYZER (via sfdx only)
      ###########################################################################

      - name: Run Hardis Analyzer
        run: |
          if npx sfdx hardis:org:report:analyze \
              --target-org "${{ github.event.inputs.org_alias }}" \
              --format json \
              --outputfile "$DATA_DIR/hardis_report.json"; then
              echo "Hardis report OK"
          else
              echo '{"status":"skipped","findings":[]}' > "$DATA_DIR/hardis_report.json"
          fi

          # validate JSON
          if ! jq empty "$DATA_DIR/hardis_report.json" 2>/dev/null; then
            echo '{"status":"skipped","findings":[]}' > "$DATA_DIR/hardis_report.json"
          fi

      ###########################################################################
      # NORMALIZE HARDIS OUTPUT
      ###########################################################################

      - name: Extract Hardis Findings
        run: |
          jq '.findings // []' "$DATA_DIR/hardis_report.json" > "$DATA_DIR/hardis_findings.json"

      ###########################################################################
      # MERGE REPORT METADATA + USAGE + HARDIS
      ###########################################################################
      - name: Enrich Reports
        run: |
          jq -s '
            reduce .[0].result.records[] as $r (
              [];
              . + [{
                Id: $r.Id,
                Name: $r.Name,
                Description: $r.Description,
                Format: $r.Format,
                LastRunDays: (
                  if $r.LastRunDate == null then null
                  else ((now - (($r.LastRunDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                  end
                ),
                CreatedDays: (
                  if $r.CreatedDate == null then null
                  else ((now - (($r.CreatedDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                  end
                ),
                OwnerId: $r.OwnerId
              }]
            )
          ' "$DATA_DIR/reports_raw.json" "$DATA_DIR/report_events.json" > "$DATA_DIR/reports_enriched.json"
      ###########################################################################
      # SUMMARY STATS
      ###########################################################################

      - name: Generate Summary
        run: |
          jq '{
            totalReports: (length),
            neverRun: map(select(.usage.LastRunDate == null)) | length,
            staleReports: map(select(.usage.daysSinceLastActivity != null and .usage.daysSinceLastActivity > 180)) | length,
            withHardisWarnings: map(select(.hardisWarnings | length > 0)) | length
          }' "$DATA_DIR/reports_enriched.json" > "$DATA_DIR/summary_stats.json"

      ###########################################################################
      # AI EXECUTIVE SUMMARY (Ollama via model choice)
      ###########################################################################

      - name: Build AI Summary
        run: |
          MODEL="${{ github.event.inputs.model_name }}"

          CONTEXT=$(jq -r \
            '{totalReports, neverRun, staleReports, withHardisWarnings} | 
             "Total reports: " + (.totalReports|tostring) + "
              =
             "Never run: " + (.neverRun|tostring) + "
             " +
             "Stale (>180d): " + (.staleReports|tostring) + "
             " +
             "Reports w/ Hardis warnings: " + (.withHardisWarnings|tostring)
            ' "$DATA_DIR/summary_stats.json")

          echo "$CONTEXT" | ollama run "$MODEL" > "$DATA_DIR/ai_summary.md"

      ###########################################################################
      # FINAL REPORT
      ###########################################################################

      - name: Build Final Markdown Report
        run: |
          echo "# AI-Powered Reports Analysis" > final_report.md
          echo "## Executive Summary" >> final_report.md
          cat "$DATA_DIR/ai_summary.md" >> final_report.md

          echo "## Summary Statistics" >> final_report.md
          cat "$DATA_DIR/summary_stats.json" >> final_report.md

          echo "## Detailed Enriched Report JSON" >> final_report.md
          echo '
          ```json' >> final_report.md
          cat "$DATA_DIR/reports_enriched.json" >> final_report.md
          echo '```' >> final_report.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: report
          path: final_report.md
