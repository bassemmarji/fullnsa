name: AI-Powered Reports Analyzer (Enhanced)

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        description: "Ollama model"
        required: true
        default: "llama3:latest"

env:
  NODE_VERSION: "20"
  DATA_DIR: "data"

jobs:
  collect-metadata:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create data directory
        run: mkdir -p data

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias "${{ github.event.inputs.org_alias }}"

      - name: Fetch Reports Metadata
        run: |
          # Reports (metadata-only)
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, Name, DeveloperName, FolderName, Format, CreatedDate, LastRunDate, OwnerId, NamespacePrefix FROM Report" \
            --result-format json > data/reports_raw.json
          # Resolve User names
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, Name FROM User" \
            --result-format json > data/users.json
          # Resolve Folder names (legacy orgs)
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, Name FROM Folder WHERE Type = 'Report'" \
            --result-format json > data/report_folders.json
          # Report usage events (requires Event Monitoring)
          sf data query --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT Id, CreatedDate, ReportId, UserId FROM ReportEvent LIMIT 50000" \
            --result-format json > data/report_events.json
      

      - name: Retrieve All Reports Metadata (Debug-Safe - Fixed with FolderName)
        run: |
          set -euo pipefail
      
          # Temporary files
          REPORTS_FOR_RETRIEVE_JSON="data/reports_for_retrieve.json"
      
          echo "ðŸ” Fetching reports with FolderName, DeveloperName, and NamespacePrefix..."
          sf data query \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --query "SELECT FolderName, DeveloperName, NamespacePrefix FROM Report WHERE DeveloperName != null" \
            --result-format json > "$REPORTS_FOR_RETRIEVE_JSON"
      
          echo "ðŸ“„ First 10 lines of reports query response:"
          head -10 "$REPORTS_FOR_RETRIEVE_JSON"
      
          REPORT_COUNT=$(jq '.result.records | length // 0' "$REPORTS_FOR_RETRIEVE_JSON")
          echo "âœ… Found $REPORT_COUNT reports with DeveloperName."
      
          if [ "$REPORT_COUNT" -eq 0 ]; then
            echo "âš ï¸ No reports to retrieve."
            exit 0
          fi
      
          # Create temporary project for retrieve
          sf project generate --name reports-project --manifest
          cd reports-project
      
          # Generate list of members: FolderName/ReportDeveloperName
          # Special handling: if FolderName is "Unfiled Public Reports" (or variations), use "unfiled$public"
          # Generate members
          jq -r '
            .result.records[]
            | select(.DeveloperName != null and (.NamespacePrefix // "") == "") 
            | .FolderName as $folder
            | .DeveloperName as $dev
            | if ($folder | ascii_downcase | contains("unfiled") or $folder == "" or $folder == null) then
                "unfiled$public/\($dev)"
              else
                "\($folder)/\($dev)"
              end
          ' "../$REPORTS_FOR_RETRIEVE_JSON" > report_members_filtered.txt

          REPORT_MEMBERS_FILE="$(pwd)/report_members.txt"
          
          # Create temporary project
          sf project generate --name reports-project --manifest
          cd reports-project
          
          # Use absolute path here ðŸ‘‡
          {
          cat <<'XML_HEADER'
          <?xml version="1.0" encoding="UTF-8"?>
          <Package xmlns="http://soap.sforce.com/2006/04/metadata">
            <types>
          XML_HEADER
          
          while IFS= read -r member; do
            escaped=$(echo "$member" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
            printf '    <members>%s</members>\n' "$escaped"
          done < "$REPORT_MEMBERS_FILE"
          
          cat <<'XML_FOOTER'
            <name>Report</name>
          </types>
          <version>62.0</version>
          </Package>
          XML_FOOTER
          } > manifest/package.xml

          echo "ðŸ“„ Generated package.xml (first 40 lines):"
          head -40 manifest/package.xml
      
          echo "ðŸ“¦ Starting metadata retrieve..."
          sf project retrieve start \
            --target-org "${{ github.event.inputs.org_alias }}" \
            --manifest manifest/package.xml \
            --wait 60 || echo "âš ï¸ Retrieve completed with some warnings/errors"
            
          # Copy retrieved report metadata files back to data directory
          mkdir -p ../../data/report_metadata
          find force-app -type f -name "*.report-meta.xml" \
            -exec cp {} ../../data/report_metadata/ \; 2>/dev/null || true
          find force-app -type f -name "*.reportFolder-meta.xml" \
            -exec cp {} ../../data/report_metadata/ \; 2>/dev/null || true  # In case folders are retrieved incidentally
      
          TOTAL=$(find ../../data/report_metadata -name "*.report-meta.xml" | wc -l)
          echo "âœ… Retrieved $TOTAL report metadata files."
      
          if [ "$TOTAL" -eq 0 ]; then
            echo "âš ï¸ WARNING: No report metadata retrieved."
            echo "Possible reasons:"
            echo " - Many reports are in managed packages or standard (not retrievable as custom metadata)"
            echo " - Reports in private folders (not retrievable via Metadata API)"
            echo " - Permission issues on some reports/folders"
            echo " - FolderName contains special characters causing issues (check logs)"
          else
            echo "ðŸ“‚ Retrieved files preview:"
            ls -l ../../data/report_metadata | head -15
          fi
          
      - name: Verify files exist
        run: ls -l data

      - name: Upload Metadata Artifact
        uses: actions/upload-artifact@v4
        with:
          name: raw_metadata
          path: |
            data/reports_raw.json
            data/report_events.json
            data/users.json
            data/report_folders.json
  ai-analysis:
    runs-on: ubuntu-latest
    needs: collect-metadata
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create data directory
        run: mkdir -p data

      - name: Download Metadata Artifact
        uses: actions/download-artifact@v4
        with:
          name: raw_metadata
          path: data

      - name: List files in data
        run: ls -l data

      - name: Install Ollama CLI
        run: |
          curl -fsSL https://ollama.com/install.sh | sudo bash
          ollama --version
      - name: Start Ollama Service
        run: |
          ollama serve &
          sleep 5
          ollama pull "${{ github.event.inputs.model_name }}"
      
      - name: Enrich Reports
        run: |
          jq -s '
            # Normalize folder and user lists
            (. [1] | if has("result") then .result.records else .records // [] end) as $folderList |
            (. [2] | if has("result") then .result.records else .records // [] end) as $userList |
      
            # Build lookup maps (filter out null Ids)
            ($folderList | map(select(.Id != null) | {(.Id): .Name}) | add // {}) as $folders |
            ($userList   | map(select(.Id != null) | {(.Id): .Name}) | add // {}) as $users |
      
            # Process reports
            (. [0] | if has("result") then .result.records else .records // [] end) as $reports |
            $reports |
            map({
              Id: .Id,
              Name: .Name,
      
              FolderName:
                (if (.FolderId // null) != null and ($folders[.FolderId] // null) != null
                 then $folders[.FolderId]
                 else "Unspecified" end),
      
              DeveloperName: .DeveloperName,
              Format: .Format,
              OwnerId: .OwnerId,
      
              OwnerName:
                (if (.OwnerId // null) != null and ($users[.OwnerId] // null) != null
                 then $users[.OwnerId]
                 else "Unknown Owner" end),
      
              Package: (.NamespacePrefix // "Unmanaged"),
      
              LastRunDays:
                (if .LastRunDate == null then null
                 else ((now - ((.LastRunDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                 end),
      
              CreatedDays:
                (if .CreatedDate == null then null
                 else ((now - ((.CreatedDate | sub("\\.\\d{3}[+-]\\d{4}$"; "Z")) | fromdateiso8601)) / 86400 | floor)
                 end)
            })
          ' data/reports_raw.json data/report_folders.json data/users.json > data/reports_enriched.json
      
      - name: Generate Summary Stats
        run: |
          jq '{
            totalReports: length,
            neverRun: map(select(.LastRunDays == null)) | length,
            staleReports: map(select(.LastRunDays != null and .LastRunDays > 180)) | length
          }' data/reports_enriched.json > data/summary_stats.json

      - name: Reports by Folder
        run: |
          jq '[.[] | .FolderName // "Unspecified"] | group_by(.) | map({folder: .[0], count: length})' \
            data/reports_enriched.json > data/reports_by_folder.json
      - name: Reports by Format
        run: |
          jq '
            map(select(.Format != null)) |
            group_by(.Format) |
            map({ format: .[0].Format, count: length }) |
            sort_by(.count) | reverse
          ' data/reports_enriched.json > data/reports_by_format.json
      - name: Reports by Owner
        run: |
          jq '
            group_by(.OwnerName) |
            map({ owner: .[0].OwnerName, count: length }) |
            sort_by(.count) | reverse
          ' data/reports_enriched.json > data/reports_by_owner.json
      - name: Reports by Package
        run: |
          jq '
            group_by(.Package) |
            map({ package: .[0].Package, count: length }) |
            sort_by(.count) | reverse
          ' data/reports_enriched.json > data/reports_by_package.json
      - name: Generate Summary Table (Markdown)
        run: |
          jq -r '
            "Metric | Value\n--- | ---\n" +
            "Total Reports | " + (.totalReports | tostring) + "\n" +
            "Never Run | " + (.neverRun | tostring) + "\n" +
            "Stale (>180 days) | " + (.staleReports | tostring)
          ' data/summary_stats.json > data/summary_table.md
      - name: Generate Distribution Tables (Markdown)
        run: |
          # Folder
          {
            echo "Folder | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.folder) | \(.count)"' data/reports_by_folder.json
          } > data/folder_table.md
          # Format
          {
            echo "Format | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.format // "Unknown") | \(.count)"' data/reports_by_format.json
          } > data/format_table.md
          # Owner
          {
            echo "Owner | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.owner) | \(.count)"' data/reports_by_owner.json
          } > data/owner_table.md
          # Package
          {
            echo "Package | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.package) | \(.count)"' data/reports_by_package.json
          } > data/package_table.md
      - name: Build AI Executive Summary
        run: |
          MODEL="${{ github.event.inputs.model_name }}"
          CONTEXT=$(jq -s -r '
            .[0] as $stats |
            .[1] as $folders |
            .[2] as $formats |
            .[3] as $owners |
            .[4] as $packages |
            "# Salesforce Reports Analysis Data\n\n" +
            "## Overall Statistics\n" +
            "- Total reports: \($stats.totalReports)\n" +
            "- Never run: \($stats.neverRun) (\($stats.neverRun / ($stats.totalReports | if . == 0 then 1 else . end) * 100 | floor)%)\n" +
            "- Stale reports (>180d): \($stats.staleReports) (\($stats.staleReports / ($stats.totalReports | if . == 0 then 1 else . end) * 100 | floor)%)\n\n" +
            "## Top Folders by Report Count\n" +
            ($folders | sort_by(.count) | reverse | .[0:5] | map("- \(.folder): \(.count) reports") | join("\n")) +
            "\n\n## Report Formats\n" +
            ($formats | map("- \(.format // "Unknown"): \(.count) reports") | join("\n")) +
            "\n\n## Top Report Owners\n" +
            ($owners | .[0:5] | map("- \(.owner): \(.count) reports") | join("\n")) +
            "\n\n## Package (Namespace) Distribution\n" +
            ($packages | map("- \(.package): \(.count) reports") | join("\n")) +
            "\n\n## Analysis Request\n" +
            "Based on this data, provide:\n" +
            "1. Key insights about report usage, ownership concentration, and package health\n" +
            "2. Actionable recommendations (e.g., consolidate underactive owners, review managed packages)\n" +
            "3. Risks: too many unmanaged reports, stale reports in critical packages, etc.\n" +
            "4. Best practices for governance and cleanup\n\n" +
            "Keep the summary concise (3-5 paragraphs) and business-focused."
          ' \
            data/summary_stats.json \
            data/reports_by_folder.json \
            data/reports_by_format.json \
            data/reports_by_owner.json \
            data/reports_by_package.json)
          echo "$CONTEXT" | ollama run "$MODEL" > data/ai_summary.md
      - name: Build Final Markdown Report
        run: |
          {
            echo "# AI-Powered Reports Analysis"
            echo
            echo "## Executive Summary"
            cat "$DATA_DIR/ai_summary.md"
            echo
            echo "## Summary Statistics"
            echo "Metric | Value"
            echo "--- | ---"
            jq -r '[
              "Total Reports | " + (.totalReports | tostring),
              "Never Run | " + (.neverRun | tostring),
              "Stale (>180 days) | " + (.staleReports | tostring)
            ] | .[]' "$DATA_DIR/summary_stats.json"
            echo
            echo "## Reports by Folder"
            echo "Folder | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.folder) | \(.count)"' "$DATA_DIR/reports_by_folder.json"
            echo
            echo "## Reports by Format"
            echo "Format | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.format // "Unknown") | \(.count)"' "$DATA_DIR/reports_by_format.json"
            echo
            echo "## Reports by Owner"
            echo "Owner | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.owner) | \(.count)"' "$DATA_DIR/reports_by_owner.json"
            echo
            echo "## Reports by Package"
            echo "Package | Count"
            echo "--- | ---"
            jq -r '.[] | "\(.package) | \(.count)"' "$DATA_DIR/reports_by_package.json"
            echo
            echo "## Detailed Enriched Report (Preview - Top 10)"
            echo "| Id | Name | Folder | Format | Owner | Package | Last Run (Days Ago) | Created (Days Ago) | Stale? |"
            echo "|---|---|---|---|---|---|---|---|---|"
            jq -r '.[0:10][] |
              "| \(.Id) | \(.Name // "") | \(.FolderName // "Unspecified") | \(.Format // "") | \(.OwnerName // "") | \(.Package // "") | \(.LastRunDays // "null") | \(.CreatedDays // "null") | \(
                if .LastRunDays != null and .LastRunDays > 180 then "Yes" else "No" end
              ) |"' "$DATA_DIR/reports_enriched.json"
            echo
            echo "*(Full data available in artifacts)*"
            echo
            echo "## Appendix: Full Enriched Report (JSON)"
            echo '```json'
            cat "$DATA_DIR/reports_enriched.json"
            echo '```'
          } > final_report.md
      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final_report
          path: final_report.md

      - name: Upload JSON and Markdown Data Files
        uses: actions/upload-artifact@v4
        with:
          name: report_data
          path: |
            data/reports_enriched.json
            data/summary_stats.json
            data/reports_by_folder.json
            data/reports_by_format.json
            data/reports_by_owner.json
            data/reports_by_package.json
            data/ai_summary.md
            data/folder_table.md
            data/format_table.md
            data/owner_table.md
            data/package_table.md
