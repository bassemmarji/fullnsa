name: AI Powered User Activity Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      days_back:
        type: number
        description: "Number of days back to retrieve user activity data"
        required: true
        default: 30
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - Llama 3.2:latest
          - llama3
        default: mistral:instruct
      analysis_focus:
        type: choice
        description: "Analysis focus area"
        options:
          - all
          - suspicious_logins
          - user_behavior
          - security_anomalies
        default: all

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  DAYS_BACK: ${{ github.event.inputs.days_back }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  ANALYSIS_FOCUS: ${{ github.event.inputs.analysis_focus }}
  NODE_VERSION: "20"
  DATA_DIR: "user-activity-data"

jobs:
  collect-user-data:
    name: Collect User Activity Data
    runs-on: ubuntu-latest
    outputs:
      login_count: ${{ steps.query-logins.outputs.login_count }}
      user_count: ${{ steps.query-users.outputs.user_count }}
      has_data: ${{ steps.check-data.outputs.has_data }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm install --global @salesforce/cli
          sf plugins:update
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: ðŸ” Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin
          sf org list

      - name: Query Login History
        id: query-logins
        timeout-minutes: 10
        run: |
          # Calculate start time (UTC)
          START_TIME=$(date -u -d "$DAYS_BACK days ago" '+%Y-%m-%dT%H:%M:%S.000Z')
          echo "ðŸ” Querying login history since: $START_TIME"
          
          # Create data directory
          mkdir -p "$DATA_DIR"
          
          # Query login history with comprehensive fields
          LOGIN_QUERY="SELECT Id, UserId, LoginTime, LoginType, SourceIp, LoginUrl, NetworkId
                            , Browser, Platform, Application, Status, LoginGeoId, TlsProtocol
                            , CipherSuite, OptionsIsGet, OptionsIsPost, CountryIso
                            , ApiType, ApiVersion, ClientVersion, ForwardedForIp
                         FROM LoginHistory 
                        WHERE LoginTime >= $START_TIME 
                     ORDER BY LoginTime DESC 
                        LIMIT 1000"
          
          echo "Executing LoginHistory SOQL query..."
          sf data query \
            --query "$LOGIN_QUERY" \
            --target-org "$ORG_ALIAS" \
            --result-format json > "$DATA_DIR/login_history.json"
            
          # Extract login count
          login_count=$(jq -r '.result.totalSize' "$DATA_DIR/login_history.json")
          echo "ðŸ“Š Found $login_count login records"
          echo "login_count=$login_count" >> $GITHUB_OUTPUT

      - name: Query User Information
        id: query-users
        timeout-minutes: 5
        run: |
          # Get unique user IDs from login history
          user_ids=$(jq -r '.result.records[].UserId' "$DATA_DIR/login_history.json" | sort -u | head -100)
          user_count=$(echo "$user_ids" | wc -l)
          
          if [ "$user_count" -gt 0 ]; then
            # Convert user IDs to SOQL IN clause format
            user_ids_formatted=$(echo "$user_ids" | sed "s/^/'/g" | sed "s/$/'/g" | tr '\n' ',' | sed 's/,$//')
            
            # Query user details
            USER_QUERY="SELECT Id, Username, Name, Email, Profile.Name, UserRole.Name, 
                               IsActive, LastLoginDate, CreatedDate, LastModifiedDate,
                               Department, Division, Title, CompanyName, City, State, Country,
                               TimeZoneSidKey, LocaleSidKey, LanguageLocaleKey, UserType,
                               LastPasswordChangeDate, NumberOfFailedLogins, MobilePhone
                          FROM User 
                         WHERE Id IN ($user_ids_formatted)"
            
            echo "Executing User details SOQL query..."
            sf data query \
              --query "$USER_QUERY" \
              --target-org "$ORG_ALIAS" \
              --result-format json > "$DATA_DIR/user_details.json"
              
            echo "ðŸ“Š Found details for $user_count users"
          fi
          
          echo "user_count=$user_count" >> $GITHUB_OUTPUT

      - name: Query Additional Security Data
        timeout-minutes: 10
        run: |
          # Query SetupAuditTrail for security-related changes
          SETUP_START_TIME=$(date -u -d "$DAYS_BACK days ago" '+%Y-%m-%dT%H:%M:%S.000Z')
          
          SETUP_QUERY="SELECT Id, Action, Section, CreatedDate, CreatedById, CreatedBy.Username,
                              CreatedBy.Name, Display, DelegateUser, ResponsibleNamespacePrefix
                       FROM SetupAuditTrail 
                       WHERE CreatedDate >= $SETUP_START_TIME 
                       AND (Action LIKE '%User%' OR Action LIKE '%Login%' OR Action LIKE '%Password%' 
                            OR Action LIKE '%Profile%' OR Action LIKE '%Permission%' OR Action LIKE '%Security%')
                       ORDER BY CreatedDate DESC 
                       LIMIT 500"
          
          echo "Executing SetupAuditTrail SOQL query..."
          sf data query \
            --query "$SETUP_QUERY" \
            --target-org "$ORG_ALIAS" \
            --result-format json > "$DATA_DIR/setup_audit_trail.json" || echo "âš ï¸ SetupAuditTrail query failed (may not have access)"

      - name: Check Data Availability
        id: check-data
        run: |
          login_count=$(jq -r '.result.totalSize' "$DATA_DIR/login_history.json" 2>/dev/null || echo "0")
          
          if [ "$login_count" -eq 0 ]; then
            echo "âš ï¸ No login data found in the last $DAYS_BACK days"
            echo "has_data=false" >> $GITHUB_OUTPUT
            echo "No user activity data found in the last $DAYS_BACK days" > "$DATA_DIR/no-data-found.txt"
          else
            echo "âœ… Found user activity data to analyze"
            echo "has_data=true" >> $GITHUB_OUTPUT
            
            # Create summary statistics
            jq -r --arg days "$DAYS_BACK" '{
              summary: {
                days_analyzed: ($days | tonumber),
                total_logins: .result.totalSize,
                analysis_period: {
                  start: (.result.records | map(.LoginTime) | min),
                  end: (.result.records | map(.LoginTime) | max)
                },
                unique_users: (.result.records | map(.UserId) | unique | length),
                unique_ips: (.result.records | map(.SourceIp) | unique | length),
                login_types: (.result.records | group_by(.LoginType) | map({type: .[0].LoginType, count: length})),
                platforms: (.result.records | group_by(.Platform) | map({platform: .[0].Platform, count: length}))
              }
            }' "$DATA_DIR/login_history.json" > "$DATA_DIR/data_summary.json"
          fi

      - name: Upload User Activity Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: user-activity-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7
          if-no-files-found: warn

      - name: ðŸ“„ Summary of Collected Data
        run: |
          {
            echo "## ðŸ“Š Data Collection Summary" 
            echo "- Org Alias: **$ORG_ALIAS**" 
            echo "- Analysis Period: **$DAYS_BACK days**"
            echo "- Login Records: **${{ steps.query-logins.outputs.login_count }}**" 
            echo "- Users Analyzed: **${{ steps.query-users.outputs.user_count }}**"
            if [ "${{ steps.check-data.outputs.has_data }}" = "true" ]; then
              echo "- Data Available: âœ… **Yes**"
              echo "- Artifact: \`user-activity-data\`"
            else
              echo "- Data Available: âŒ **No data found**"
            fi
          } >> $GITHUB_STEP_SUMMARY
         
