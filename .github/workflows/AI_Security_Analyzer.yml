name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest
      analysis_depth:
        type: choice
        description: "Analysis depth"
        options:
          - quick
          - comprehensive
        default: quick

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Comprehensive Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm install --global @salesforce/cli
          sf plugins:update
          sudo apt-get update && sudo apt-get install -y jq
          
      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin
          sf org list
          
      - name: Query Core Profile & Permission Set Data
        run: |
          mkdir -p "$DATA_DIR"
          echo "ðŸ“‹ Querying profiles..."
          sf data query --query "SELECT Id, Name, UserLicense.Name, Description, CreatedDate, LastModifiedDate FROM Profile ORDER BY Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/profiles.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/profiles.json"
          
          echo "ðŸ“‹ Querying permission sets..."
          sf data query --query "SELECT Id, Name, Description, IsOwnedByProfile, Profile.Name, Label, Type, CreatedDate, LastModifiedDate, CreatedBy.Name FROM PermissionSet ORDER BY Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/permission_sets.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permission_sets.json"
      
      - name: Query Object Permissions
        run: |
          echo "ðŸ” Querying object permissions for profiles..."
          sf data query --query "SELECT Parent.Profile.Name, Parent.ProfileId, SobjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null ORDER BY Parent.Profile.Name, SobjectType" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/profile_object_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/profile_object_permissions.json"
          
          echo "ðŸ” Querying object permissions for permission sets..."
          sf data query --query "SELECT Parent.Name, ParentId, SobjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false ORDER BY Parent.Name, SobjectType" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/permset_object_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permset_object_permissions.json"
      
      - name: Query System Permissions
        run: |
          echo "âš™ï¸ Querying system permissions..."
          sf data query --query "SELECT Parent.Profile.Name, Parent.ProfileId, SystemPermissions.ApiName, SystemPermissions.Label FROM ProfilePermissionSet WHERE Parent.Profile.Name != null ORDER BY Parent.Profile.Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/profile_system_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/profile_system_permissions.json"
      
      - name: Query Permission Set Assignments
        run: |
          echo "ðŸ‘¤ Querying permission set assignments..."
          sf data query --query "SELECT Assignee.Name, Assignee.Profile.Name, Assignee.IsActive, PermissionSet.Name, PermissionSet.Label, PermissionSet.Type FROM PermissionSetAssignment WHERE PermissionSet.IsOwnedByProfile = false AND Assignee.IsActive = true ORDER BY PermissionSet.Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/permission_set_assignments.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permission_set_assignments.json"
      
      - name: Query High-Risk Objects
        run: |
          echo "âš ï¸ Identifying permissions on high-risk objects..."
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment')"
          
          sf data query --query "SELECT Parent.Profile.Name, SobjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE SobjectType IN $CRITICAL_OBJECTS AND Parent.Profile.Name != null ORDER BY SobjectType, Parent.Profile.Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/critical_object_access.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/critical_object_access.json"
      
      - name: Validate Collected Data
        id: check-data
        run: |
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)
          assignments_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_set_assignments.json" 2>/dev/null || echo 0)
          critical_count=$(jq -r '.result.records | length' "$DATA_DIR/critical_object_access.json" 2>/dev/null || echo 0)
          
          echo "ðŸ“Š Data Collection Summary:"
          echo "  - Profiles: $profile_count"
          echo "  - Permission Sets: $permset_count"
          echo "  - Object Permissions: $object_perms_count"
          echo "  - Active Assignments: $assignments_count"
          echo "  - Critical Object Permissions: $critical_count"
          
          total=$((profile_count + permset_count + object_perms_count))
          
          if [ "$total" -gt 0 ]; then
            echo "âœ… Found security configuration data"
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ No security data found"
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh -o install.sh
          chmod +x install.sh && ./install.sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH
          export PATH="$HOME/.ollama/bin:$PATH"
          ollama serve &
          for i in {1..30}; do
            curl -s http://localhost:11434/api/version && break
            sleep 2
          done
          
      - name: Download Model
        run: |
          MODEL="${{ inputs.model_name }}"
          echo "ðŸ¤– Downloading Ollama model: $MODEL"
          ollama pull "$MODEL"
          ollama list
          
      - name: Prepare Analysis Context
        run: |
          echo "ðŸ“Š Preparing structured analysis context..."
          mkdir -p analysis
          
          # Profile summary with permissions
          jq -s '
            {
              profiles: [
                .[0].result.records[] as $profile |
                {
                  name: $profile.Name,
                  license: $profile.UserLicense.Name,
                  description: $profile.Description,
                  object_permissions: [
                    .[1].result.records[] |
                    select(.Parent.Profile.Name == $profile.Name) |
                    {
                      object: .SobjectType,
                      read: .PermissionsRead,
                      create: .PermissionsCreate,
                      edit: .PermissionsEdit,
                      delete: .PermissionsDelete,
                      view_all: .PermissionsViewAllRecords,
                      modify_all: .PermissionsModifyAllRecords
                    }
                  ]
                }
              ]
            }
          ' data/profiles.json data/profile_object_permissions.json > analysis/profile_analysis.json
          
          # Permission set summary with assignments
          jq -s '
            {
              permission_sets: [
                .[0].result.records[] as $ps |
                {
                  name: $ps.Name,
                  label: $ps.Label,
                  type: $ps.Type,
                  is_custom: ($ps.IsOwnedByProfile == false),
                  created_by: $ps.CreatedBy.Name,
                  description: $ps.Description,
                  assigned_to: [
                    .[1].result.records[] |
                    select(.PermissionSet.Name == $ps.Name) |
                    {
                      user: .Assignee.Name,
                      profile: .Assignee.Profile.Name
                    }
                  ] | length,
                  object_permissions: [
                    .[2].result.records[] |
                    select(.Parent.Name == $ps.Name) |
                    {
                      object: .SobjectType,
                      read: .PermissionsRead,
                      create: .PermissionsCreate,
                      edit: .PermissionsEdit,
                      delete: .PermissionsDelete,
                      view_all: .PermissionsViewAllRecords,
                      modify_all: .PermissionsModifyAllRecords
                    }
                  ]
                }
              ]
            }
          ' data/permission_sets.json data/permission_set_assignments.json data/permset_object_permissions.json > analysis/permset_analysis.json
          
          # Critical access analysis
          jq '
            {
              critical_access: [
                .result.records[] |
                select(.PermissionsModifyAllRecords == true or .PermissionsViewAllRecords == true or .PermissionsDelete == true) |
                {
                  profile: .Parent.Profile.Name,
                  object: .SobjectType,
                  modify_all: .PermissionsModifyAllRecords,
                  view_all: .PermissionsViewAllRecords,
                  delete: .PermissionsDelete
                }
              ] | group_by(.profile) | map({profile: .[0].profile, critical_objects: map(.object)})
            }
          ' data/critical_object_access.json > analysis/critical_access.json
          
          # Summary stats
          cat <<EOF > analysis/summary.json
          {
            "total_profiles": $(jq '.result.records | length' data/profiles.json),
            "total_permission_sets": $(jq '.result.records | length' data/permission_sets.json),
            "total_active_assignments": $(jq '.result.records | length' data/permission_set_assignments.json),
            "total_object_permissions": $(jq '.result.records | length' data/profile_object_permissions.json),
            "profiles_with_modify_all": $(jq '[.result.records[] | select(.PermissionsModifyAllRecords == true) | .Parent.Profile.Name] | unique | length' data/critical_object_access.json),
            "analysis_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          echo "âœ… Context preparation complete"
          
      - name: Run AI Security Analysis
        run: |
          REPORT_FILE="security_analysis_report.md"
          MODEL="${{ inputs.model_name }}"
          
          # Load prepared context
          profile_data=$(cat analysis/profile_analysis.json)
          permset_data=$(cat analysis/permset_analysis.json)
          critical_data=$(cat analysis/critical_access.json)
          summary=$(cat analysis/summary.json)
          
          cat <<EOF > prompt.txt
          You are a Salesforce security architect analyzing real permission data from a production org.
          
          IMPORTANT CONSTRAINTS:
          - Base ALL findings on the actual data provided below
          - Do NOT make up permissions or security issues not present in the data
          - If data is insufficient for a specific analysis, state "Data not available" rather than guessing
          - Focus on ACTUAL permission grants, not theoretical risks
          
          ANALYSIS SCOPE:
          The following data represents ACTUAL permissions from the Salesforce org:
          
          SUMMARY STATISTICS:
          $summary
          
          CRITICAL ACCESS PATTERNS (profiles with Modify All or View All on sensitive objects):
          $critical_data
          
          PROFILE PERMISSIONS (showing actual object-level grants):
          $(echo "$profile_data" | jq -c '.profiles[:5]')
          
          PERMISSION SET CONFIGURATIONS (showing actual assignments and grants):
          $(echo "$permset_data" | jq -c '.permission_sets[:10]')
          
          ANALYSIS REQUIREMENTS:
          
          1. CRITICAL FINDINGS - Only report if you find actual evidence in the data:
             - Profiles with "Modify All" or "View All" on User, Profile, or PermissionSet objects
             - Permission sets with excessive object permissions relative to their purpose
             - Unused permission sets (assigned_to count = 0)
             - Permission sets lacking descriptions (description is null/empty)
          
          2. PROFILE RISK ASSESSMENT - Base on actual object permissions:
             - High Risk: Has Modify All or View All on 3+ critical objects
             - Medium Risk: Has Delete on critical objects
             - Low Risk: Standard CRUD without elevated permissions
          
          3. PERMISSION SET HYGIENE:
             - Count custom permission sets (is_custom = true)
             - Identify permission sets with no assignments
             - Flag permission sets missing descriptions
          
          4. COMPLIANCE OBSERVATIONS:
             - Principle of Least Privilege: profiles/permsets with overly broad permissions
             - Separation of Duties: permissions that should be split
             - Audit Trail: missing descriptions for compliance tracking
          
          OUTPUT FORMAT (use Markdown tables):
          
          ## ðŸš¨ Critical Security Findings
          | Severity | Finding | Affected Profile/PermSet | Evidence | Recommendation |
          |----------|---------|--------------------------|----------|----------------|
          
          ## ðŸ“Š Profile Risk Assessment
          | Profile Name | License Type | Risk Level | Critical Permissions | Justification |
          |--------------|--------------|------------|---------------------|---------------|
          
          ## ðŸ” Permission Set Analysis
          | Permission Set | Assigned Users | Has Description | Critical Permissions | Status |
          |----------------|----------------|-----------------|---------------------|--------|
          
          ## âœ… Compliance & Best Practices
          | Area | Status | Finding | Recommendation |
          |------|--------|---------|----------------|
          
          ## ðŸ“ˆ Executive Summary
          - Total Profiles: $(echo "$summary" | jq -r '.total_profiles')
          - Total Permission Sets: $(echo "$summary" | jq -r '.total_permission_sets')
          - Profiles with Elevated Access: $(echo "$summary" | jq -r '.profiles_with_modify_all')
          - Active Permission Set Assignments: $(echo "$summary" | jq -r '.total_active_assignments')
          - Analysis Model: $MODEL
          - Timestamp: $(echo "$summary" | jq -r '.analysis_timestamp')
          
          CRITICAL: Only report findings supported by the actual data provided. Do not invent security issues.
          EOF
          
          echo "ðŸ¤– Running AI analysis with $MODEL..."
          cat prompt.txt | ollama run "$MODEL" > "$REPORT_FILE"
          echo "âœ… Analysis complete. Report saved to $REPORT_FILE"
          
      - name: Generate Quick Metrics
        run: |
          echo "ðŸ“Š Generating quick security metrics..."
          
          cat <<EOF > security_metrics.json
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "org_alias": "${{ github.event.inputs.org_alias }}",
            "metrics": {
              "profiles_total": $(jq '.result.records | length' data/profiles.json),
              "permission_sets_total": $(jq '.result.records | length' data/permission_sets.json),
              "permission_sets_custom": $(jq '[.result.records[] | select(.IsOwnedByProfile == false)] | length' data/permission_sets.json),
              "permission_sets_unassigned": $(jq -s '[.[0].result.records[] | select(.IsOwnedByProfile == false) | .Name] as $all_ps | [.[1].result.records[].PermissionSet.Name] as $assigned | [$all_ps[] | select(. as $ps | $assigned | index($ps) | not)] | length' data/permission_sets.json data/permission_set_assignments.json),
              "active_assignments": $(jq '.result.records | length' data/permission_set_assignments.json),
              "profiles_with_modify_all": $(jq '[.result.records[] | select(.PermissionsModifyAllRecords == true) | .Parent.Profile.Name] | unique | length' data/critical_object_access.json),
              "critical_object_permissions": $(jq '.result.records | length' data/critical_object_access.json)
            }
          }
          EOF
          
          echo "âœ… Metrics generated"
          jq '.' security_metrics.json
          
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-results
          path: |
            security_analysis_report.md
            security_metrics.json
            analysis/
          retention-days: 30

      - name: Post Analysis Summary
        run: |
          echo "## ðŸ”’ Salesforce Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Analysis Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Profiles Analyzed:** $(jq -r '.metrics.profiles_total' security_metrics.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Permission Sets Analyzed:** $(jq -r '.metrics.permission_sets_total' security_metrics.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Custom Permission Sets:** $(jq -r '.metrics.permission_sets_custom' security_metrics.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Unassigned Permission Sets:** $(jq -r '.metrics.permission_sets_unassigned' security_metrics.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Active Assignments:** $(jq -r '.metrics.active_assignments' security_metrics.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Profiles with Modify All Access:** $(jq -r '.metrics.profiles_with_modify_all' security_metrics.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¤– AI Model" >> $GITHUB_STEP_SUMMARY
          echo "- **Model:** \`${{ inputs.model_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Org:** \`${{ github.event.inputs.org_alias }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Full Report:** \`security_analysis_report.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Metrics JSON:** \`security_metrics.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Analysis Data:** \`analysis/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ Download the \`security-analysis-results\` artifact for complete findings." >> $GITHUB_STEP_SUMMARY
