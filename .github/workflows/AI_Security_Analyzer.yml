name: AI Security & Permissions Analyzer
on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - gemma2:27b
          - llama3:latest
          - mistral-large
        default: gemma2:27b

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI and jq
        run: |
          npm install --global @salesforce/cli
          sudo apt-get update && sudo apt-get install -y jq curl
          sf version

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias ${{ env.ORG_ALIAS }} --set-default --sfdx-url-stdin
          sf org list

      - name: Collect Salesforce Data
        env:
          ORG_ALIAS: ${{ env.ORG_ALIAS }}
        run: |
          DATA_DIR="security-data"
          mkdir -p "$DATA_DIR"

          echo "ðŸ“Œ Collecting Profiles"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData,
            PermissionsViewSetup, PermissionsManageUsers
            FROM Profile ORDER BY Name
          " --json > "$DATA_DIR/profiles.json"

          echo "ðŸ“Œ Collecting Community Profiles"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM Profile
            WHERE Name LIKE '%Community%' OR Name LIKE '%Partner%' OR Name LIKE '%Customer%'
            ORDER BY Name
          " --json > "$DATA_DIR/community_profiles.json"

          echo "ðŸ“Œ Collecting Permission Sets"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name, Label, Description,
            IsOwnedByProfile,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM PermissionSet ORDER BY Name
          " --json > "$DATA_DIR/permission_sets.json"

          echo "ðŸ“Œ Collecting Permission Set Assignments"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, AssigneeId, PermissionSetId,
            PermissionSet.Name,
            Assignee.Name, Assignee.Username
            FROM PermissionSetAssignment
            WHERE Assignee.IsActive = true
          " --json > "$DATA_DIR/permission_set_assignments.json"

          echo "ðŸ“Œ Collecting Profile Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.IsOwnedByProfile = true
          " --json > "$DATA_DIR/profile_object_permissions.json"

          echo "ðŸ“Œ Collecting Permission Set Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            ParentId,
            Parent.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.IsOwnedByProfile = false
          " --json > "$DATA_DIR/permset_object_permissions.json"

          echo "ðŸ“Œ Collecting Critical Object Access"
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org "$ORG_ALIAS" --query "
              SELECT
                Parent.Profile.Id,
                Parent.Profile.Name,
                SObjectType,
                PermissionsRead, PermissionsCreate, PermissionsEdit,
                PermissionsDelete, PermissionsViewAllRecords,
                PermissionsModifyAllRecords
              FROM ObjectPermissions
             WHERE Parent.IsOwnedByProfile = true
               AND SObjectType IN $CRITICAL_OBJECTS
          " --json > "$DATA_DIR/critical_object_access.json"

          echo "ðŸ“Œ Collecting Active Users"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Username, Name, ProfileId, Profile.Name,
            IsActive, LastLoginDate
            FROM User
            WHERE IsActive = true
            ORDER BY Profile.Name
          " --json > "$DATA_DIR/active_users.json"

          echo "ðŸ“Œ Collecting User Stats by Profile"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT ProfileId, Profile.Name, COUNT(Id) UserCount
            FROM User
            WHERE IsActive = true
            GROUP BY ProfileId, Profile.Name
          " --json > "$DATA_DIR/user_stats.json"

          echo "âœ… All Salesforce data collection steps completed."

      - name: Validate Collected Data
        id: check-data
        run: |
          DATA_DIR="security-data"
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)

          echo "Profiles: $profile_count"
          echo "Permission Sets: $permset_count"
          echo "Object Permissions: $object_perms_count"

          total=$((profile_count + permset_count + object_perms_count))
          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: security-data
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    timeout-minutes: 60
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5
          ollama pull ${{ env.MODEL_NAME }}

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis

          # Combine all data into single context
          jq -s '{
            profiles: [.[0].result.records[]? | select(.Id != null and .Name != null)],
            community_profiles: [.[1].result.records[]? | select(.Id != null)],
            permission_sets: [.[2].result.records[]? | select(.Id != null and .Name != null)],
            assignments: [.[3].result.records[]? | select(.PermissionSetId != null)],
            profile_object_permissions: [.[4].result.records[]? | select(.Parent.ProfileId != null)],
            permset_object_permissions: [.[5].result.records[]?],
            critical_access: [.[6].result.records[]? | select(.Parent.ProfileId != null)],
            active_users: [.[7].result.records[]? | select(.Id != null)],
            user_stats: [.[8].result.records[]? | select(.ProfileId != null)]
          }' \
            data/profiles.json \
            data/community_profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/active_users.json \
            data/user_stats.json \
            > analysis/context.json

          # Detect unused permission sets
          jq -r '
            ([.assignments[]? | .PermissionSetId | select(. != null)] | unique) as $assigned_ids
            | [.permission_sets[]? | select(.IsOwnedByProfile != true and .Id != null)]
            | map(select(.Id as $ps_id | $assigned_ids | index($ps_id) | not))
          ' analysis/context.json > analysis/unused_permission_sets.json

          # Compute enhanced stats
          jq --argjson unused_ps "$(cat analysis/unused_permission_sets.json)" '{
            total_profiles: (.profiles | length),
            community_profiles: (.community_profiles | length),
            total_permission_sets: (.permission_sets | length),
            total_assignments: (.assignments | length),
            unused_permission_sets: ($unused_ps | length),
            profiles_with_modify_all: ([.profiles[] | select(.PermissionsModifyAllData == true)] | length),
            profiles_with_view_all: ([.profiles[] | select(.PermissionsViewAllData == true)] | length),
            profiles_with_either_all_data_perm: ([.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | length),
            permsets_with_modify_all: ([.permission_sets[] | select(.PermissionsModifyAllData == true)] | length),
            permsets_with_view_all: ([.permission_sets[] | select(.PermissionsViewAllData == true)] | length),
            total_active_users: (.active_users | length)
          }' analysis/context.json > analysis/stats.json
          
      - name: Pre-process Overprivileged Profiles Data
        run: |
          # FIXED: Correctly map critical objects using Parent.ProfileId
          jq -r '
            ([.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)]) as $overpriv_profiles
            | (.critical_access) as $critical_access
            | (.user_stats | map({(.ProfileId): .UserCount}) | add // {}) as $user_counts
            | $overpriv_profiles | map(
                . as $profile
                | {
                    ProfileId: .Id,
                    ProfileName: .Name,
                    PermissionsModifyAllData: .PermissionsModifyAllData,
                    PermissionsViewAllData: .PermissionsViewAllData,
                    PermissionsViewSetup: .PermissionsViewSetup,
                    PermissionsManageUsers: .PermissionsManageUsers,
                    UserCount: ($user_counts[.Id] // 0),
                    CriticalObjects: (
                      [$critical_access[]? |
                         select(.Parent.ProfileId == $profile.Id) |
                         .SObjectType
                      ] | unique | sort
                    )
                }
            )
          ' analysis/context.json > analysis/overprivileged_enriched.json

          # Debug output
          echo "=== Overprivileged Profiles Preview ==="
          jq '.[0:2]' analysis/overprivileged_enriched.json

      - name: Generate Report Structure
        run: |
          MODEL="${{ env.MODEL_NAME }}"

          cat > security_analysis_report.md << EOF
          # Salesforce Security Analysis Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Org Alias:** ${{ env.ORG_ALIAS }}  
          **Analysis Model:** ${{ env.MODEL_NAME }}  
          **Report Version:** 3.0

          ---

          EOF

          # Generate executive summary with stats
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          TOTAL_PROFILES=$(jq -r '.total_profiles' analysis/stats.json)
          TOTAL_USERS=$(jq -r '.total_active_users' analysis/stats.json)
          COMMUNITY_PROFILES=$(jq -r '.community_profiles' analysis/stats.json)

          cat <<EOEXEC | ollama run "$MODEL" >> security_analysis_report.md
          You are a Salesforce security CISO writing an executive summary. Use these exact numbers:

          - Total Profiles: $TOTAL_PROFILES
          - Community Profiles: $COMMUNITY_PROFILES
          - Total Active Users: $TOTAL_USERS
          - Overprivileged Profiles: $OVERPRIV_COUNT (with ModifyAllData or ViewAllData)
          - Unused Permission Sets: $UNUSED_COUNT

          Write a concise 3-paragraph executive summary:
          1. Current security posture assessment
          2. Critical findings with business impact
          3. Top 2 immediate actions required

          Be direct, use bullet points for key risks, avoid generic statements.
          EOEXEC

          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md

      - name: Analyze Overprivileged Profiles
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)

          if [ "$OVERPRIV_COUNT" -gt 0 ]; then
            echo "" >> security_analysis_report.md
            echo "## ðŸ”´ Overprivileged Profiles Analysis" >> security_analysis_report.md
            echo "" >> security_analysis_report.md
            echo "**Total Identified:** $OVERPRIV_COUNT profiles" >> security_analysis_report.md
            echo "" >> security_analysis_report.md

            # Generate detailed table
            echo "| Profile Name | Users | Modify All | View All | View Setup | Manage Users | Critical Objects |" >> security_analysis_report.md
            echo "|--------------|-------|------------|----------|------------|--------------|------------------|" >> security_analysis_report.md

            jq -r '.[] |
              "| \(.ProfileName) | \(.UserCount) | \(.PermissionsModifyAllData // false) | \(.PermissionsViewAllData // false) | \(.PermissionsViewSetup // false) | \(.PermissionsManageUsers // false) | \(if (.CriticalObjects | length) > 0 then (.CriticalObjects | join(", ")) else "None" end) |"
            ' analysis/overprivileged_enriched.json >> security_analysis_report.md

            echo "" >> security_analysis_report.md
            echo "### Detailed Risk Assessment" >> security_analysis_report.md
            echo "" >> security_analysis_report.md

            # AI analysis with formatted input
            jq -r '.[] | 
              "**\(.ProfileName)** (\(.UserCount) users)\n" +
              "- ModifyAllData: \(.PermissionsModifyAllData)\n" +
              "- ViewAllData: \(.PermissionsViewAllData)\n" +
              "- Critical Objects: \(.CriticalObjects | join(", "))\n"
            ' analysis/overprivileged_enriched.json > /tmp/profile_summary.txt

            cat <<EORISK | ollama run "$MODEL" >> security_analysis_report.md
          Analyze these overprivileged Salesforce profiles:

          $(cat /tmp/profile_summary.txt)

          For each profile, provide:
          1. **Risk Level**: Critical/High/Medium based on permissions + user count
          2. **Business Impact**: What data exposure or manipulation is possible
          3. **Remediation**: Specific action (e.g., "Remove ModifyAllData, create custom permission set for X functionality")

          Be specific. Reference actual profile names and user counts.
          EORISK

          else
            echo "" >> security_analysis_report.md
            echo "## âœ… Overprivileged Profiles" >> security_analysis_report.md
            echo "" >> security_analysis_report.md
            echo "No profiles with ModifyAllData or ViewAllData permissions detected." >> security_analysis_report.md
          fi

      - name: Analyze Unused Permission Sets
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)

          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## ðŸŸ¡ Unused Permission Sets" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "**Total Unused:** $UNUSED_COUNT permission sets" >> security_analysis_report.md
          echo "" >> security_analysis_report.md

          if [ "$UNUSED_COUNT" -gt 0 ]; then
            # Show top 20 unused permission sets
            echo "### Top 20 Unused Permission Sets" >> security_analysis_report.md
            echo "" >> security_analysis_report.md
            echo "| Name | Label | Description |" >> security_analysis_report.md
            echo "|------|-------|-------------|" >> security_analysis_report.md

            jq -r '.[0:20] | .[] |
              "| \(.Name // "N/A") | \(.Label // "N/A") | \(if .Description then (.Description | gsub("\n"; " ")) else "No description" end) |"
            ' analysis/unused_permission_sets.json >> security_analysis_report.md

            if [ "$UNUSED_COUNT" -gt 20 ]; then
              REMAINING=$((UNUSED_COUNT - 20))
              echo "" >> security_analysis_report.md
              echo "_... and $REMAINING more (see full list in artifacts)_" >> security_analysis_report.md
            fi

            echo "" >> security_analysis_report.md
            echo "### Recommendations" >> security_analysis_report.md
            echo "" >> security_analysis_report.md

            # Get sample for AI analysis
            jq -r '.[0:10] | .[] | "- \(.Name): \(.Label // "N/A")"' analysis/unused_permission_sets.json > /tmp/unused_sample.txt

            cat <<EOUNUSED | ollama run "$MODEL" >> security_analysis_report.md
          Found $UNUSED_COUNT unused permission sets. Sample:

          $(cat /tmp/unused_sample.txt)

          Provide:
          1. **Risk Assessment**: Why unused permission sets are a security concern
          2. **Cleanup Strategy**: How to prioritize deactivation (test/temp vs. production)
          3. **Governance**: Best practices to prevent permission set sprawl

          Be actionable and specific.
          EOUNUSED

          else
            echo "âœ… **Excellent permission set hygiene!** No unused permission sets detected." >> security_analysis_report.md
          fi

      - name: Generate Security Recommendations
        run: |
          MODEL="${{ env.MODEL_NAME }}"

          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## ðŸ“‹ Strategic Recommendations" >> security_analysis_report.md
          echo "" >> security_analysis_report.md

          cat <<EORECS | ollama run "$MODEL" >> security_analysis_report.md
          Based on these statistics:
          $(cat analysis/stats.json | jq -c .)

          Provide:
          1. **Immediate Actions** (next 30 days): Top 3 priority items with specific steps
          2. **Short-term Improvements** (3-6 months): Governance and process changes
          3. **Long-term Strategy** (6-12 months): Security architecture improvements

          Focus on Salesforce-specific best practices. Be specific and actionable.
          EORECS

      - name: Add Appendix
        run: |
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## ðŸ“Š Appendix: Statistics" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          jq '.' analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

          echo "" >> security_analysis_report.md
          echo "### Sample Overprivileged Profile Data" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          jq '.[0:1]' analysis/overprivileged_enriched.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

          echo "" >> security_analysis_report.md
          echo "### Complete Unused Permission Sets List" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "<details>" >> security_analysis_report.md
          echo "<summary>Click to expand full list ($$(jq 'length' analysis/unused_permission_sets.json) items)</summary>" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          jq '.' analysis/unused_permission_sets.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md
          echo "</details>" >> security_analysis_report.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-report
          path: security_analysis_report.md
          retention-days: 30

      - name: Upload Analysis Data
        uses: actions/upload-artifact@v4
        with:
          name: analysis-debug
          path: analysis/
          retention-days: 7

      - name: Generate Summary
        run: |
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          TOTAL_PROFILES=$(jq -r '.total_profiles' analysis/stats.json)
          TOTAL_USERS=$(jq -r '.total_active_users' analysis/stats.json)

          cat > $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”’ Salesforce Security Analysis Complete

          ### ðŸ“Š Key Metrics

          | Metric | Count |
          |--------|-------|
          | Total Profiles | $TOTAL_PROFILES |
          | Active Users | $TOTAL_USERS |
          | **Overprivileged Profiles** | **$OVERPRIV_COUNT** |
          | **Unused Permission Sets** | **$UNUSED_COUNT** |

          ### âš ï¸ Critical Findings

          EOF

          if [ "$OVERPRIV_COUNT" -gt 0 ]; then
            echo "ðŸ”´ **CRITICAL**: $OVERPRIV_COUNT profiles have ModifyAllData or ViewAllData permissions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | "- **\(.ProfileName)**: \(.UserCount) active users, accesses \(.CriticalObjects | length) critical objects"' analysis/overprivileged_enriched.json | head -5 >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No overprivileged profiles detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$UNUSED_COUNT" -gt 0 ]; then
            UNUSED_PERCENT=$(awk "BEGIN {printf \"%.1f\", ($UNUSED_COUNT * 100.0) / $(jq -r '.total_permission_sets' analysis/stats.json)}")
            echo "ðŸŸ¡ **$UNUSED_COUNT unused permission sets** ($UNUSED_PERCENT% of total) - consider cleanup" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All permission sets are actively used" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF

          ### ðŸ“¥ Download Report

          The complete AI-generated security analysis is available in the **security-analysis-report** artifact above.

          EOF
