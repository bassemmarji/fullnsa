name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        description: "Salesforce org alias"
        required: true
        default: "dev"
        type: string

      model_name:
        description: "Ollama model"
        type: choice
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  DATA_DIR: "security-data"
  NODE_VERSION: "20"

jobs:

  # --------------------------------------------------------------------------
  # 1. COLLECT SECURITY & PERMISSIONS METADATA
  # --------------------------------------------------------------------------
  collect-data:
    name: Collect Salesforce Security Metadata
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.validate.outputs.has_data }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          npm install --global @salesforce/cli
          sf plugins:update
          sudo apt-get update && sudo apt-get install -y jq

      - name: Authenticate Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" \
            | sf org login sfdx-url --alias "$ORG_ALIAS" --set-default --sfdx-url-stdin

      - name: Query Security Metadata
        run: |
          mkdir -p $DATA_DIR

          declare -A QUERIES=(
            ["profiles"]="SELECT Id, Name, UserLicense.Name, Description FROM Profile"
            ["permission_sets"]="SELECT Id, Name, Label, Description, IsOwnedByProfile FROM PermissionSet"
            ["profile_object_permissions"]="SELECT Parent.Profile.Name, SobjectType, PermissionsRead, PermissionsEdit, PermissionsDelete, PermissionsModifyAllRecords, PermissionsViewAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null"
            ["permset_object_permissions"]="SELECT Parent.Name, SobjectType, PermissionsRead, PermissionsEdit, PermissionsDelete, PermissionsModifyAllRecords, PermissionsViewAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false"
            ["permission_set_assignments"]="SELECT Assignee.Name, PermissionSet.Name FROM PermissionSetAssignment WHERE Assignee.IsActive = true"
          )

          for file in "${!QUERIES[@]}"; do
            echo "â³ Querying $file..."
            sf data query \
              --target-org "$ORG_ALIAS" \
              --result-format json \
              --query "${QUERIES[$file]}" \
              > "$DATA_DIR/$file.json" \
              || echo '{"result":{"records":[]}}' > "$DATA_DIR/$file.json"
          done

      - name: Validate Data
        id: validate
        run: |
          profiles=$(jq '.result.records | length' $DATA_DIR/profiles.json)
          psets=$(jq '.result.records | length' $DATA_DIR/permission_sets.json)

          if [ $((profiles + psets)) -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Raw Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}

  # --------------------------------------------------------------------------
  # 2. PROCESS + PREPARE DATA FOR AI ANALYSIS
  # --------------------------------------------------------------------------
  prepare-analysis:
    name: Prepare Data for AI Analysis
    runs-on: ubuntu-latest
    needs: collect-data
    if: needs.collect-data.outputs.has_data == 'true'

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Build Analysis Context
        run: |
          mkdir -p analysis

          jq -s '
            {
              profiles: .[0].result.records,
              permission_sets: .[1].result.records,
              profile_object_permissions: .[2].result.records,
              permset_object_permissions: .[3].result.records,
              permission_assignments: .[4].result.records
            }
          ' \
          data/profiles.json \
          data/permission_sets.json \
          data/profile_object_permissions.json \
          data/permset_object_permissions.json \
          data/permission_set_assignments.json \
          > analysis/context.json

      - name: Upload Analysis Context
        uses: actions/upload-artifact@v4
        with:
          name: analysis-context
          path: analysis

  # --------------------------------------------------------------------------
  # 3. RUN AI SECURITY ANALYSIS
  # --------------------------------------------------------------------------
  ai-analysis:
    name: AI Security Audit
    runs-on: ubuntu-latest
    needs: prepare-analysis

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: analysis-context
          path: analysis

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh -o install.sh
          chmod +x install.sh && ./install.sh
          ollama serve & sleep 5
          ollama pull "${{ env.MODEL_NAME }}"

      - name: Run AI Report
        run: |
          REPORT="security_report.md"

          prompt=$(cat <<'EOF'
          You are a Salesforce Security Architect.
          
          Your task is to perform a **strictly evidence-based**, **comprehensive security audit**
          using ONLY the Salesforce metadata provided in the JSON.
          
          â— IMPORTANT RULES:
          - DO NOT hallucinate.
          - DO NOT mention password policies, file sharing, login hours, unused users,
            or system settings â€” they are NOT in the dataset.
          - ONLY analyze the metadata provided.
          
          The JSON contains:
          - Profiles
          - Permission Sets
          - Profile Object Permissions
          - Permission Set Object Permissions
          - Permission Set Assignments
          
          You MUST produce all of the following sections:
          
          # 1. Unused Permission Sets
          Definition: A permission set is unused if it has **zero entries** in permission_set_assignments.
          For each unused permission set include:
          - Name
          - Label
          - Description
          - Reason: â€œNo active user assignments foundâ€
          
          # 2. Profiles With Modify-All or View-All Permissions
          Using profile_object_permissions:
          List each profile that has:
          - PermissionsModifyAllRecords = true
          - OR PermissionsViewAllRecords = true
          
          For each, include:
          - Profile Name
          - A list of affected SObjects
          - Security risk justification
          
          # 3. Community / External / Portal Profiles With Excess Permissions
          A profile is considered "external" if:
          - Its Name contains: â€œCommunityâ€, â€œCustomerâ€, â€œPartnerâ€, â€œPortalâ€
          - OR the UserLicense.Name indicates a community or portal license.
          
          For these profiles:
          List any SObject where they have:
          - Edit
          - Delete
          - Modify-All
          - View-All
          
          Explain why these permissions may be excessive for external users.
          
          # 4. Object Access Anomalies
          Identify:
          - Profiles with full CRUD on many objects
          - Permission sets with broad access
          - Any inconsistent access patterns across profiles or sets
          
          # 5. Top Risks (Ranked)
          Summarize the most critical risks detected.
          
          # 6. Remediation Recommendations
          Based ONLY on the detected issues, provide:
          - Actionable fixes
          - Prioritization
          - No generic boilerplate
          
          Output strictly in MARKDOWN.
          
          Now process the following JSON data:
          EOF
          )

          {
            echo "$prompt"
            cat analysis/context.json
          } | ollama run "${{ env.MODEL_NAME }}" > "$REPORT"

      - uses: actions/upload-artifact@v4
        with:
          name: ai-security-report
          path: security_report.md

  # --------------------------------------------------------------------------
  # 4. SUMMARY
  # --------------------------------------------------------------------------
  summary:
    name: Final Summary
    runs-on: ubuntu-latest
    needs: ai-analysis

    steps:
      - name: Build Summary
        run: |
          echo "## ðŸ”’ AI Security Analysis Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** $MODEL_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Org:** $ORG_ALIAS" >> $GITHUB_STEP_SUMMARY
          echo "- Raw metadata exported" >> $GITHUB_STEP_SUMMARY
          echo "- AI report generated (strict, Salesforce-specific)" >> $GITHUB_STEP_SUMMARY
