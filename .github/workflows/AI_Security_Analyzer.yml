name: AI Security & Permissions Analyzer
on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:8b
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:8b

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI and jq
        run: |
          npm install --global @salesforce/cli
          sudo apt-get update && sudo apt-get install -y jq curl  
          sf version  

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias ${{ env.ORG_ALIAS }} --set-default --sfdx-url-stdin
          sf org list

      - name: Collect Salesforce Data
        env:
          ORG_ALIAS: ${{ env.ORG_ALIAS }}
        run: |
          DATA_DIR="security-data"
          mkdir -p "$DATA_DIR"

          echo "üìå Collecting Profiles"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData,
            PermissionsViewSetup, PermissionsManageUsers
            FROM Profile ORDER BY Name
          " --json > "$DATA_DIR/profiles.json"

          echo "üìå Collecting Community Profiles (Filtering by Name)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM Profile
            WHERE Name LIKE '%Community%'
            ORDER BY Name
          " --json > "$DATA_DIR/community_profiles.json"

          echo "üìå Collecting Permission Sets"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name, Label, Description,
            IsOwnedByProfile,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM PermissionSet ORDER BY Name
          " --json > "$DATA_DIR/permission_sets.json"

          echo "üìå Collecting Permission Set Assignments"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, AssigneeId, PermissionSetId,
            PermissionSet.Name,
            Assignee.Name, Assignee.Username
            FROM PermissionSetAssignment
            WHERE Assignee.IsActive = true
          " --json > "$DATA_DIR/permission_set_assignments.json"

          echo "üìå Collecting Profile Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.ProfileId != null
          " --json > "$DATA_DIR/profile_object_permissions.json"

          echo "üìå Collecting Permission Set Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            ParentId,
            Parent.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.IsOwnedByProfile = false
          " --json > "$DATA_DIR/permset_object_permissions.json"

          echo "üìå Collecting Critical Object Access"
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.ProfileId != null
            AND SObjectType IN $CRITICAL_OBJECTS
          " --json > "$DATA_DIR/critical_object_access.json"

          echo "üìå Collecting Active Users"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Username, Name, ProfileId, Profile.Name,
            IsActive, LastLoginDate
            FROM User
            WHERE IsActive = true
            ORDER BY Profile.Name
          " --json > "$DATA_DIR/active_users.json"

          echo "üìå Collecting User Stats by Profile"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT ProfileId, Profile.Name, COUNT(Id) UserCount
            FROM User
            WHERE IsActive = true
            GROUP BY ProfileId, Profile.Name
          " --json > "$DATA_DIR/user_stats.json"

          echo "üìå Collecting Field Permissions (Critical Fields)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, ParentId, SObjectType, Field,
            PermissionsRead, PermissionsEdit
            FROM FieldPermissions
            WHERE
              (Field LIKE '%SSN%' OR
               Field LIKE '%Tax%' OR
               Field LIKE '%Salary%' OR
               Field LIKE '%Password%' OR
               Field LIKE '%Credit%')
              OR
              SObjectType IN ('Account','Contact','Lead','Opportunity','User')
            ORDER BY SObjectType, Field
          " --json > "$DATA_DIR/field_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/field_permissions.json"

          echo "üìå Collecting OWD (Via Organization Object)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT
              Name,
              AccountSharingModel,
              ContactSharingModel,
              CaseSharingModel,
              OpportunitySharingModel,
              LeadSharingModel
            FROM Organization
          " --json > "$DATA_DIR/owd_settings.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/owd_settings.json"

          echo "üìå Collecting Custom Object Sharing Model"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT DeveloperName, SharingModel
            FROM CustomObject
            WHERE DeveloperName != null
            LIMIT 200
          " --json > "$DATA_DIR/custom_object_sharing.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/custom_object_sharing.json"

          echo "üìå Creating empty sharing_rules.json"
          echo '{"result":{"records":[]}}' > "$DATA_DIR/sharing_rules.json"

          echo "‚úÖ All Salesforce data collection steps completed."

      - name: Validate Collected Data
        id: check-data
        run: |
          DATA_DIR="security-data"
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)

          echo "Profiles: $profile_count"
          echo "Permission Sets: $permset_count"
          echo "Object Permissions: $object_perms_count"

          total=$((profile_count + permset_count + object_perms_count))
          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: security-data
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    timeout-minutes: 45
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis

          # FIX 1: Improved data filtering with better null handling
          jq -s '{
            profiles: [
              .[0].result.records[]? | 
              select(type == "object" and .Id != null and .Name != null)
            ],
            community_profiles: [
              .[1].result.records[]? | 
              select(type == "object" and .Id != null)
            ],
            permission_sets: [
              .[2].result.records[]? | 
              select(type == "object" and .Id != null and .Name != null)
            ],
            assignments: [
              .[3].result.records[]? | 
              select(type == "object" and .PermissionSetId != null)
            ],
            profile_object_permissions: [
              .[4].result.records[]? | 
              select(type == "object")
            ],
            permset_object_permissions: [
              .[5].result.records[]? | 
              select(type == "object")
            ],
            critical_access: [
              .[6].result.records[]? | 
              select(type == "object")
            ],
            active_users: [
              .[7].result.records[]? | 
              select(type == "object" and .Id != null)
            ],
            user_stats: [
              .[8].result.records[]? | 
              select(type == "object" and .ProfileId != null)
            ],
            field_permissions: [
              .[9].result.records[]? | 
              select(type == "object")
            ],
            owd_settings: [
              .[10].result.records[]? | 
              select(type == "object")
            ],
            custom_object_sharing: [
              .[11].result.records[]? | 
              select(type == "object")
            ],
            sharing_rules: [
              .[12].result.records[]? | 
              select(type == "object")
            ],
          }' \
            data/profiles.json \
            data/community_profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/active_users.json \
            data/user_stats.json \
            data/field_permissions.json \
            data/owd_settings.json \
            data/custom_object_sharing.json \
            data/sharing_rules.json \
            > analysis/context.json

          # FIX 2: Improved unused permission sets detection
          jq -r '
            # Get all assigned permission set IDs
            ([.assignments[]? | .PermissionSetId | select(. != null)] | unique) as $assigned_ids
            # Get all permission sets that are not profile-owned
            | [.permission_sets[]? | select(.IsOwnedByProfile != true and .Id != null)]
            # Filter to only those not in assigned list
            | map(select(.Id as $ps_id | $assigned_ids | index($ps_id) | not))
          ' analysis/context.json > analysis/unused_permission_sets.json

          # Compute enhanced stats with ACCURATE counting
          jq --argjson unused_ps "$(cat analysis/unused_permission_sets.json)" '{
            total_profiles: (.profiles | length),
            community_profiles: (.community_profiles | length),
            total_permission_sets: (.permission_sets | length),
            total_assignments: (.assignments | length),
            unused_permission_sets: ($unused_ps | length),
            profiles_with_modify_all: ([.profiles[] | select(.PermissionsModifyAllData == true)] | length),
            profiles_with_view_all: ([.profiles[] | select(.PermissionsViewAllData == true)] | length),
            profiles_with_either_all_data_perm: ([.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | length),
            permsets_with_modify_all: ([.permission_sets[] | select(.PermissionsModifyAllData == true)] | length),
            permsets_with_view_all: ([.permission_sets[] | select(.PermissionsViewAllData == true)] | length),
            total_active_users: (.active_users | length),
            total_field_permissions: (.field_permissions | length),
            total_sharing_rules: (.sharing_rules | length)
          }' analysis/context.json > analysis/stats.json

      # FIX 1: Add data quality validation
      - name: Validate Data Quality
        run: |
          echo "=== Data Quality Check ==="
          
          echo "üìä Overprivileged Profiles Check:"
          EXPECTED=$(jq -r '.profiles_with_either_all_data_perm' analysis/stats.json)
          echo "Expected count from stats: $EXPECTED"
          
          ACTUAL=$(jq '[.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | length' analysis/context.json)
          echo "Actual count in context: $ACTUAL"
          
          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "‚ö†Ô∏è WARNING: Mismatch detected!"
            echo "Sample overprivileged profiles:"
            jq -r '[.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | .[0:3]' analysis/context.json
          else
            echo "‚úÖ Counts match"
          fi
          
          echo ""
          echo "üìä Unused Permission Sets Check:"
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          echo "Unused permission sets found: $UNUSED_COUNT"
          
          if [ "$UNUSED_COUNT" -gt 0 ]; then
            echo "Sample unused permission set:"
            jq '.[0]' analysis/unused_permission_sets.json
          fi
          
          echo ""
          echo "üìä User Stats Check:"
          jq '.user_stats | length' analysis/context.json
          echo "user stats records found"

      - name: Generate Basic Report (Non-AI)
        run: |
          cat << 'EOF' > security_analysis_report.md
          # Salesforce Security Analysis Report
          ## Executive Summary
          This report provides an overview of the security configuration in your Salesforce org.
          For detailed AI-powered analysis, see the sections below:
          EOF

          # Add basic statistics to the report
          jq -r '
            "### Statistics\n\n" +
            "- Total Profiles: \(.total_profiles)\n" +
            "- Community Profiles: \(.community_profiles)\n" +
            "- Total Permission Sets: \(.total_permission_sets)\n" +
            "- Total Assignments: \(.total_assignments)\n" +
            "- Unused Permission Sets: \(.unused_permission_sets)\n" +
            "- Profiles with ModifyAllData: \(.profiles_with_modify_all)\n" +
            "- Profiles with ViewAllData: \(.profiles_with_view_all)\n" +
            "- Profiles with either all data permission: \(.profiles_with_either_all_data_perm)\n" +
            "- Total Active Users: \(.total_active_users)\n" +
            "- Total Field Permissions Analyzed: \(.total_field_permissions)\n" +
            "- Total Sharing Rules: \(.total_sharing_rules)\n"
          ' analysis/stats.json >> security_analysis_report.md

      # FIX 2 & 4: Improved overprivileged profile analysis with better data extraction and prompting
      - name: Analyze High-Priority Risks (AI)
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          CONTEXT_JSON="analysis/context.json"
          
          # FIX 2: Extract overprivileged profiles with explicit filtering
          OVERPRIV_DATA=$(jq '{
            overpriv_profiles: [
              .profiles[] | 
              select(
                .PermissionsModifyAllData == true or 
                .PermissionsViewAllData == true
              ) |
              {
                Id: .Id,
                Name: .Name,
                PermissionsModifyAllData: .PermissionsModifyAllData,
                PermissionsViewAllData: .PermissionsViewAllData,
                PermissionsViewSetup: .PermissionsViewSetup,
                PermissionsManageUsers: .PermissionsManageUsers
              }
            ],
            user_stats: [
              .user_stats[] |
              {
                ProfileId: .ProfileId,
                ProfileName: .Profile.Name,
                UserCount: .UserCount
              }
            ],
            critical_access: [
              .critical_access[] |
              {
                ProfileId: .Parent.Profile.Id,
                ProfileName: .Parent.Profile.Name,
                SObjectType: .SObjectType,
                PermissionsDelete: .PermissionsDelete,
                PermissionsModifyAllRecords: .PermissionsModifyAllRecords
              }
            ]
          }' "$CONTEXT_JSON")
          
          OVERPRIV_COUNT=$(echo "$OVERPRIV_DATA" | jq '.overpriv_profiles | length')
          
          if [ "$OVERPRIV_COUNT" -gt 0 ]; then
            # FIX 4: Improved prompt with strict instructions
            cat <<EOF > analysis/overprivileged_profiles.prompt
          You are a Salesforce security analyst. Analyze the following JSON data about overprivileged profiles.

          STRICT REQUIREMENTS:
          1. Use ONLY the exact data from the JSON - no placeholders, no assumptions, no invented values
          2. For each profile in overpriv_profiles, cross-reference its Id with user_stats ProfileId to get UserCount
          3. If a ProfileId is not found in user_stats, write "0" for Active Users
          4. Use the exact Name field from each profile - do not invent names
          5. List ONLY profiles where PermissionsModifyAllData=true OR PermissionsViewAllData=true
          6. For critical object access, match profile Ids and list the relevant objects

          JSON DATA:
          $(echo "$OVERPRIV_DATA" | jq -c .)

          OUTPUT FORMAT (Markdown):
          ### Overprivileged Profiles

          **Total Overprivileged:** $OVERPRIV_COUNT

          | Profile Name | Profile ID | ModifyAllData | ViewAllData | Active Users | Critical Objects | Risk Level | Recommendation |
          |--------------|------------|---------------|-------------|--------------|------------------|------------|----------------|
          [One row per profile from the JSON data]

          #### Detailed Findings:
          [For each overprivileged profile, write 2-3 sentences explaining:
          - What permissions it has and why they're risky
          - How many users are assigned (from user_stats)
          - What critical objects it can access (from critical_access)
          - Specific security implications]

          #### Remediation Steps:
          1. Review each profile's actual business requirements
          2. Remove ModifyAllData and ViewAllData permissions where possible
          3. Migrate elevated permissions to specific Permission Sets
          4. Implement role-based access control for sensitive objects
          5. Audit users assigned to these profiles and reassign if appropriate
          
          REMEMBER: Only use real data from the JSON. No placeholders like "[insert count]" or "Unknown" unless the data truly doesn't exist.
          EOF
            
            ollama run "$MODEL" < analysis/overprivileged_profiles.prompt > analysis/overprivileged_profiles.md
          else
            echo "### Overprivileged Profiles" > analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            echo "‚úÖ **No overprivileged profiles found** - Excellent! No profiles have ModifyAllData or ViewAllData permissions." >> analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            echo "**Recommendation:** Maintain this security posture by regularly auditing profile permissions." >> analysis/overprivileged_profiles.md
          fi

      # FIX 3: Batch processing for unused permission sets
      - name: Analyze Unused Permission Sets (Batched)
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          UNUSED_PS_JSON="analysis/unused_permission_sets.json"
          COUNT=$(jq 'length' "$UNUSED_PS_JSON")
          
          # Initialize the output file
          echo "### Unused Permission Sets" > analysis/unused_permission_sets.md
          echo "" >> analysis/unused_permission_sets.md
          echo "**Total Unused:** $COUNT" >> analysis/unused_permission_sets.md
          echo "" >> analysis/unused_permission_sets.md
          
          if [ "$COUNT" -gt 0 ]; then
            # FIX 3: Process in batches of 20 to avoid token limits
            BATCH_SIZE=20
            
            echo "| Permission Set Name | Label | Description | ID | Recommendation |" >> analysis/unused_permission_sets.md
            echo "|---------------------|-------|-------------|-----|----------------|" >> analysis/unused_permission_sets.md
            
            for ((i=0; i<COUNT; i+=BATCH_SIZE)); do
              END=$((i + BATCH_SIZE))
              if [ $END -gt $COUNT ]; then
                END=$COUNT
              fi
              
              echo "Processing batch $((i/BATCH_SIZE + 1)): records $i to $((END-1))"
              
              BATCH=$(jq ".[$i:$END]" "$UNUSED_PS_JSON")
              
              # FIX 4: Improved batch prompt
              cat <<EOF | ollama run "$MODEL" >> analysis/unused_permission_sets.md

          List these unused Salesforce permission sets in a markdown table. 
          
          REQUIREMENTS:
          - Use the exact Name, Label, Description, and Id from the JSON
          - If Description is null, write "No description"
          - Format as a markdown table with NO header row (headers already exist)
          - Provide a brief recommendation: "Deactivate if obsolete" or "Archive for compliance" or "Review business need"
          - Do NOT add extra text before or after the table
          
          JSON DATA:
          $(echo "$BATCH" | jq -c .)
          
          OUTPUT: Markdown table rows only, no headers.
          EOF
            done
            
            echo "" >> analysis/unused_permission_sets.md
            echo "#### Analysis Summary:" >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "These permission sets have no active assignments. Consider:" >> analysis/unused_permission_sets.md
            echo "- **Deactivate** permission sets that are no longer needed" >> analysis/unused_permission_sets.md
            echo "- **Archive** permission sets required for compliance/audit" >> analysis/unused_permission_sets.md
            echo "- **Document** the business justification for keeping unassigned permission sets" >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "#### Audit Queries:" >> analysis/unused_permission_sets.md
            echo '```sql' >> analysis/unused_permission_sets.md
            echo "-- Verify no assignments exist for a specific permission set" >> analysis/unused_permission_sets.md
            echo "SELECT Id, Assignee.Name, PermissionSet.Name" >> analysis/unused_permission_sets.md
            echo "FROM PermissionSetAssignment" >> analysis/unused_permission_sets.md
            echo "WHERE PermissionSetId = 'YOUR_PERMISSION_SET_ID'" >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "-- Find all permission sets with zero assignments" >> analysis/unused_permission_sets.md
            echo "SELECT Id, Name, Label, " >> analysis/unused_permission_sets.md
            echo "       (SELECT COUNT() FROM PermissionSetAssignments) AssignmentCount" >> analysis/unused_permission_sets.md
            echo "FROM PermissionSet" >> analysis/unused_permission_sets.md
            echo "WHERE IsOwnedByProfile = false" >> analysis/unused_permission_sets.md
            echo "HAVING AssignmentCount = 0" >> analysis/unused_permission_sets.md
            echo '```' >> analysis/unused_permission_sets.md
          else
            echo "‚úÖ **No unused permission sets found** - Excellent permission set hygiene! All permission sets are actively assigned to users." >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "**Recommendation:** Continue monitoring permission set assignments quarterly to maintain this clean state." >> analysis/unused_permission_sets.md
          fi

      - name: Combine Report Sections
        run: |
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          cat analysis/overprivileged_profiles.md >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          cat analysis/unused_permission_sets.md >> security_analysis_report.md

      - name: Add Raw Data to Report
        run: |
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## Appendix: Raw Statistics" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          cat analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-report
          path: security_analysis_report.md
          retention-days: 7

      # Optional: Upload intermediate analysis files for debugging
      - name: Upload Analysis Debug Data
        uses: actions/upload-artifact@v4
        with:
          name: analysis-debug
          path: analysis/
          retention-days: 3
