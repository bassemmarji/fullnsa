name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest
      analysis_depth:
        type: choice
        description: "Analysis depth"
        options:
          - quick
          - comprehensive
        default: comprehensive

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf version

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin
          sf org list

      - name: Collect Salesforce Data
        run: |
          mkdir -p "$DATA_DIR"
          # Profiles
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, UserLicense.Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile ORDER BY Name" --json > "$DATA_DIR/profiles.json"
          # Permission Sets
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, Label, Description, IsOwnedByProfile FROM PermissionSet ORDER BY Name" --json > "$DATA_DIR/permission_sets.json"
          # Permission Set Assignments
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, AssigneeId, PermissionSetId FROM PermissionSetAssignment WHERE Assignee.IsActive = true" --json > "$DATA_DIR/permission_set_assignments.json"
          # Object Permissions (Profiles)
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.ProfileId != null" --json > "$DATA_DIR/profile_object_permissions.json"
          # Object Permissions (Permission Sets)
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, ParentId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false" --json > "$DATA_DIR/permset_object_permissions.json"
          # Critical Objects
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org $ORG_ALIAS --query "SELECT Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.ProfileId != null AND SObjectType IN $CRITICAL_OBJECTS" --json > "$DATA_DIR/critical_object_access.json"
          # Active Users
          sf data query --target-org $ORG_ALIAS --query "SELECT ProfileId, COUNT(Id) UserCount FROM User WHERE IsActive = true GROUP BY ProfileId" --json > "$DATA_DIR/user_stats.json"

      - name: Validate Collected Data
        id: check-data
        run: |
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)
          echo "Profiles: $profile_count"
          echo "Permission Sets: $permset_count"
          echo "Object Permissions: $object_perms_count"
          total=$((profile_count + permset_count + object_perms_count))
          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'

    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh -o install.sh
          chmod +x install.sh && ./install.sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH
          export PATH="$HOME/.ollama/bin:$PATH"

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis
          jq -s '{
            profiles: .[0].result.records,
            permission_sets: .[1].result.records,
            assignments: .[2].result.records,
            profile_object_permissions: .[3].result.records,
            permset_object_permissions: .[4].result.records,
            critical_access: .[5].result.records,
            user_stats: .[6].result.records
          }' \
            data/profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/user_stats.json \
            > analysis/context.json

          # Identify unused permission sets
          jq -n --slurpfile ps analysis/context.json '
            {
              unused_permission_sets: ($ps[0].permission_sets - ($ps[0].assignments | map(.PermissionSetId) ))
            }' > analysis/unused_permission_sets.json

          # Compute stats
          jq '{
            total_profiles: (.profiles | length),
            total_permission_sets: (.permission_sets | length),
            total_assignments: (.assignments | length),
            profiles_with_modify_all: ([.profiles[]? | select(.PermissionsModifyAllData == true)] | length),
            profiles_with_view_all: ([.profiles[]? | select(.PermissionsViewAllData == true)] | length)
          }' analysis/context.json > analysis/stats.json

      - name: Analyze Unused Permission Sets
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          PROMPT_FILE=analysis/unused_permission_sets.prompt
          jq -Rs '{
            prompt: "You are analyzing unused Salesforce Permission Sets.\n\nUNUSED PERMISSION SETS (JSON):\n" + . + "\n\nTASK:\nIdentify permission sets that are not assigned to any users and may safely be deactivated or removed.\n\nOUTPUT FORMAT (Markdown):\n## Unused Permission Sets Analysis\n| Permission Set | Description | Usage Notes |\n|----------------|-------------|-------------|\nAdd a concise explanation."
          }' analysis/unused_permission_sets.json > analysis/unused_permission_sets.json.request
          ollama run -f analysis/unused_permission_sets.json.request > analysis/unused_permission_sets.md

      - name: Analyze Community Profiles
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          jq -c '[.profiles[]? | select((.Name // "") | test("Community|Customer|Partner|Guest"; "i"))]' analysis/context.json > analysis/community_profiles.json
          jq -c '[.critical_access[]? | select((.["Parent.ProfileId"] // "") | IN (map(.Id) | .[]))]' analysis/context.json > analysis/community_access.json
          jq -Rs '{
            prompt: "You are analyzing Salesforce community profiles.\n\nCOMMUNITY PROFILES:\n" + . + "\n\nCRITICAL ACCESS:\n" + input + "\n\nIdentify risks and summarize in Markdown."
          }' analysis/community_profiles.json analysis/community_access.json > analysis/community_risks.json.request
          ollama run -f analysis/community_risks.json.request > analysis/community_risks.md

      - name: Generate Executive Summary
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          jq -Rs --slurpfile partial analysis/partial_report.md '{
            prompt: "You are creating a Salesforce security executive summary.\n\nSTATISTICS:\n" + input + "\n\nDETAILED FINDINGS (escaped markdown):\n" + $partial[0]
          }' analysis/stats.json > analysis/executive_summary.json.request
          ollama run -f analysis/executive_summary.json.request > analysis/executive_summary.md

      - name: Compile Final Report
        run: |
          cat analysis/executive_summary.md > security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          cat analysis/partial_report.md >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "## Appendix: Raw Statistics" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          cat analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-results
          path: |
            security_analysis_report.md
            analysis/
