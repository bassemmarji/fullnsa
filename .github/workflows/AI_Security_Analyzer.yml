name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest
      analysis_depth:
        type: choice
        description: "Analysis depth"
        options:
          - quick
          - comprehensive
        default: quick

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Comprehensive Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm install --global @salesforce/cli
          sf plugins:update
          sudo apt-get update && sudo apt-get install -y jq
          
      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin
          sf org list
          
      - name: Query Core Profile & Permission Set Data
        run: |
          mkdir -p "$DATA_DIR"
          echo "ðŸ“‹ Querying profiles..."
          sf data query --query "SELECT Id, Name, UserLicense.Name, Description, CreatedDate, LastModifiedDate FROM Profile ORDER BY Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/profiles.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/profiles.json"
          
          echo "ðŸ“‹ Querying permission sets..."
          sf data query --query "SELECT Id, Name, Description, IsOwnedByProfile, Profile.Name, Label, Type, CreatedDate, LastModifiedDate, CreatedBy.Name FROM PermissionSet ORDER BY Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/permission_sets.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permission_sets.json"
      
      - name: Query Object Permissions
        run: |
          echo "ðŸ” Querying object permissions for profiles..."
          sf data query --query "SELECT Parent.Profile.Name, Parent.ProfileId, SobjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null ORDER BY Parent.Profile.Name, SobjectType" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/profile_object_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/profile_object_permissions.json"
          
          echo "ðŸ” Querying object permissions for permission sets..."
          sf data query --query "SELECT Parent.Name, ParentId, SobjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false ORDER BY Parent.Name, SobjectType" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/permset_object_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permset_object_permissions.json"
      
      - name: Query Permission Set Assignments
        run: |
          echo "ðŸ‘¤ Querying permission set assignments..."
          sf data query --query "SELECT Assignee.Name, Assignee.Username, Assignee.Profile.Name, Assignee.IsActive, PermissionSet.Name, PermissionSet.Label, PermissionSet.Type, PermissionSet.IsCustom FROM PermissionSetAssignment WHERE PermissionSet.IsOwnedByProfile = false AND Assignee.IsActive = true ORDER BY PermissionSet.Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/permission_set_assignments.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permission_set_assignments.json"
      
      - name: Query High-Risk Objects
        run: |
          echo "âš ï¸ Identifying permissions on high-risk objects..."
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          
          sf data query --query "SELECT Parent.Profile.Name, SobjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE SobjectType IN $CRITICAL_OBJECTS AND Parent.Profile.Name != null ORDER BY SobjectType, Parent.Profile.Name" \
            --target-org "$ORG_ALIAS" --result-format json > "$DATA_DIR/critical_object_access.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/critical_object_access.json"
      
      - name: Validate Collected Data
        id: check-data
        run: |
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)
          assignments_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_set_assignments.json" 2>/dev/null || echo 0)
          critical_count=$(jq -r '.result.records | length' "$DATA_DIR/critical_object_access.json" 2>/dev/null || echo 0)
          
          echo "ðŸ“Š Data Collection Summary:"
          echo "  - Profiles: $profile_count"
          echo "  - Permission Sets: $permset_count"
          echo "  - Object Permissions: $object_perms_count"
          echo "  - Active Assignments: $assignments_count"
          echo "  - Critical Object Permissions: $critical_count"
          
          total=$((profile_count + permset_count + object_perms_count))
          
          if [ "$total" -gt 0 ]; then
            echo "âœ… Found security configuration data"
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "âŒ No security data found"
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh -o install.sh
          chmod +x install.sh && ./install.sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH
          export PATH="$HOME/.ollama/bin:$PATH"
          ollama serve &
          for i in {1..30}; do
            curl -s http://localhost:11434/api/version && break
            sleep 2
          done
          
      - name: Download Model
        run: |
          MODEL="${{ inputs.model_name }}"
          echo "ðŸ¤– Downloading Ollama model: $MODEL"
          ollama pull "$MODEL"
          ollama list
          
      - name: Prepare Analysis Context
        run: |
          echo "ðŸ“Š Preparing structured analysis context..."
          mkdir -p analysis
          
          # Profile summary with permissions
          jq -s '
            {
              profiles: [
                .[0].result.records[] as $profile |
                {
                  name: $profile.Name,
                  license: $profile.UserLicense.Name,
                  description: $profile.Description,
                  object_permissions: [
                    .[1].result.records[] |
                    select(.Parent.Profile.Name == $profile.Name) |
                    {
                      object: .SobjectType,
                      read: .PermissionsRead,
                      create: .PermissionsCreate,
                      edit: .PermissionsEdit,
                      delete: .PermissionsDelete,
                      view_all: .PermissionsViewAllRecords,
                      modify_all: .PermissionsModifyAllRecords
                    }
                  ],
                  critical_permissions: [
                    .[1].result.records[] |
                    select(.Parent.Profile.Name == $profile.Name) |
                    select(.PermissionsModifyAllRecords == true or .PermissionsViewAllRecords == true or (.PermissionsDelete == true and (.SobjectType == "User" or .SobjectType == "Profile" or .SobjectType == "PermissionSet"))) |
                    .SobjectType
                  ] | unique
                }
              ]
            }
          ' data/profiles.json data/profile_object_permissions.json > analysis/profile_analysis.json
          
          # Permission set summary with assignments
          jq -s '
            {
              permission_sets: [
                .[0].result.records[] as $ps |
                {
                  name: $ps.Name,
                  label: $ps.Label,
                  type: $ps.Type,
                  is_custom: ($ps.IsOwnedByProfile == false),
                  created_by: $ps.CreatedBy.Name,
                  description: $ps.Description,
                  has_description: ($ps.Description != null and $ps.Description != ""),
                  assigned_users: [
                    .[1].result.records[] |
                    select(.PermissionSet.Name == $ps.Name) |
                    {
                      user: .Assignee.Name,
                      username: .Assignee.Username,
                      profile: .Assignee.Profile.Name
                    }
                  ],
                  assignment_count: [
                    .[1].result.records[] |
                    select(.PermissionSet.Name == $ps.Name)
                  ] | length,
                  object_permissions: [
                    .[2].result.records[] |
                    select(.Parent.Name == $ps.Name) |
                    {
                      object: .SobjectType,
                      read: .PermissionsRead,
                      create: .PermissionsCreate,
                      edit: .PermissionsEdit,
                      delete: .PermissionsDelete,
                      view_all: .PermissionsViewAllRecords,
                      modify_all: .PermissionsModifyAllRecords
                    }
                  ],
                  critical_permissions: [
                    .[2].result.records[] |
                    select(.Parent.Name == $ps.Name) |
                    select(.PermissionsModifyAllRecords == true or .PermissionsViewAllRecords == true or .PermissionsDelete == true) |
                    {
                      object: .SobjectType,
                      modify_all: .PermissionsModifyAllRecords,
                      view_all: .PermissionsViewAllRecords,
                      delete: .PermissionsDelete
                    }
                  ]
                }
              ]
            }
          ' data/permission_sets.json data/permission_set_assignments.json data/permset_object_permissions.json > analysis/permset_analysis.json
          
          # Critical access analysis with grouped details
          jq '
            {
              critical_access: [
                .result.records[] |
                select(.PermissionsModifyAllRecords == true or .PermissionsViewAllRecords == true or (.PermissionsDelete == true and (.SobjectType == "User" or .SobjectType == "Profile" or .SobjectType == "PermissionSet"))) |
                {
                  profile: .Parent.Profile.Name,
                  object: .SobjectType,
                  modify_all: .PermissionsModifyAllRecords,
                  view_all: .PermissionsViewAllRecords,
                  delete: .PermissionsDelete
                }
              ],
              by_profile: [
                .result.records[] |
                select(.PermissionsModifyAllRecords == true or .PermissionsViewAllRecords == true) |
                {
                  profile: .Parent.Profile.Name,
                  object: .SobjectType,
                  modify_all: .PermissionsModifyAllRecords,
                  view_all: .PermissionsViewAllRecords
                }
              ] | group_by(.profile) | map({
                profile: .[0].profile,
                critical_objects: map(.object) | unique,
                has_modify_all: ([.[] | select(.modify_all == true)] | length > 0),
                has_view_all: ([.[] | select(.view_all == true)] | length > 0)
              })
            }
          ' data/critical_object_access.json > analysis/critical_access.json
          
          # Summary stats with enhanced metrics
          cat <<EOF > analysis/summary.json
          {
            "total_profiles": $(jq '.result.records | length' data/profiles.json),
            "total_permission_sets": $(jq '.result.records | length' data/permission_sets.json),
            "custom_permission_sets": $(jq '[.result.records[] | select(.IsOwnedByProfile == false)] | length' data/permission_sets.json),
            "total_active_assignments": $(jq '.result.records | length' data/permission_set_assignments.json),
            "total_object_permissions": $(jq '.result.records | length' data/profile_object_permissions.json),
            "profiles_with_critical_access": $(jq '[.by_profile[].profile] | unique | length' analysis/critical_access.json),
            "unassigned_permission_sets": $(jq -s '[.[0].result.records[] | select(.IsOwnedByProfile == false) | .Name] as $all | [.[1].result.records[].PermissionSet.Name] as $assigned | [$all[] | select(. as $ps | $assigned | index($ps) | not)] | length' data/permission_sets.json data/permission_set_assignments.json),
            "permission_sets_without_description": $(jq '[.result.records[] | select(.IsOwnedByProfile == false and (.Description == null or .Description == ""))] | length' data/permission_sets.json),
            "analysis_timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          echo "âœ… Context preparation complete"
          
      - name: Verify Data Quality
        run: |
          echo "ðŸ” DATA QUALITY VERIFICATION"
          echo ""
          echo "=== Profiles with Object Permissions ==="
          jq -r '.profiles[] | select(.object_permissions | length > 0) | "\(.name): \(.object_permissions | length) permissions, Critical: \(.critical_permissions | length)"' analysis/profile_analysis.json | head -10
          
          echo ""
          echo "=== Profiles with Critical Access ==="
          jq -r '.by_profile[] | "\(.profile): \(.critical_objects | join(", "))"' analysis/critical_access.json
          
          echo ""
          echo "=== Permission Sets with Assignments ==="
          jq -r '.permission_sets[] | select(.assignment_count > 0) | "\(.name): \(.assignment_count) users, \(.object_permissions | length) permissions"' analysis/permset_analysis.json | head -10
          
          echo ""
          echo "=== Unassigned Permission Sets ==="
          jq -r '.permission_sets[] | select(.assignment_count == 0 and .is_custom == true) | .name' analysis/permset_analysis.json | head -20
          
          echo ""
          echo "=== Summary Statistics ==="
          jq '.' analysis/summary.json
          
      - name: Run AI Security Analysis
        run: |
          REPORT_FILE="security_analysis_report.md"
          MODEL="${{ inputs.model_name }}"
          
          # Load prepared context
          summary=$(cat analysis/summary.json)
          critical_profiles=$(jq -c '.by_profile' analysis/critical_access.json)
          
          # Get top profiles with critical access
          profiles_with_critical=$(jq -c '[.profiles[] | select(.critical_permissions | length > 0)] | .[0:10]' analysis/profile_analysis.json)
          
          # Get profiles without critical access (sample)
          profiles_standard=$(jq -c '[.profiles[] | select(.critical_permissions | length == 0)] | .[0:5]' analysis/profile_analysis.json)
          
          # Get permission sets with assignments
          permsets_active=$(jq -c '[.permission_sets[] | select(.assignment_count > 0)] | .[0:15]' analysis/permset_analysis.json)
          
          # Get unassigned permission sets
          permsets_unused=$(jq -c '[.permission_sets[] | select(.assignment_count == 0 and .is_custom == true)] | .[0:20]' analysis/permset_analysis.json)
          
          cat <<EOF > prompt.txt
          You are a Salesforce security architect performing a compliance audit on a production org.
          
          CRITICAL INSTRUCTIONS:
          1. Report ONLY findings based on the actual data provided below
          2. DO NOT invent permissions, risks, or issues not present in the data
          3. If specific data is missing, state "Analysis limited by available data" instead of guessing
          4. Use EXACT profile/permission set names from the data
          5. Cite specific objects when discussing permissions (e.g., "Modify All on User, Profile")
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EXECUTIVE SUMMARY STATISTICS:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          $summary
          
          KEY METRICS TO ADDRESS IN YOUR ANALYSIS:
          - Total Permission Sets: $(echo "$summary" | jq -r '.total_permission_sets')
          - Custom Permission Sets: $(echo "$summary" | jq -r '.custom_permission_sets')
          - Unassigned Permission Sets: $(echo "$summary" | jq -r '.unassigned_permission_sets')
          - Permission Sets Without Descriptions: $(echo "$summary" | jq -r '.permission_sets_without_description')
          - Profiles with Critical Access: $(echo "$summary" | jq -r '.profiles_with_critical_access')
          - Active Assignments: $(echo "$summary" | jq -r '.total_active_assignments')
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PROFILES WITH CRITICAL ACCESS (Modify All / View All):
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          $critical_profiles
          
          DETAILED PROFILE DATA (Critical Access):
          $profiles_with_critical
          
          DETAILED PROFILE DATA (Standard Access - Sample):
          $profiles_standard
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PERMISSION SETS WITH ACTIVE ASSIGNMENTS:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          $permsets_active
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          UNASSIGNED CUSTOM PERMISSION SETS (Security Debt):
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          $permsets_unused
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          MANDATORY ANALYSIS REQUIREMENTS:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          1. CRITICAL SECURITY FINDINGS - Report ONLY if you find these in the data:
             a) If profiles_with_critical_access > 0:
                - List EACH profile name from critical_profiles
                - Specify which objects have modify_all or view_all
                - Assess if access is appropriate for the license type
             
             b) If unassigned_permission_sets > 50 OR > 30% of custom permission sets:
                - Flag as HIGH severity (security debt, attack surface)
                - List specific permission set names
             
             c) If permission_sets_without_description > 10:
                - Flag as MEDIUM severity (compliance/audit risk)
             
             d) For each active permission set:
                - Check if critical_permissions array is not empty
                - If yes, verify assignment_count is appropriate
                - Flag if high-risk permissions assigned to many users
          
          2. PROFILE RISK ASSESSMENT:
             For EACH profile in profiles_with_critical data:
             - Extract the actual critical_permissions list
             - Determine risk level:
               * HIGH: Has modify_all on User/Profile/PermissionSet
               * HIGH: Has view_all + modify_all on 3+ objects
               * MEDIUM: Has delete on User/Profile/PermissionSet
               * MEDIUM: Has view_all on sensitive objects without modify_all
               * LOW: Standard CRUD only
             - In "Critical Permissions" column, list: "Modify All: [objects]" or "View All: [objects]"
          
          3. PERMISSION SET ANALYSIS:
             For permission sets in permsets_active and permsets_unused:
             - Status should be: "Active - N users" or "UNUSED - Remove"
             - In "Critical Permissions" column, list actual objects from critical_permissions array
             - For unused sets with critical_permissions, flag as HIGH risk
             - For sets without descriptions, note in "Status" column
          
          4. COMPLIANCE ASSESSMENT:
             - Principle of Least Privilege: 
               * If unassigned_permission_sets > 30% = NON-COMPLIANT
               * If profiles have modify_all unnecessarily = NON-COMPLIANT
             - Separation of Duties:
               * Check if any profile has BOTH modify_all on User AND Profile objects
             - Audit Trail:
               * If permission_sets_without_description > 10% = NON-COMPLIANT
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          OUTPUT FORMAT (STRICT MARKDOWN):
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ## ðŸš¨ Critical Security Findings
          
          | Severity | Finding | Affected Profile/PermSet | Evidence | Recommendation |
          |----------|---------|--------------------------|----------|----------------|
          | [HIGH/MEDIUM/LOW] | [Specific issue] | [Exact name from data] | [Quote from data] | [Actionable step] |
          
          ## ðŸ“Š Profile Risk Assessment
          
          | Profile Name | License Type | Risk Level | Critical Permissions | Justification |
          |--------------|--------------|------------|---------------------|---------------|
          | [Exact name] | [From license field] | [HIGH/MEDIUM/LOW] | [List: "Modify All: User, Profile" or "View All: Account"] | [Why this risk level] |
          
          ## ðŸ” Permission Set Analysis
          
          | Permission Set | Assigned Users | Has Description | Critical Permissions | Status |
          |----------------|----------------|-----------------|---------------------|--------|
          | [Exact name] | [assignment_count] | [Yes/No] | [List specific objects or "None"] | [Active - N users / UNUSED - Remove] |
          
          ## âœ… Compliance & Best Practices
          
          | Area | Status | Finding | Recommendation |
          |------|--------|---------|----------------|
          | Least Privilege | [COMPLIANT/NON-COMPLIANT] | [Based on actual metrics] | [Specific action] |
          | Separation of Duties | [COMPLIANT/NON-COMPLIANT] | [Based on permission overlaps] | [Specific action] |
          | Audit Trail | [COMPLIANT/NON-COMPLIANT] | [Based on description coverage] | [Specific action] |
          
          ## ðŸ“ˆ Executive Summary
          
          - **Total Profiles:** $(echo "$summary" | jq -r '.total_profiles')
          - **Total Permission Sets:** $(echo "$summary" | jq -r '.total_permission_sets')
          - **Custom Permission Sets:** $(echo "$summary" | jq -r '.custom_permission_sets')
          - **Unassigned Permission Sets:** $(echo "$summary" | jq -r '.unassigned_permission_sets') ($(echo "$summary" | jq -r '(.unassigned_permission_sets / .custom_permission_sets * 100 | floor)')% of custom)
          - **Permission Sets Without Description:** $(echo "$summary" | jq -r '.permission_sets_without_description')
          - **Profiles with Elevated Access:** $(echo "$summary" | jq -r '.profiles_with_critical_access')
          - **Active Permission Set Assignments:** $(echo "$summary" | jq -r '.total_active_assignments')
          - **Analysis Model:** $MODEL
          - **Timestamp:** $(echo "$summary" | jq -r '.analysis_timestamp')
          
          ### Top Recommendations:
          1. [Most critical action based on findings]
          2. [Second priority action]
          3. [Third priority action]
          
          ---
          *Note: Analysis based on actual org data. All findings are evidence-based.*
          EOF
          
          echo "ðŸ¤– Running AI analysis with $MODEL..."
          cat prompt.txt | ollama run "$MODEL" > "$REPORT_FILE"
          echo "âœ… Analysis complete. Report saved to $REPORT_FILE"
          
      - name: Generate Quick Metrics
        run: |
          echo "ðŸ“Š Generating security metrics dashboard..."
          
          cat <<EOF > security_metrics.json
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "org_alias": "${{ github.event.inputs.org_alias }}",
            "metrics": {
              "profiles_total": $(jq '.result.records | length' data/profiles.json),
              "permission_sets_total": $(jq '.result.records | length' data/permission_sets.json),
              "permission_sets_custom": $(jq '[.result.records[] | select(.IsOwnedByProfile == false)] | length' data/permission_sets.json),
              "permission_sets_unassigned": $(jq -s '[.[0].result.records[] | select(.IsOwnedByProfile == false) | .Name] as $all_ps | [.[1].result.records[].PermissionSet.Name] as $assigned | [$all_ps[] | select(. as $ps | $assigned | index($ps) | not)] | length' data/permission_sets.json data/permission_set_assignments.json),
              "permission_sets_no_description": $(jq '[.result.records[] | select(.IsOwnedByProfile == false and (.Description == null or .Description == ""))] | length' data/permission_sets.json),
              "active_assignments": $(jq '.result.records | length' data/permission_set_assignments.json),
              "profiles_with_critical_access": $(jq '[.by_profile[].profile] | unique | length' analysis/critical_access.json),
              "critical_object_permissions": $(jq '.result.records | length' data/critical_object_access.json),
              "unassignment_rate": "$(jq -s '(.[0].permission_sets_unassigned / .[0].permission_sets_custom * 100 | floor)' <<< $(cat security_metrics.json 2>/dev/null || echo '{"permission_sets_unassigned":0,"permission_sets_custom":1}'))%"
            },
            "health_indicators": {
              "unused_permsets_health": "$(jq -s 'if .[0].permission_sets_unassigned > (.[0].permission_sets_custom * 0.5) then "CRITICAL" elif .[0].permission_sets_unassigned > (.[0].permission_sets_custom * 0.3) then "WARNING" else "GOOD" end' <<< $(cat security_metrics.json 2>/dev/null || echo '{"permission_sets_unassigned":0,"permission_sets_custom":1}'))",
              "documentation_health": "$(jq -s 'if .[0].permission_sets_no_description > (.[0].permission_sets_custom * 0.3) then "CRITICAL" elif .[0].permission_sets_no_description > (.[0].permission_sets_custom * 0.1) then "WARNING" else "GOOD" end' <<< $(cat security_metrics.json 2>/dev/null || echo '{"permission_sets_no_description":0,"permission_sets_custom":1}'))",
              "critical_access_health": "$(jq 'if .metrics.profiles_with_critical_access > 5 then "WARNING" elif .metrics.profiles_with_critical_access > 10 then "CRITICAL" else "GOOD" end' security_metrics.json 2>/dev/null || echo 'GOOD')"
            }
          }
          EOF
          
          echo "âœ… Metrics generated"
          jq '.' security_metrics.json
          
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-results
          path: |
            security_analysis_report.md
            security_metrics.json
            analysis/
          retention-days: 30

      - name: Post Analysis Summary
        run: |
          echo "## ðŸ”’ Salesforce Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Core Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Profiles:** $(jq -r '.metrics.profiles_total' security_metrics.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Permission Sets:** $(jq -r '.metrics.permission_sets_total' security_metrics.json) ($(jq -r '.metrics.permission_sets_custom' security_metrics.json) custom)" >> $GITHUB_STEP_SUMMARY
          
