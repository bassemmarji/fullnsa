name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest
      analysis_depth:
        type: choice
        description: "Analysis depth"
        options:
          - quick
          - comprehensive
        default: comprehensive

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf version

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin
          sf org list

      - name: Query Profiles
        run: |
          mkdir -p "$DATA_DIR"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, UserLicense.Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile ORDER BY Name" --json > "$DATA_DIR/profiles.json"

      - name: Query Permission Sets
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, Label, Description, IsOwnedByProfile, CreatedBy.Name, CreatedDate, LastModifiedDate FROM PermissionSet ORDER BY Name" --json > "$DATA_DIR/permission_sets.json"

      - name: Query Permission Set Assignments
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Assignee.Name, Assignee.Username, Assignee.Profile.Name, Assignee.IsActive, PermissionSet.Name, PermissionSet.Label FROM PermissionSetAssignment WHERE Assignee.IsActive = true" --json > "$DATA_DIR/permission_set_assignments.json"

      - name: Query Object Permissions (Profiles)
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Parent.Profile.Name, Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null ORDER BY Parent.Profile.Name, SObjectType" --json > "$DATA_DIR/profile_object_permissions.json"

      - name: Query Object Permissions (Permission Sets)
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Parent.Name, ParentId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false ORDER BY Parent.Name, SObjectType" --json > "$DATA_DIR/permset_object_permissions.json"

      - name: Query Critical Object Access
        run: |
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org $ORG_ALIAS --query "SELECT Parent.Profile.Name, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null AND SObjectType IN $CRITICAL_OBJECTS ORDER BY Parent.Profile.Name, SObjectType" --json > "$DATA_DIR/critical_object_access.json"

      - name: Query User Statistics
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Profile.Name, COUNT(Id) UserCount FROM User WHERE IsActive = true GROUP BY Profile.Name" --json > "$DATA_DIR/user_stats.json"

      - name: Validate Collected Data
        id: check-data
        run: |
            profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
            permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
            object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)

            echo "Profiles: $profile_count"
            echo "Permission Sets: $permset_count"
            echo "Object Permissions: $object_perms_count"

            total=$((profile_count + permset_count + object_perms_count))

            if [ "$total" -gt 0 ]; then
              echo "has_data=true" >> $GITHUB_OUTPUT
              echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
              echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
              echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
            else
              echo "has_data=false" >> $GITHUB_OUTPUT
            fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'

    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh -o install.sh
          chmod +x install.sh && ./install.sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH
          export PATH="$HOME/.ollama/bin:$PATH"

          ollama serve &
          for i in {1..40}; do
            if curl -s http://localhost:11434/api/version >/dev/null; then
              echo "Ollama ready"
              break
            fi
            sleep 2
          done

      - name: Download Model
        run: |
          MODEL="${{ inputs.model_name }}"
          ollama pull "$MODEL"

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis

          jq -s '{
            profiles: .[0].result.records,
            permission_sets: .[1].result.records,
            assignments: .[2].result.records,
            profile_object_permissions: .[3].result.records,
            permset_object_permissions: .[4].result.records,
            critical_access: .[5].result.records,
            user_stats: .[6].result.records
          }' \
            data/profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/user_stats.json \
            > analysis/context.json

          jq '{
            total_profiles: (.profiles | length),
            total_permission_sets: (.permission_sets | length),
            total_assignments: (.assignments | length),
            profiles_with_modify_all: ([.profiles[]? | select(.PermissionsModifyAllData == true)] | length),
            profiles_with_view_all: ([.profiles[]? | select(.PermissionsViewAllData == true)] | length)
          }' analysis/context.json > analysis/stats.json

      - name: Analyze Unused Permission Sets
        run: |
          MODEL="${{ inputs.model_name }}"

          PERMSETS=$(jq -c '.permission_sets' analysis/context.json)
          ASSIGNMENTS=$(jq -c '.assignments' analysis/context.json)

          cat <<EOF > prompt_unused.txt
          You are analyzing Salesforce permission sets to identify unused ones.
          
          PERMISSION SETS DATA:
          $PERMSETS
          
          ASSIGNMENTS DATA:
          $ASSIGNMENTS
          
          TASK: Identify permission sets with zero assignments.
          
          EOF
          
                    ollama run "$MODEL" < prompt_unused.txt > analysis/unused_permsets.md
                    echo "### Unused Permission Sets" >> analysis/partial_report.md
                    cat analysis/unused_permsets.md >> analysis/partial_report.md
                    echo "" >> analysis/partial_report.md
          
                - name: Analyze Profiles with Elevated Permissions
                  run: |
                    MODEL="${{ inputs.model_name }}"
          
                    PROFILES=$(jq -c '.profiles' analysis/context.json)
                    USER_STATS=$(jq -c '.user_stats' analysis/context.json)
          
                    cat <<EOF > prompt_elevated.txt
          You are analyzing Salesforce profiles for elevated permissions.
          
          PROFILES:
          $PROFILES
          
          USER STATISTICS:
          $USER_STATS
          
          Identify profiles with ModifyAllData or ViewAllData.
          
          EOF

          ollama run "$MODEL" < prompt_elevated.txt > analysis/elevated_perms.md
          echo "### Profiles with Elevated Permissions" >> analysis/partial_report.md
          cat analysis/elevated_perms.md >> analysis/partial_report.md
          echo "" >> analysis/partial_report.md

      - name: Analyze Community Profile Permissions
        run: |
          MODEL="${{ inputs.model_name }}"

          PROFILES=$(jq -c '[.profiles[]? | select((.Name // "") | test("Community|Customer|Partner|Guest"; "i"))]' analysis/context.json)
          CRITICAL_ACCESS=$(jq -c '[.critical_access[]? | select((.["Parent.Profile.Name"] // "") | test("Community|Customer|Partner|Guest"; "i"))]' analysis/context.json)

          cat <<EOF > prompt_community.txt
          You are analyzing Salesforce community profiles.
          
          COMMUNITY PROFILES:
          $PROFILES
          
          CRITICAL ACCESS:
          $CRITICAL_ACCESS
          
          Identify risks.
          
          EOF
          
                    ollama run "$MODEL" < prompt_community.txt > analysis/community_risks.md
                    echo "### Community Profile Security" >> analysis/partial_report.md
                    cat analysis/community_risks.md >> analysis/partial_report.md
                    echo "" >> analysis/partial_report.md
          
                - name: Generate Executive Summary
                  run: |
                    MODEL="${{ inputs.model_name }}"
          
                    STATS=$(jq -Rs . analysis/stats.json)
                    PARTIAL=$(jq -Rs . analysis/partial_report.md)
          
                    cat <<EOF > prompt_summary.txt
          You are creating a Salesforce security executive summary.
          
          STATISTICS:
          $STATS
          
          DETAILED FINDINGS (escaped markdown):
          $PARTIAL
          
          EOF

          ollama run "$MODEL" < prompt_summary.txt > analysis/executive_summary.md

      - name: Compile Final Report
        run: |
          cat analysis/executive_summary.md > security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          cat analysis/partial_report.md >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "## Appendix: Raw Statistics" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          cat analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-results
          path: |
            security_analysis_report.md
            analysis/

