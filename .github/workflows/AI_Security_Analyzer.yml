name: AI Security & Permissions Analyzer
on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:8b
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:8b  # Use a smaller, faster model by default

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Set a reasonable timeout for data collection
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI and jq
        run: |
          npm install --global @salesforce/cli
          sudo apt-get update && sudo apt-get install -y jq curl  
          sf version  

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias ${{ env.ORG_ALIAS }} --set-default --sfdx-url-stdin
          sf org list

      - name: Collect Salesforce Data
        env:
          ORG_ALIAS: ${{ env.ORG_ALIAS }}
        run: |
          DATA_DIR="security-data"
          mkdir -p "$DATA_DIR"

          echo "ðŸ“Œ Collecting Profiles"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData,
            PermissionsViewSetup, PermissionsManageUsers
            FROM Profile ORDER BY Name
          " --json > "$DATA_DIR/profiles.json"

          echo "ðŸ“Œ Collecting Community Profiles (Filtering by Name)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM Profile
            WHERE Name LIKE '%Community%'
            ORDER BY Name
          " --json > "$DATA_DIR/community_profiles.json"

          echo "ðŸ“Œ Collecting Permission Sets"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name, Label, Description,
            IsOwnedByProfile,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM PermissionSet ORDER BY Name
          " --json > "$DATA_DIR/permission_sets.json"

          echo "ðŸ“Œ Collecting Permission Set Assignments"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, AssigneeId, PermissionSetId,
            PermissionSet.Name,
            Assignee.Name, Assignee.Username
            FROM PermissionSetAssignment
            WHERE Assignee.IsActive = true
          " --json > "$DATA_DIR/permission_set_assignments.json"

          echo "ðŸ“Œ Collecting Profile Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.ProfileId != null
          " --json > "$DATA_DIR/profile_object_permissions.json"

          echo "ðŸ“Œ Collecting Permission Set Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            ParentId,
            Parent.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.IsOwnedByProfile = false
          " --json > "$DATA_DIR/permset_object_permissions.json"

          echo "ðŸ“Œ Collecting Critical Object Access"
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.ProfileId != null
            AND SObjectType IN $CRITICAL_OBJECTS
          " --json > "$DATA_DIR/critical_object_access.json"

          echo "ðŸ“Œ Collecting Active Users"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Username, Name, ProfileId, Profile.Name,
            IsActive, LastLoginDate
            FROM User
            WHERE IsActive = true
            ORDER BY Profile.Name
          " --json > "$DATA_DIR/active_users.json"

          echo "ðŸ“Œ Collecting User Stats by Profile"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT ProfileId, Profile.Name, COUNT(Id) UserCount
            FROM User
            WHERE IsActive = true
            GROUP BY ProfileId, Profile.Name
          " --json > "$DATA_DIR/user_stats.json"

          echo "ðŸ“Œ Collecting Field Permissions (Critical Fields)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, ParentId, SObjectType, Field,
            PermissionsRead, PermissionsEdit
            FROM FieldPermissions
            WHERE
              (Field LIKE '%SSN%' OR
               Field LIKE '%Tax%' OR
               Field LIKE '%Salary%' OR
               Field LIKE '%Password%' OR
               Field LIKE '%Credit%')
              OR
              SObjectType IN ('Account','Contact','Lead','Opportunity','User')
            ORDER BY SObjectType, Field
          " --json > "$DATA_DIR/field_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/field_permissions.json"

          echo "ðŸ“Œ Collecting OWD (Via Organization Object)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT
              Name,
              AccountSharingModel,
              ContactSharingModel,
              CaseSharingModel,
              OpportunitySharingModel,
              LeadSharingModel
            FROM Organization
          " --json > "$DATA_DIR/owd_settings.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/owd_settings.json"

          echo "ðŸ“Œ Collecting Custom Object Sharing Model"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT DeveloperName, SharingModel
            FROM CustomObject
            WHERE DeveloperName != null
            LIMIT 200
          " --json > "$DATA_DIR/custom_object_sharing.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/custom_object_sharing.json"

          echo "ðŸ“Œ Creating empty sharing_rules.json"
          echo '{"result":{"records":[]}}' > "$DATA_DIR/sharing_rules.json"

          echo "âœ… All Salesforce data collection steps completed."

      - name: Validate Collected Data
        id: check-data
        run: |
          DATA_DIR="security-data"
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)

          echo "Profiles: $profile_count"
          echo "Permission Sets: $permset_count"
          echo "Object Permissions: $object_perms_count"

          total=$((profile_count + permset_count + object_perms_count))
          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: security-data
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    timeout-minutes: 45  # Set a timeout for the analysis job
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis

          # Combine all data into context with null coalescing and filter to objects
          jq -s '{
            profiles: (.[0].result.records // [] | map(select(type == "object"))),
            community_profiles: (.[1].result.records // [] | map(select(type == "object"))),
            permission_sets: (.[2].result.records // [] | map(select(type == "object"))),
            assignments: (.[3].result.records // [] | map(select(type == "object"))),
            profile_object_permissions: (.[4].result.records // [] | map(select(type == "object"))),
            permset_object_permissions: (.[5].result.records // [] | map(select(type == "object"))),
            critical_access: (.[6].result.records // [] | map(select(type == "object"))),
            active_users: (.[7].result.records // [] | map(select(type == "object"))),
            user_stats: (.[8].result.records // [] | map(select(type == "object"))),
            field_permissions: (.[9].result.records // [] | map(select(type == "object"))),
            owd_settings: (.[10].result.records // [] | map(select(type == "object"))),
            custom_object_sharing: (.[11].result.records // [] | map(select(type == "object"))),
            sharing_rules: (.[12].result.records // [] | map(select(type == "object"))),
          }' \
            data/profiles.json \
            data/community_profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/active_users.json \
            data/user_stats.json \
            data/field_permissions.json \
            data/owd_settings.json \
            data/custom_object_sharing.json \
            data/sharing_rules.json \
            > analysis/context.json

          # Identify unused permission sets with safer logic
          jq -r '
            (.assignments // [] | map(.PermissionSetId) | map(select(type == "string")) | unique) as $assigned_ids
            | (.permission_sets // [] | map(select(has("Id") and (.Id | type == "string")))) as $all_perm_sets
            | $all_perm_sets | map(select(.Id as $ps_id | $assigned_ids | index($ps_id) | not))
          ' analysis/context.json > analysis/unused_permission_sets.json

          # Compute enhanced stats with ACCURATE counting
          jq --argjson unused_ps "$(cat analysis/unused_permission_sets.json)" '{
            total_profiles: (.profiles // [] | length),
            community_profiles: (.community_profiles // [] | length),
            total_permission_sets: (.permission_sets // [] | length),
            total_assignments: (.assignments // [] | length),
            unused_permission_sets: ($unused_ps | length),
            profiles_with_modify_all: (.profiles // [] | map(select(type == "object" and .PermissionsModifyAllData == true)) | length),
            profiles_with_view_all: (.profiles // [] | map(select(type == "object" and .PermissionsViewAllData == true)) | length),
            profiles_with_either_all_data_perm: (.profiles // [] | map(select(type == "object" and (.PermissionsModifyAllData == true or .PermissionsViewAllData == true))) | length),
            permsets_with_modify_all: (.permission_sets // [] | map(select(type == "object" and .PermissionsModifyAllData == true)) | length),
            permsets_with_view_all: (.permission_sets // [] | map(select(type == "object" and .PermissionsViewAllData == true)) | length),
            total_active_users: (.active_users // [] | length),
            total_field_permissions: (.field_permissions // [] | length),
            total_sharing_rules: (.sharing_rules // [] | length)
          }' analysis/context.json > analysis/stats.json

      - name: Generate Basic Report (Non-AI)
        run: |
          cat << 'EOF' > security_analysis_report.md
          # Salesforce Security Analysis Report
          ## Executive Summary
          This report provides an overview of the security configuration in your Salesforce org.
          For detailed AI-powered analysis, see the sections below:
          EOF

          # Add basic statistics to the report
          jq -r '
            "### Statistics\n\n" +
            "- Total Profiles: \(.total_profiles)\n" +
            "- Community Profiles: \(.community_profiles)\n" +
            "- Total Permission Sets: \(.total_permission_sets)\n" +
            "- Total Assignments: \(.total_assignments)\n" +
            "- Unused Permission Sets: \(.unused_permission_sets)\n" +
            "- Profiles with ModifyAllData: \(.profiles_with_modify_all)\n" +
            "- Profiles with ViewAllData: \(.profiles_with_view_all)\n" +
            "- Profiles with either all data permission: \(.profiles_with_either_all_data_perm)\n" +
            "- Total Active Users: \(.total_active_users)\n" +
            "- Total Field Permissions Analyzed: \(.total_field_permissions)\n" +
            "- Total Sharing Rules: \(.total_sharing_rules)\n"
          ' analysis/stats.json >> security_analysis_report.md

      - name: Analyze High-Priority Risks (AI)
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          CONTEXT_JSON="analysis/context.json"
          
          # Analyze only the most critical issues with AI
          # 1. Overprivileged profiles
          OVERPRIV_DATA=$(jq '{
            overpriv_profiles: (.profiles // [] | map(select(type == "object" and (.PermissionsModifyAllData == true or .PermissionsViewAllData == true)))),
            user_stats: (.user_stats // [] | map(select(type == "object"))),
            critical_access: (.critical_access // [] | map(select(type == "object")))
          }' "$CONTEXT_JSON")
          
          OVERPRIV_ESCAPED=$(jq -Rs . <<< "$OVERPRIV_DATA")
          
          cat <<EOF > analysis/overprivileged_profiles.prompt
          Analyzing overprivileged Salesforce Profiles.
          
          OVERPRIVILEGED DATA (JSON): $OVERPRIV_ESCAPED
          
          TASK: 
          1. List ALL profiles with ModifyAllData or ViewAllData permissions
          2. For EACH profile, show its EXACT Name (from the Name field), ID, and permission details
          3. Cross-reference with user_stats to show how many active users have each profile
          4. Show critical object permissions for these profiles
          5. Recommend specific mitigation steps (move to permission sets, implement role-based access)
          
          CRITICAL INSTRUCTIONS:
          - Use the EXACT "Name" field value from each profile object in the JSON
          - Do NOT use placeholders like "Profile 1" or "Profile 2"
          - Include both the profile Name AND Id in your output
          - If a profile name is missing, use the Id but note this
          
          OUTPUT FORMAT (Markdown):
          ### Overprivileged Profiles
          
          **Total Overprivileged:** [count]
          
          | Profile Name | Profile ID | ModifyAllData | ViewAllData | Active Users | Critical Object Access | Recommendation |
          |--------------|------------|---------------|-------------|--------------|------------------------|----------------|
          [One row per profile with EXACT names from JSON]
          
          #### Detailed Findings:
          [Paragraph describing each overprivileged profile by name with specific risks]
          
          #### Remediation Steps:
          1. [Specific steps to reduce privileges]
          EOF
          
          ollama run "$MODEL" < analysis/overprivileged_profiles.prompt > analysis/overprivileged_profiles.md

          # 2. Unused Permission Sets
          UNUSED_PS_JSON="analysis/unused_permission_sets.json"
          COUNT=$(jq 'length' "$UNUSED_PS_JSON")
          
          if [ "$COUNT" -gt 0 ]; then
            UNUSED_PS_ESCAPED=$(jq -Rs . < "$UNUSED_PS_JSON")
            
            cat <<EOF > analysis/unused_permission_sets.prompt
          Analyzing unused Salesforce Permission Sets.
          
          UNUSED PERMISSION SETS (JSON): $UNUSED_PS_ESCAPED
          
          TASK: 
          1. Create a table listing each unused permission set with its Name, Label, Description, and ID
          2. Provide specific recommendations for each (e.g., "Deactivate if no longer needed" or "Archive for compliance")
          3. Include a summary count at the top
          4. Suggest audit queries to verify these are truly unused
          
          CRITICAL: Use the EXACT Name and Label values from the JSON. Do not make up placeholder names.
          
          OUTPUT FORMAT (Markdown):
          ### Unused Permission Sets
          
          **Total Unused:** [count]
          
          | Permission Set Name | Label | Description | ID | Recommendation |
          |---------------------|-------|-------------|-----|----------------|
          [Use actual values from JSON - one row per permission set]
          
          **Audit Queries:**
          - [Specific SOQL queries to verify]
          EOF
            
            ollama run "$MODEL" < analysis/unused_permission_sets.prompt > analysis/unused_permission_sets.md
          else
            echo "### Unused Permission Sets" > analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "âœ… **No unused permission sets found** - Excellent permission set hygiene! All permission sets are actively assigned to users." >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "**Recommendation:** Continue monitoring permission set assignments quarterly to maintain this clean state." >> analysis/unused_permission_sets.md
          fi

          # Append AI-generated sections to the report
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          cat analysis/overprivileged_profiles.md >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          cat analysis/unused_permission_sets.md >> security_analysis_report.md

      - name: Add Raw Data to Report
        run: |
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## Appendix: Raw Statistics" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          cat analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-report
          path: security_analysis_report.md
          retention-days: 7
