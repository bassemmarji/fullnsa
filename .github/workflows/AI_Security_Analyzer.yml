name: AI Security & Permissions Analyzer
on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:8b
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:8b

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI and jq
        run: |
          npm install --global @salesforce/cli
          sudo apt-get update && sudo apt-get install -y jq curl  
          sf version  

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias ${{ env.ORG_ALIAS }} --set-default --sfdx-url-stdin
          sf org list

      - name: Collect Salesforce Data
        env:
          ORG_ALIAS: ${{ env.ORG_ALIAS }}
        run: |
          DATA_DIR="security-data"
          mkdir -p "$DATA_DIR"

          echo "üìå Collecting Profiles"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData,
            PermissionsViewSetup, PermissionsManageUsers
            FROM Profile ORDER BY Name
          " --json > "$DATA_DIR/profiles.json"

          echo "üìå Collecting Community Profiles (Filtering by Name)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM Profile
            WHERE Name LIKE '%Community%'
            ORDER BY Name
          " --json > "$DATA_DIR/community_profiles.json"

          echo "üìå Collecting Permission Sets"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name, Label, Description,
            IsOwnedByProfile,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM PermissionSet ORDER BY Name
          " --json > "$DATA_DIR/permission_sets.json"

          echo "üìå Collecting Permission Set Assignments"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, AssigneeId, PermissionSetId,
            PermissionSet.Name,
            Assignee.Name, Assignee.Username
            FROM PermissionSetAssignment
            WHERE Assignee.IsActive = true
          " --json > "$DATA_DIR/permission_set_assignments.json"

          echo "üìå Collecting Profile Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.ProfileId != null
          " --json > "$DATA_DIR/profile_object_permissions.json"

          echo "üìå Collecting Permission Set Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            ParentId,
            Parent.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
           WHERE (Parent.IsOwnedByProfile = false OR Parent.IsOwnedByProfile = null)
          " --json > "$DATA_DIR/permset_object_permissions.json"

          echo "üìå Collecting Critical Object Access"
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.ProfileId != null
            AND SObjectType IN $CRITICAL_OBJECTS
          " --json > "$DATA_DIR/critical_object_access.json"

          echo "üìå Collecting Active Users"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Username, Name, ProfileId, Profile.Name,
            IsActive, LastLoginDate
            FROM User
            WHERE IsActive = true
            ORDER BY Profile.Name
          " --json > "$DATA_DIR/active_users.json"

          echo "üìå Collecting User Stats by Profile"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT ProfileId, Profile.Name, COUNT(Id) UserCount
            FROM User
            WHERE IsActive = true
            GROUP BY ProfileId, Profile.Name
          " --json > "$DATA_DIR/user_stats.json"

          echo "üìå Collecting Field Permissions (Critical Fields)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, ParentId, SObjectType, Field,
            PermissionsRead, PermissionsEdit
            FROM FieldPermissions
            ORDER BY SObjectType, Field
          " --json > "$DATA_DIR/field_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/field_permissions.json"

          echo "üìå Collecting OWD (Via Organization Object)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT
              Name,
              AccountSharingModel,
              ContactSharingModel,
              CaseSharingModel,
              OpportunitySharingModel,
              LeadSharingModel
            FROM Organization
          " --json > "$DATA_DIR/owd_settings.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/owd_settings.json"

          echo "üìå Collecting Custom Object Sharing Model"
          sf data query --target-org "$ORG_ALIAS" --use-tooling-api --query "
            SELECT DeveloperName, SharingModel
            FROM CustomObject
            WHERE DeveloperName != null
            LIMIT 200
          " --json > "$DATA_DIR/custom_object_sharing.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/custom_object_sharing.json"

          echo "‚úÖ All Salesforce data collection steps completed."

      - name: Validate Collected Data
        id: check-data
        run: |
          DATA_DIR="security-data"
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)

          echo "Profiles: $profile_count"
          echo "Permission Sets: $permset_count"
          echo "Object Permissions: $object_perms_count"

          total=$((profile_count + permset_count + object_perms_count))
          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: security-data
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    timeout-minutes: 600
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis

          # Combine all data into single context
          jq -s '{
            profiles: [
              .[0].result.records[]? | 
              select(type == "object" and .Id != null and .Name != null)
            ],
            community_profiles: [
              .[1].result.records[]? | 
              select(type == "object" and .Id != null)
            ],
            permission_sets: [
              .[2].result.records[]? | 
              select(type == "object" and .Id != null and .Name != null)
            ],
            assignments: [
              .[3].result.records[]? | 
              select(type == "object" and .PermissionSetId != null)
            ],
            profile_object_permissions: [
              .[4].result.records[]? | 
              select(type == "object")
            ],
            permset_object_permissions: [
              .[5].result.records[]? | 
              select(type == "object")
            ],
            critical_access: [
              .[6].result.records[]? | 
              select(type == "object")
            ],
            active_users: [
              .[7].result.records[]? | 
              select(type == "object" and .Id != null)
            ],
            user_stats: [
              .[8].result.records[]? | 
              select(type == "object" and .ProfileId != null)
            ],
            field_permissions: [
              .[9].result.records[]? | 
              select(type == "object")
            ],
            owd_settings: [
              .[10].result.records[]? | 
              select(type == "object")
            ],
            custom_object_sharing: [
              .[11].result.records[]? | 
              select(type == "object")
            ],
          }' \
            data/profiles.json \
            data/community_profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/active_users.json \
            data/user_stats.json \
            data/field_permissions.json \
            data/owd_settings.json \
            data/custom_object_sharing.json \
            > analysis/context.json

          # Detect unused permission sets
          jq -r '
            ([.assignments[]? | .PermissionSetId | select(. != null)] | unique) as $assigned_ids
            | [.permission_sets[]? | select(.IsOwnedByProfile != true and .Id != null)]
            | map(select(.Id as $ps_id | $assigned_ids | index($ps_id) | not))
          ' analysis/context.json > analysis/unused_permission_sets.json

          # Compute enhanced stats
          jq --argjson unused_ps "$(cat analysis/unused_permission_sets.json)" '{
            total_profiles: (.profiles | length),
            community_profiles: (.community_profiles | length),
            total_permission_sets: (.permission_sets | length),
            total_assignments: (.assignments | length),
            unused_permission_sets: ($unused_ps | length),
            profiles_with_modify_all: ([.profiles[] | select(.PermissionsModifyAllData == true)] | length),
            profiles_with_view_all: ([.profiles[] | select(.PermissionsViewAllData == true)] | length),
            profiles_with_either_all_data_perm: ([.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | length),
            permsets_with_modify_all: ([.permission_sets[] | select(.PermissionsModifyAllData == true)] | length),
            permsets_with_view_all: ([.permission_sets[] | select(.PermissionsViewAllData == true)] | length),
            total_active_users: (.active_users | length),
            total_field_permissions: (.field_permissions | length)
          }' analysis/context.json > analysis/stats.json

      - name: Validate Data Quality
        run: |
          echo "=== Data Quality Check ==="
          
          echo "üìä Overprivileged Profiles Check:"
          EXPECTED=$(jq -r '.profiles_with_either_all_data_perm' analysis/stats.json)
          echo "Expected count from stats: $EXPECTED"
          
          ACTUAL=$(jq '[.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | length' analysis/context.json)
          echo "Actual count in context: $ACTUAL"
          
          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "‚ö†Ô∏è WARNING: Mismatch detected!"
            echo "Sample overprivileged profiles:"
            jq -r '[.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | .[0:3]' analysis/context.json
          else
            echo "‚úÖ Counts match"
          fi
          
          echo ""
          echo "üìä Unused Permission Sets Check:"
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          echo "Unused permission sets found: $UNUSED_COUNT"
          
          if [ "$UNUSED_COUNT" -gt 0 ]; then
            echo "Sample unused permission set:"
            jq '.[0]' analysis/unused_permission_sets.json
          fi

      - name: Generate Basic Report (Non-AI)
        run: |
          cat << 'EOF' > security_analysis_report.md
          # Salesforce Security Analysis Report
          ## Executive Summary
          This report provides an overview of the security configuration in your Salesforce org.
          For detailed AI-powered analysis, see the sections below:
          EOF

          jq -r '
            "### Statistics\n\n" +
            "- Total Profiles: \(.total_profiles)\n" +
            "- Community Profiles: \(.community_profiles)\n" +
            "- Total Permission Sets: \(.total_permission_sets)\n" +
            "- Total Assignments: \(.total_assignments)\n" +
            "- Unused Permission Sets: \(.unused_permission_sets)\n" +
            "- Profiles with ModifyAllData: \(.profiles_with_modify_all)\n" +
            "- Profiles with ViewAllData: \(.profiles_with_view_all)\n" +
            "- Profiles with either all data permission: \(.profiles_with_either_all_data_perm)\n" +
            "- Total Active Users: \(.total_active_users)\n" +
            "- Total Field Permissions Analyzed: \(.total_field_permissions)\n" 
          ' analysis/stats.json >> security_analysis_report.md

      - name: Pre-process Overprivileged Profiles Data
        run: |
          # Create enriched dataset with all joins pre-computed
          jq '
            # Extract base data
            ([.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)]) as $overpriv_profiles
            | (.user_stats) as $user_stats
            | (.critical_access) as $critical_access
            
            # Join and enrich
            | $overpriv_profiles | map(
                . as $profile
                | {
                    ProfileId: .Id,
                    ProfileName: .Name,
                    PermissionsModifyAllData: .PermissionsModifyAllData,
                    PermissionsViewAllData: .PermissionsViewAllData,
                    PermissionsViewSetup: .PermissionsViewSetup,
                    PermissionsManageUsers: .PermissionsManageUsers,
                    UserCount: (
                      ($user_stats[] | select(.ProfileId == $profile.Id) | .UserCount) // 0
                    ),
                    CriticalObjects: (
                      [$critical_access[] | 
                       select(.Parent.Profile.Id == $profile.Id) | 
                       .SObjectType] | unique | sort
                    ),
                    HighRiskPermissions: [
                      (if .PermissionsDelete == true then "Delete" else empty end),
                      (if .PermissionsModifyAllRecords == true then "Modify All" else empty end)
                    ]
                  }
              )
          ' analysis/context.json > analysis/overprivileged_enriched.json

          echo "Enriched data sample:"
          jq '.[0]' analysis/overprivileged_enriched.json

      - name: Analyze High-Priority Risks (AI)
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)
          
          if [ "$OVERPRIV_COUNT" -gt 0 ]; then
            # Generate markdown table from pre-processed data
            echo "### Overprivileged Profiles" > analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            echo "**Total Overprivileged:** $OVERPRIV_COUNT" >> analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            echo "| Profile Name | Profile ID | ModifyAllData | ViewAllData | Active Users | Critical Objects | Risk Level | Recommendation |" >> analysis/overprivileged_profiles.md
            echo "|--------------|------------|---------------|-------------|--------------|------------------|------------|----------------|" >> analysis/overprivileged_profiles.md
            
            # Generate table rows with actual data
            jq -r '.[] | 
              "| \(.ProfileName) | \(.ProfileId) | \(.PermissionsModifyAllData) | \(.PermissionsViewAllData) | \(.UserCount) | \(.CriticalObjects | join(", ")) | High | Review and restrict |"
            ' analysis/overprivileged_enriched.json >> analysis/overprivileged_profiles.md
            
            echo "" >> analysis/overprivileged_profiles.md
            echo "#### Detailed Findings:" >> analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            
            # Now ask AI for analysis only (no data generation)
            cat <<EOF | ollama run "$MODEL" >> analysis/overprivileged_profiles.md

          You are a Salesforce security analyst. The above table shows overprivileged profiles.

          Based on this data, provide:

          1. **Security Risk Analysis**: For each profile listed, write 2-3 sentences explaining:
             - Why the combination of permissions is risky
             - The blast radius (how many users are affected)
             - What critical objects they can access and why that matters
             - Specific security implications for the organization

          2. **DO NOT** create new tables or reproduce the data above
          3. **DO NOT** use placeholders like "[insert]" or "Unknown"
          4. Use the exact profile names and data from the table above

          Enriched Profile Data:
          $(cat analysis/overprivileged_enriched.json | jq -c .)

          Write your analysis now:
          EOF
            
            echo "" >> analysis/overprivileged_profiles.md
            echo "#### Remediation Steps:" >> analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            echo "1. **Audit Business Requirements**: Review each profile's actual business needs with stakeholders" >> analysis/overprivileged_profiles.md
            echo "2. **Remove Blanket Permissions**: Eliminate ModifyAllData and ViewAllData permissions where possible" >> analysis/overprivileged_profiles.md
            echo "3. **Migrate to Permission Sets**: Move elevated permissions to specific, purpose-built Permission Sets" >> analysis/overprivileged_profiles.md
            echo "4. **Implement RBAC**: Set up role-based access control for sensitive objects" >> analysis/overprivileged_profiles.md
            echo "5. **User Reassignment**: Audit users assigned to these profiles and reassign to least-privilege profiles" >> analysis/overprivileged_profiles.md
            echo "6. **Enable Field-Level Security**: Restrict access to sensitive fields even when object access is granted" >> analysis/overprivileged_profiles.md
            echo "7. **Regular Monitoring**: Schedule quarterly reviews of profile permissions and assignments" >> analysis/overprivileged_profiles.md
            
          else
            echo "### Overprivileged Profiles" > analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            echo "‚úÖ **No overprivileged profiles found** - Excellent! No profiles have ModifyAllData or ViewAllData permissions." >> analysis/overprivileged_profiles.md
            echo "" >> analysis/overprivileged_profiles.md
            echo "**Recommendation:** Maintain this security posture by regularly auditing profile permissions." >> analysis/overprivileged_profiles.md
          fi

      - name: Validate AI Output
        run: |
          echo "=== Validating AI Output for Placeholders ==="
          
          if grep -qE '\[insert|\{list of|Unknown|TODO|PLACEHOLDER' analysis/overprivileged_profiles.md; then
            echo "‚ùå ERROR: AI output contains placeholders!"
            echo "Problematic content:"
            grep -E '\[insert|\{list of|Unknown|TODO|PLACEHOLDER' analysis/overprivileged_profiles.md || true
            echo ""
            echo "‚ö†Ô∏è The AI model may not have enough context or the prompt needs adjustment."
            echo "‚ö†Ô∏è Report will still be generated but may contain incomplete analysis."
          else
            echo "‚úÖ No placeholders detected in AI output"
          fi

      - name: Pre-process Unused Permission Sets
        run: |
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          
          echo "### Unused Permission Sets" > analysis/unused_permission_sets.md
          echo "" >> analysis/unused_permission_sets.md
          echo "**Total Unused:** $UNUSED_COUNT" >> analysis/unused_permission_sets.md
          echo "" >> analysis/unused_permission_sets.md
          
          if [ "$UNUSED_COUNT" -gt 0 ]; then
            # Generate table header
            echo "| Permission Set Name | Label | Description | ID | Recommendation |" >> analysis/unused_permission_sets.md
            echo "|---------------------|-------|-------------|-----|----------------|" >> analysis/unused_permission_sets.md
            
            # Generate table rows directly with jq (with null-safe string operations)
            jq -r '.[] | 
              "| \(.Name // "Unknown") | \(.Label // "N/A") | \(if .Description then .Description else "No description" end) | \(.Id // "N/A") | \(
                if (.Name // "" | test("(?i)(test|temp|demo|sandbox)")) then "Archive or deactivate (appears temporary)"
                elif (.Description // "" | test("(?i)(deprecated|obsolete|old)")) then "Deactivate (marked obsolete)"
                elif (.Label // "" | test("(?i)(legacy|retired)")) then "Archive for compliance"
                else "Review business need before deactivation"
                end
              ) |"
            ' analysis/unused_permission_sets.json >> analysis/unused_permission_sets.md
            
            echo "" >> analysis/unused_permission_sets.md
            echo "#### Analysis Summary:" >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            
            # Get AI to provide strategic recommendations
            cat <<EOF | ollama run "${{ env.MODEL_NAME }}" >> analysis/unused_permission_sets.md

          You are a Salesforce security analyst. There are $UNUSED_COUNT unused permission sets in this org.

          Based on the data above, provide:

          1. **Strategic Recommendations** (3-4 bullet points):
             - How to prioritize which permission sets to deactivate first
             - Best practices for permission set lifecycle management
             - Governance recommendations to prevent future unused permission sets

          2. **Compliance Considerations** (2-3 bullet points):
             - When to archive vs deactivate
             - Documentation requirements
             - Audit trail best practices

          DO NOT reproduce the table data. Only provide strategic guidance.

          Write your analysis now:
          EOF
            
            echo "" >> analysis/unused_permission_sets.md
            echo "#### Audit Queries:" >> analysis/unused_permission_sets.md
            echo '```sql' >> analysis/unused_permission_sets.md
            echo "-- Verify no assignments exist for a specific permission set" >> analysis/unused_permission_sets.md
            echo "SELECT Id, Assignee.Name, PermissionSet.Name" >> analysis/unused_permission_sets.md
            echo "FROM PermissionSetAssignment" >> analysis/unused_permission_sets.md
            echo "WHERE PermissionSetId = 'YOUR_PERMISSION_SET_ID'" >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "-- Find all permission sets with zero assignments" >> analysis/unused_permission_sets.md
            echo "SELECT Id, Name, Label, " >> analysis/unused_permission_sets.md
            echo "       (SELECT COUNT() FROM PermissionSetAssignments) AssignmentCount" >> analysis/unused_permission_sets.md
            echo "FROM PermissionSet" >> analysis/unused_permission_sets.md
            echo "WHERE IsOwnedByProfile = false" >> analysis/unused_permission_sets.md
            echo "HAVING AssignmentCount = 0" >> analysis/unused_permission_sets.md
            echo '```' >> analysis/unused_permission_sets.md
          else
            echo "‚úÖ **No unused permission sets found** - Excellent permission set hygiene! All permission sets are actively assigned to users." >> analysis/unused_permission_sets.md
            echo "" >> analysis/unused_permission_sets.md
            echo "**Recommendation:** Continue monitoring permission set assignments quarterly to maintain this clean state." >> analysis/unused_permission_sets.md
          fi

      - name: Generate Additional Security Insights
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          
          echo "### Additional Security Insights" > analysis/additional_insights.md
          echo "" >> analysis/additional_insights.md
          
          # Extract key metrics for AI analysis
          STATS=$(cat analysis/stats.json)
          
          cat <<EOF | ollama run "$MODEL" >> analysis/additional_insights.md

          You are a Salesforce security consultant. Analyze these security metrics and provide insights:

          Statistics:
          $(echo "$STATS" | jq -c .)

          Context:
          - Total profiles: $(echo "$STATS" | jq -r .total_profiles)
          - Permission sets: $(echo "$STATS" | jq -r .total_permission_sets)
          - Active users: $(echo "$STATS" | jq -r .total_active_users)
          - Unused permission sets: $(echo "$STATS" | jq -r .unused_permission_sets)

          Provide:

          1. **Overall Security Posture** (2-3 sentences):
             - What's the overall health of this org's security configuration?
             - Are there any red flags in the statistics?

          2. **Comparative Analysis** (2-3 bullet points):
             - How does this compare to typical Salesforce org security patterns?
             - What percentages stand out as unusual?

          3. **Priority Actions** (Top 3):
             - What should be addressed first based on these numbers?
             - Why are these priorities critical?

          4. **Long-term Recommendations** (3-4 bullet points):
             - What governance practices should be implemented?
             - How can this org maintain good security hygiene?

          Be specific and actionable. Use the actual numbers from the statistics.
          EOF

      - name: Combine Report Sections
        run: |
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          cat analysis/overprivileged_profiles.md >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          cat analysis/unused_permission_sets.md >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          cat analysis/additional_insights.md >> security_analysis_report.md

      - name: Add Raw Data to Report
        run: |
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## Appendix: Raw Statistics" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          cat analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md
          
          echo "" >> security_analysis_report.md
          echo "## Appendix: Sample Enriched Data" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          jq '.[0:2]' analysis/overprivileged_enriched.json >> security_analysis_report.md 2>/dev/null || echo "[]" >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

      - name: Generate Executive Summary with AI
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          
          # Create a comprehensive summary for AI
          SUMMARY_DATA=$(jq -n \
            --argjson stats "$(cat analysis/stats.json)" \
            --argjson overpriv_count "$(jq 'length' analysis/overprivileged_enriched.json)" \
            --argjson unused_count "$(jq 'length' analysis/unused_permission_sets.json)" \
            '{
              stats: $stats,
              overprivileged_profiles_count: $overpriv_count,
              unused_permission_sets_count: $unused_count,
              key_metrics: {
                privilege_ratio: (($stats.profiles_with_either_all_data_perm / $stats.total_profiles) * 100 | floor),
                unused_ps_ratio: (($stats.unused_permission_sets / $stats.total_permission_sets) * 100 | floor),
                users_per_profile: ($stats.total_active_users / $stats.total_profiles | floor)
              }
            }')
          
          cat <<EOF | ollama run "$MODEL" > analysis/executive_summary.md

          You are a CISO presenting security findings to executives. Create a concise executive summary.

          Data:
          $(echo "$SUMMARY_DATA" | jq -c .)

          Write a 4-paragraph executive summary that includes:

          1. **Opening Statement** (1-2 sentences):
             - Overall security posture (Strong/Moderate/Weak)
             - One key finding

          2. **Critical Findings** (2-3 sentences):
             - Number of overprivileged profiles and their impact
             - Unused permission sets and governance gaps
             - Use actual percentages from key_metrics

          3. **Business Impact** (2-3 sentences):
             - Risk to data security and compliance
             - Potential exposure if not addressed
             - Operational efficiency concerns

          4. **Recommended Actions** (2-3 sentences):
             - Top priority action with timeline
             - Expected outcome of remediation

          Use plain business language. Avoid technical jargon. Be direct and actionable.
          EOF
          
          # Prepend executive summary to main report
          cat analysis/executive_summary.md security_analysis_report.md > temp_report.md
          mv temp_report.md security_analysis_report.md

      - name: Add Report Metadata
        run: |
          # Create header with metadata
          cat > report_header.md << EOF
          # Salesforce Security Analysis Report
          
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Org Alias:** ${{ env.ORG_ALIAS }}  
          **Analysis Model:** ${{ env.MODEL_NAME }}  
          **Report Version:** 2.0
          
          ---
          
          ## Executive Summary
          
          EOF
          
          # Combine header with report
          cat report_header.md security_analysis_report.md > final_report.md
          mv final_report.md security_analysis_report.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-report
          path: security_analysis_report.md
          retention-days: 7

      - name: Upload Analysis Debug Data
        uses: actions/upload-artifact@v4
        with:
          name: analysis-debug
          path: analysis/
          retention-days: 3

      - name: Generate Summary Comment
        run: |
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          TOTAL_PROFILES=$(jq -r '.total_profiles' analysis/stats.json)
          TOTAL_USERS=$(jq -r '.total_active_users' analysis/stats.json)
          
          cat > $GITHUB_STEP_SUMMARY << EOF
          ## üîí Salesforce Security Analysis Complete
          
          ### üìä Key Metrics
          
          | Metric | Count |
          |--------|-------|
          | Total Profiles | $TOTAL_PROFILES |
          | Active Users | $TOTAL_USERS |
          | Overprivileged Profiles | $OVERPRIV_COUNT |
          | Unused Permission Sets | $UNUSED_COUNT |
          
          ### ‚ö†Ô∏è Priority Findings
          
          EOF
          
          if [ "$OVERPRIV_COUNT" -gt 0 ]; then
            echo "- üî¥ **$OVERPRIV_COUNT overprivileged profiles** detected with ModifyAllData or ViewAllData permissions" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ No overprivileged profiles detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$UNUSED_COUNT" -gt 0 ]; then
            UNUSED_PERCENT=$(( (UNUSED_COUNT * 100) / $(jq -r '.total_permission_sets' analysis/stats.json) ))
            echo "- üü° **$UNUSED_COUNT unused permission sets** ($UNUSED_PERCENT% of total)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ All permission sets are actively assigned" >> $GITHUB_STEP_SUMMARY
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ### üìÑ Report Artifacts
          
          Download the full security analysis report from the artifacts section above.
          
          - \`security-analysis-report.md\` - Complete analysis with AI insights
          - \`analysis-debug/\` - Raw data and intermediate processing files
          
          EOF

      - name: Post-Analysis Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up temporary files..."
          rm -f analysis/*.prompt 2>/dev/null || true
          echo "‚úÖ Cleanup complete"
