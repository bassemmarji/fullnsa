name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Comprehensive Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm install --global sfdx-cli @salesforce/cli
          sf plugins:update
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > authfile.json
          sfdx force:auth:sfdxurl:store -f authfile.json -a $ORG_ALIAS -d
          sfdx config:set target-org=$ORG_ALIAS
          rm authfile.json
          sfdx org list

      - name: Query Profiles
        run: |
          mkdir -p "$DATA_DIR"
          sfdx force:data:soql:query -u $ORG_ALIAS -q "SELECT Id, Name, UserLicense.Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile ORDER BY Name" -r json > "$DATA_DIR/profiles.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/profiles.json"

      - name: Query Permission Sets
        run: |
          sfdx force:data:soql:query -u $ORG_ALIAS -q "SELECT Id, Name, Label, Description, IsOwnedByProfile, CreatedBy.Name FROM PermissionSet ORDER BY Name" -r json > "$DATA_DIR/permission_sets.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permission_sets.json"

      - name: Query Permission Set Assignments
        run: |
          sfdx force:data:soql:query -u $ORG_ALIAS -q "SELECT Id, Assignee.Name, Assignee.Username, Assignee.Profile.Name, Assignee.IsActive, PermissionSet.Name FROM PermissionSetAssignment WHERE Assignee.IsActive = true" -r json > "$DATA_DIR/permission_set_assignments.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permission_set_assignments.json"

      - name: Query Object Permissions (Profiles)
        run: |
          sfdx force:data:soql:query -u $ORG_ALIAS -q "SELECT Id, Parent.Profile.Name, Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null ORDER BY Parent.Profile.Name, SObjectType" -r json > "$DATA_DIR/profile_object_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/profile_object_permissions.json"

      - name: Query Object Permissions (Permission Sets)
        run: |
          sfdx force:data:soql:query -u $ORG_ALIAS -q "SELECT Id, Parent.Name, ParentId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false ORDER BY Parent.Name, SObjectType" -r json > "$DATA_DIR/permset_object_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/permset_object_permissions.json"

      - name: Query Critical Object Access
        run: |
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sfdx force:data:soql:query -u $ORG_ALIAS -q "SELECT Parent.Profile.Name, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Pro_
