name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest
      analysis_depth:
        type: choice
        description: "Analysis depth"
        options:
          - quick
          - comprehensive
        default: comprehensive

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf version

      - name: Authenticate to Salesforce Org
        run: |
          set -euo pipefail
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias "$ORG_ALIAS" --set-default --sfdx-url-stdin
          sf org list

      - name: Query Profiles
        run: |
          set -euo pipefail
          mkdir -p "$DATA_DIR"
          sf data query --target-org "$ORG_ALIAS" --query "SELECT Id, Name, UserLicense.Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile ORDER BY Name" --json > "$DATA_DIR/profiles.json" 2> /dev/null || jq -n '{result:{records:[]}}' > "$DATA_DIR/profiles.json"

      - name: Query Permission Sets
        run: |
          set -euo pipefail
          sf data query --target-org "$ORG_ALIAS" --query "SELECT Id, Name, Label, Description, IsOwnedByProfile, CreatedBy.Name, CreatedDate, LastModifiedDate FROM PermissionSet ORDER BY Name" --json > "$DATA_DIR/permission_sets.json" 2> /dev/null || jq -n '{result:{records:[]}}' > "$DATA_DIR/permission_sets.json"

      - name: Query Permission Set Assignments
        run: |
          set -euo pipefail
          sf data query --target-org "$ORG_ALIAS" --query "SELECT Id, Assignee.Name, Assignee.Username, Assignee.Profile.Name, Assignee.IsActive, PermissionSet.Name, PermissionSet.Label FROM PermissionSetAssignment WHERE Assignee.IsActive = true" --json > "$DATA_DIR/permission_set_assignments.json" 2> /dev/null || jq -n '{result:{records:[]}}' > "$DATA_DIR/permission_set_assignments.json"

      - name: Query Object Permissions (Profiles)
        run: |
          set -euo pipefail
          sf data query --target-org "$ORG_ALIAS" --query "SELECT Id, Parent.Profile.Name, Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null ORDER BY Parent.Profile.Name, SObjectType" --json > "$DATA_DIR/profile_object_permissions.json" 2> /dev/null || jq -n '{result:{records:[]}}' > "$DATA_DIR/profile_object_permissions.json"

      - name: Query Object Permissions (Permission Sets)
        run: |
          set -euo pipefail
          sf data query --target-org "$ORG_ALIAS" --query "SELECT Id, Parent.Name, ParentId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false ORDER BY Parent.Name, SObjectType" --json > "$DATA_DIR/permset_object_permissions.json" 2> /dev/null || jq -n '{result:{records:[]}}' > "$DATA_DIR/permset_object_permissions.json"

      - name: Query Critical Object Access
        run: |
          set -euo pipefail
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org "$ORG_ALIAS" --query "SELECT Parent.Profile.Name, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null AND SObjectType IN $CRITICAL_OBJECTS ORDER BY Parent.Profile.Name, SObjectType" --json > "$DATA_DIR/critical_object_access.json" 2> /dev/null || jq -n '{result:{records:[]}}' > "$DATA_DIR/critical_object_access.json"

      - name: Query User Statistics
        run: |
          set -euo pipefail
          sf data query --target-org "$ORG_ALIAS" --query "SELECT Profile.Name, COUNT(Id) UserCount FROM User WHERE IsActive = true GROUP BY Profile.Name" --json > "$DATA_DIR/user_stats.json" 2> /dev/null || jq -n '{result:{records:[]}}' > "$DATA_DIR/user_stats.json"

      - name: Validate Collected Data
        id: check-data
        run: |
          set -euo pipefail
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)

          echo "Profiles: $profile_count"
          echo "Permission Sets: $permset_count"
          echo "Object Permissions: $object_perms_count"

          total=$((profile_count + permset_count + object_perms_count))

          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    defaults:
      run:
        shell: bash

    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          set -euo pipefail
          curl -fsSL https://ollama.com/install.sh -o install.sh
          chmod +x install.sh && ./install.sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH
          export PATH="$HOME/.ollama/bin:$PATH"

          # start ollama in background (if install.sh configures it)
          ollama serve &>/dev/null &

          # wait for up to ~80 seconds for the local API
          for i in {1..40}; do
            if curl -s http://localhost:11434/api/version >/dev/null; then
              echo "Ollama ready"
              break
            fi
            sleep 2
          done

      - name: Download Model
        run: |
          set -euo pipefail
          MODEL="$MODEL_NAME"
          echo "Pulling model: $MODEL"
          ollama pull "$MODEL"

      - name: Prepare Analysis Context
        run: |
          set -euo pipefail
          mkdir -p analysis

          # combine raw JSON results into a single context file (null-safe)
          jq -s '{
            profiles: (.[0].result.records // []),
            permission_sets: (.[1].result.records // []),
            assignments: (.[2].result.records // []),
            profile_object_permissions: (.[3].result.records // []),
            permset_object_permissions: (.[4].result.records // []),
            critical_access: (.[5].result.records // []),
            user_stats: (.[6].result.records // [])
          }' \
            data/profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/user_stats.json \
            > analysis/context.json

          # basic stats
          jq '{
            total_profiles: (.profiles | length),
            total_permission_sets: (.permission_sets | length),
            total_assignments: (.assignments | length),
            profiles_with_modify_all: ([.profiles[]? | select(.PermissionsModifyAllData == true)] | length),
            profiles_with_view_all: ([.profiles[]? | select(.PermissionsViewAllData == true)] | length)
          }' analysis/context.json > analysis/stats.json

      - name: Analyze Unused Permission Sets
        run: |
          set -euo pipefail
          MODEL="$MODEL_NAME"

          # Compute unused permission sets by comparing permission_sets[].Name to assignments[]."PermissionSet.Name"
          UNUSED_PS=$(jq -c '
            # build array of assignment permission set names (handles nulls)
            ( [ .assignments[]? | ( .["PermissionSet.Name"] // .PermissionSet?.Name // empty ) ] ) as $assigned |
            [ .permission_sets[]? |
              # skip permission sets that are owned by profile
              select((.IsOwnedByProfile // false) == false) |
              # include permission set if its Name is not in $assigned
              select( ($assigned | index(.Name)) | not )
            ]
          ' analysis/context.json)

          # ensure we always have a JSON string (empty array when none)
          UNUSED_PS="${UNUSED_PS:-[]}"

          # Escape for safe embedding in prompt
          ESCAPED_UNUSED_PS=$(printf "%s" "$UNUSED_PS" | jq -Rs .)

          # Build safe single-string prompt (no temporary JSON files required)
          PROMPT=$(jq -Rs . <<'EOF'
          You are analyzing unused Salesforce Permission Sets.
          
          UNUSED PERMISSION SETS (JSON):
          PLACEHOLDER_UNUSED_PS
          
          TASK:
          Identify permission sets that are not assigned to any users and may safely be deactivated or removed.
          
          OUTPUT FORMAT (Markdown):
          
          ## Unused Permission Sets Analysis
          
          | Permission Set | Label | Created By | Created Date | Notes |
          |----------------|-------|------------|--------------|-------|
          Provide concise explanation for each unused permission set and a final summary count.
          EOF
          )

          # replace placeholder in PROMPT with the escaped JSON (safe string replacement)
          PROMPT=$(printf "%s" "$PROMPT" | sed "s/PLACEHOLDER_UNUSED_PS/$(printf '%s' "$ESCAPED_UNUSED_PS" | sed 's/[&/]/\\&/g')/")

          # Run Ollama in deterministic mode passing a prompt string (avoid -f JSON files)
          ollama run "$MODEL" --prompt "$PROMPT" > analysis/unused_permission_sets.md 2>/dev/null || echo "Ollama run failed for unused permission sets" > analysis/unused_permission_sets.md

          echo "### Unused Permission Sets" >> analysis/partial_report.md
          cat analysis/unused_permission_sets.md >> analysis/partial_report.md
          echo "" >> analysis/partial_report.md

      - name: Analyze Profiles with Elevated Permissions
        run: |
          set -euo pipefail
          MODEL="$MODEL_NAME"

          PROFILES_JSON=$(jq -c '.profiles' analysis/context.json)
          USER_STATS_JSON=$(jq -c '.user_stats' analysis/context.json)

          # Build safe prompt (escape embedded JSON)
          P1=$(printf "%s" "$PROFILES_JSON" | jq -Rs .)
          P2=$(printf "%s" "$USER_STATS_JSON" | jq -Rs .)

          PROMPT=$(jq -Rs . <<'EOF'
          You are analyzing Salesforce profiles for elevated permissions.
          
          PROFILES DATA (escaped JSON):
          PLACEHOLDER_PROFILES
          
          USER STATS (escaped JSON):
          PLACEHOLDER_STATS
          
          TASK: Identify profiles with PermissionsModifyAllData = true OR PermissionsViewAllData = true and include active user counts.
          
          OUTPUT FORMAT (Markdown):
          ## Profiles with Elevated Permissions
          Provide tables and recommendations.
          EOF
          )

          PROMPT=$(printf "%s" "$PROMPT" | sed "s/PLACEHOLDER_PROFILES/$(printf '%s' "$P1" | sed 's/[&/]/\\&/g')/" )
          PROMPT=$(printf "%s" "$PROMPT" | sed "s/PLACEHOLDER_STATS/$(printf '%s' "$P2" | sed 's/[&/]/\\&/g')/" )

          ollama run "$MODEL" --prompt "$PROMPT" > analysis/elevated_perms.md 2>/dev/null || echo "Ollama run failed for elevated perms" > analysis/elevated_perms.md

          echo "### Profiles with Elevated Permissions" >> analysis/partial_report.md
          cat analysis/elevated_perms.md >> analysis/partial_report.md
          echo "" >> analysis/partial_report.md

      - name: Analyze Community Profile Permissions
        run: |
          set -euo pipefail
          MODEL="$MODEL_NAME"

          # select community-like profiles (null safe)
          PROFILES=$(jq -c '[.profiles[]? | select((.Name // "") | test("Community|Customer|Partner|Guest"; "i"))]' analysis/context.json)
          CRITICAL_ACCESS=$(jq -c '[.critical_access[]? | select((.["Parent.Profile.Name"] // "") | test("Community|Customer|Partner|Guest"; "i"))]' analysis/context.json)

          # escape
          P1=$(printf "%s" "$PROFILES" | jq -Rs .)
          P2=$(printf "%s" "$CRITICAL_ACCESS" | jq -Rs .)

          PROMPT=$(jq -Rs . <<'EOF'
          You are analyzing Salesforce community profiles for security risks.
          
          COMMUNITY PROFILES (escaped JSON):
          PLACEHOLDER_COMM_PROFILES
          
          CRITICAL OBJECT ACCESS (escaped JSON):
          PLACEHOLDER_CRITICAL
          
          TASK: Identify community profiles that have high-risk access to sensitive objects (User, Profile, PermissionSet). Provide a risk assessment and recommended actions.
          
          OUTPUT (Markdown): table of findings and final summary.
          EOF
          )

          PROMPT=$(printf "%s" "$PROMPT" | sed "s/PLACEHOLDER_COMM_PROFILES/$(printf '%s' "$P1" | sed 's/[&/]/\\&/g')/" )
          PROMPT=$(printf "%s" "$PROMPT" | sed "s/PLACEHOLDER_CRITICAL/$(printf '%s' "$P2" | sed 's/[&/]/\\&/g')/" )

          ollama run "$MODEL" --prompt "$PROMPT" > analysis/community_risks.md 2>/dev/null || echo "Ollama run failed for community profiles" > analysis/community_risks.md

          echo "### Community Profile Security" >> analysis/partial_report.md
          cat analysis/community_risks.md >> analysis/partial_report.md
          echo "" >> analysis/partial_report.md

      - name: Generate Executive Summary
        run: |
          set -euo pipefail
          MODEL="$MODEL_NAME"

          # Escape statistics and partial findings safely
          STATS_ESCAPED=$(jq -Rs . analysis/stats.json)
          PARTIAL_ESCAPED=$(jq -Rs . analysis/partial_report.md)

          PROMPT=$(jq -Rs . <<'EOF'
          You are creating a Salesforce security executive summary.
          
          STATISTICS (escaped JSON):
          PLACEHOLDER_STATS
          
          DETAILED FINDINGS (escaped markdown):
          PLACEHOLDER_PARTIAL
          
          TASK: Create a concise executive summary, key metrics, risk-level justification and prioritized recommendations. Be specific and actionable. Output in Markdown.
          EOF
          )

          PROMPT=$(printf "%s" "$PROMPT" | sed "s/PLACEHOLDER_STATS/$(printf '%s' "$STATS_ESCAPED" | sed 's/[&/]/\\&/g')/" )
          PROMPT=$(printf "%s" "$PROMPT" | sed "s/PLACEHOLDER_PARTIAL/$(printf '%s' "$PARTIAL_ESCAPED" | sed 's/[&/]/\\&/g')/" )

          ollama run "$MODEL" --prompt "$PROMPT" > analysis/executive_summary.md 2>/dev/null || echo "Ollama run failed for executive summary" > analysis/executive_summary.md

      - name: Compile Final Report
        run: |
          set -euo pipefail
          cat analysis/executive_summary.md > security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          cat analysis/partial_report.md >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "## Appendix: Raw Statistics" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          cat analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-results
          path: |
            security_analysis_report.md
            analysis/
