name: Salesforce Security Audit

on:
  workflow_dispatch:

jobs:
  collect-security-metadata:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI
        run: |
          npm install --global sfdx-cli
          echo "SF_CLI_EXE=sfdx" >> $GITHUB_ENV

      - name: Authenticate to Org
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > auth.txt
          sfdx auth:sfdxurl:store -f auth.txt -a audit_org
          rm auth.txt

      # -------------------------------------------------------
      # 1️⃣ QUERY ALL METADATA REQUIRED FOR SECURITY ANALYSIS
      # -------------------------------------------------------

      - name: Query Profiles
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, Name, UserLicenseId, PermissionsModifyAllData, PermissionsViewAllData FROM Profile" \
            -r json > profiles.json

      - name: Query User Licenses
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, Name, LicenseDefinitionKey FROM UserLicense" \
            -r json > user_licenses.json

      - name: Query Permission Sets
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, Name, Label, Description, LicenseId FROM PermissionSet" \
            -r json > permission_sets.json

      - name: Query Permission Set Assignments
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, AssigneeId, PermissionSetId FROM PermissionSetAssignment" \
            -r json > permission_set_assignments.json

      - name: Query Permission Set Groups
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, DeveloperName, MasterLabel FROM PermissionSetGroup" \
            -r json > psg.json

      - name: Query Permission Set Group Components
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, ParentId, PermissionSetId FROM PermissionSetGroupComponent" \
            -r json > psg_components.json

      - name: Query Muting Permission Set Assignments
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, PermissionSetGroupId, MutingPermissionSetId FROM MutingPermissionSet" \
            -r json > muting_ps.json

      # -----------------------------
      # OBJECT-LEVEL PERMISSIONS
      # -----------------------------

      - name: Query Profile Object Permissions
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, ParentId, SObjectType, PermissionsCreate, PermissionsRead, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions" \
            -r json > object_permissions.json

      - name: Query Permission Set Object Permissions
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, ParentId, SObjectType, PermissionsCreate, PermissionsRead, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM PermissionSetObjectPermissions" \
            -r json > ps_object_permissions.json

      # -----------------------------
      # FIELD-LEVEL SECURITY (OPTIONAL)
      # -----------------------------
      - name: Query Field Permissions (optional)
        run: |
          sfdx force:data:soql:query \
            -q "SELECT Id, ParentId, Field, PermissionsRead, PermissionsEdit FROM FieldPermissions" \
            -r json > field_permissions.json

      - name: Upload metadata for LLM
        uses: actions/upload-artifact@v4
        with:
          name: security-metadata
          path: |
            profiles.json
            user_licenses.json
            permission_sets.json
            permission_set_assignments.json
            psg.json
            psg_components.json
            muting_ps.json
            object_permissions.json
            ps_object_permissions.json
            field_permissions.json

  # -------------------------------------------------------
  # 2️⃣ LLM ANALYSIS JOB (ZERO-HALLUCINATION MODE)
  # -------------------------------------------------------
  analyze-security:
    needs: collect-security-metadata
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: security-metadata

      - name: Run LLM Analysis
        id: audit
        uses: openai/openai-assistant-action@v1
        with:
          model: gpt-5.1
          reasoning: enabled
          file_globs: "profiles.json, user_licenses.json, permission_sets.json, permission_set_assignments.json, psg*.json, *object_permissions.json, field_permissions.json"
          instructions: |
            You are a Salesforce Security Architect.

            You MUST operate in ZERO-HALLUCINATION MODE:

            ❗ If data is missing, state:
            “Not available in dataset — cannot analyze.”

            ❗ You must base EVERYTHING on the provided JSON files.

            YOUR REQUIRED OUTPUT (MANDATORY):

            # 1. Unused Permission Sets
            - Permission sets with 0 assignments.

            # 2. Permission Sets with Modify-All or View-All Records
            - Determine based on ps_object_permissions.json.

            # 3. Profiles with Modify-All or View-All Data
            - From profiles.json + object_permissions.json.

            # 4. Community / External Profiles with Excess Permissions
            A profile counts as external if UserLicense.Name contains:
            - Customer Community
            - Customer Community Plus
            - Partner Community
            - Authenticated Website
            - High Volume Customer

            External profiles should NOT have:
            - Edit/Delete on internal objects
            - View-All / Modify-All on any object

            # 5. Full Object Permission Matrix Summary
            For each profile and permission set:
            - List CRUD + View-All + Modify-All for each SObject.

            # 6. Permission Set Group Expansion & Muting Analysis
            - Compute final effective access per user:
              PSGs → Permission Sets → Muting → Assignments

            # 7. High-Risk Findings (Evidence-Based Only)
            Examples:
            - Internal profiles with Modify-All on sensitive objects
            - Community profiles with Edit/Delete
            - Permission sets granting Modify-All without business context
            - Autogenerated permission sets with powerful permissions

            # 8. Recommendations (Evidence-Based Only)
            - Must directly relate to the detected findings
            - No generic governance or password advice

            # RULES
            - NO hallucinated objects, settings, or assumptions.
            - NO password policy comments.
            - NO unused user or login analysis.
            - NO security settings unless present in dataset.

      - name: Save report
        run: |
          echo "${{ steps.audit.outputs.response }}" > SECURITY_REPORT.md

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: SECURITY_REPORT
          path: SECURITY_REPORT.md
