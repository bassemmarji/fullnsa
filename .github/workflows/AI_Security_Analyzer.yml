name: AI Security & Permissions Analyzer

on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf version

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin
          sf org list

      - name: Query Profiles
        run: |
          mkdir -p "$DATA_DIR"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, UserLicense.Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile ORDER BY Name" --json > "$DATA_DIR/profiles.json"

      - name: Query Permission Sets
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, Label, Description, IsOwnedByProfile, CreatedBy.Name FROM PermissionSet ORDER BY Name" --json > "$DATA_DIR/permission_sets.json"

      - name: Query Permission Set Assignments
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Assignee.Name, Assignee.Username, Assignee.Profile.Name, Assignee.IsActive, PermissionSet.Name FROM PermissionSetAssignment WHERE Assignee.IsActive = true" --json > "$DATA_DIR/permission_set_assignments.json"

      - name: Query Object Permissions (Profiles)
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Parent.Profile.Name, Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null ORDER BY Parent.Profile.Name, SObjectType" --json > "$DATA_DIR/profile_object_permissions.json"

      - name: Query Object Permissions (Permission Sets)
        run: |
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Parent.Name, ParentId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false ORDER BY Parent.Name, SObjectType" --json > "$DATA_DIR/permset_object_permissions.json"

      - name: Query Critical Object Access
        run: |
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org $ORG_ALIAS --query "SELECT Parent.Profile.Name, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.Profile.Name != null AND SObjectType IN $CRITICAL_OBJECTS ORDER BY Parent.Profile.Name, SObjectType" --json > "$DATA_DIR/critical_object_access.json"

      - name: Validate Collected Data
        id: check-data
        run: |
            profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
            permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
            object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)
            assignments_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_set_assignments.json" 2>/dev/null || echo 0)
            critical_count=$(jq -r '.result.records | length' "$DATA_DIR/critical_object_access.json" 2>/dev/null || echo 0)
            
            echo "üìä Data Collection Summary:"
            echo "  - Profiles: $profile_count"
            echo "  - Permission Sets: $permset_count"
            echo "  - Object Permissions: $object_perms_count"
            echo "  - Active Assignments: $assignments_count"
            echo "  - Critical Object Permissions: $critical_count"
            
            total=$((profile_count + permset_count + object_perms_count))
            
            if [ "$total" -gt 0 ]; then
              echo "‚úÖ Found security configuration data"
              echo "has_data=true" >> $GITHUB_OUTPUT
              echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
              echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
              echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
            else
              echo "‚ùå No security data found"
              echo "has_data=false" >> $GITHUB_OUTPUT
            fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh -o install.sh
          chmod +x install.sh && ./install.sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH
          export PATH="$HOME/.ollama/bin:$PATH"
          ollama serve &
          for i in {1..30}; do
            curl -s http://localhost:11434/api/version && break
            sleep 2
          done

      - name: Download Model
        run: |
          MODEL="${{ inputs.model_name }}"
          ollama pull "$MODEL"

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis
          jq -s '{
            profiles: .[0].result.records,
            permission_sets: .[1].result.records,
            assignments: .[2].result.records,
            profile_object_permissions: .[3].result.records,
            permset_object_permissions: .[4].result.records,
            critical_access: .[5].result.records
          }' data/profiles.json data/permission_sets.json data/permission_set_assignments.json data/profile_object_permissions.json data/permset_object_permissions.json data/critical_object_access.json > analysis/context.json

      - name: Run AI Security Analysis
        run: |
          MODEL="${{ inputs.model_name }}"
          REPORT_FILE="security_analysis_report.md"

          cat <<EOF > prompt.txt
          You are a Salesforce Security Architect performing a COMPREHENSIVE and strictly evidence-based security audit.
          
          ‚ùå ZERO HALLUCINATION MODE: Only report findings present in the data.
          
          Data provided:
          - Profiles
          - Permission Sets
          - Permission Set Assignments
          - Profile Object Permissions
          - Permission Set Object Permissions
          - Critical Object Access
          
          Analysis required:
          1. List unused permission sets
          2. Identify profiles with Modify All / View All permissions
          3. Check community profiles for excess permissions
          4. Summarize object-level permissions per profile and permission set
          5. Generate actionable recommendations based only on actual data
          
          Output format: Markdown report with sections:
          - Executive Summary
          - Security Risks
          - Recommendations
          - Profiles with Modify-All / View-All
          - Unused Permission Sets
          - Community Profiles with Excess Permissions
          EOF

          ollama run "$MODEL" < prompt.txt > "$REPORT_FILE"

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-results
          path: |
            security_analysis_report.md
            analysis/
          retention-days: 30

      - name: Post Analysis Summary
        run: |
          echo "## üîí Salesforce Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Analysis report saved as security_analysis_report.md" >> $GITHUB_STEP_SUMMARY
