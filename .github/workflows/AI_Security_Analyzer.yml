name: AI Security & Permissions Analyzer
on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:8b
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:8b

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI and jq
        run: |
          npm install --global @salesforce/cli
          sudo apt-get update && sudo apt-get install -y jq curl
          sf version

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias ${{ env.ORG_ALIAS }} --set-default --sfdx-url-stdin
          sf org list

      - name: Collect Salesforce Data
        env:
          ORG_ALIAS: ${{ env.ORG_ALIAS }}
        run: |
          DATA_DIR="security-data"
          mkdir -p "$DATA_DIR"

          echo "ðŸ“Œ Collecting Profiles"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData,
            PermissionsViewSetup, PermissionsManageUsers
            FROM Profile ORDER BY Name
          " --json > "$DATA_DIR/profiles.json"

          echo "ðŸ“Œ Collecting Community Profiles (Filtering by Name)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM Profile
            WHERE Name LIKE '%Community%'
            ORDER BY Name
          " --json > "$DATA_DIR/community_profiles.json"

          echo "ðŸ“Œ Collecting Permission Sets"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Name, Label, Description,
            IsOwnedByProfile,
            PermissionsModifyAllData, PermissionsViewAllData
            FROM PermissionSet ORDER BY Name
          " --json > "$DATA_DIR/permission_sets.json"

          echo "ðŸ“Œ Collecting Permission Set Assignments"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, AssigneeId, PermissionSetId,
            PermissionSet.Name,
            Assignee.Name, Assignee.Username
            FROM PermissionSetAssignment
            WHERE Assignee.IsActive = true
          " --json > "$DATA_DIR/permission_set_assignments.json"

          echo "ðŸ“Œ Collecting Profile Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            Parent.Profile.Id,
            Parent.Profile.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
            WHERE Parent.ProfileId != null
          " --json > "$DATA_DIR/profile_object_permissions.json"

          echo "ðŸ“Œ Collecting Permission Set Object Permissions"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id,
            ParentId,
            Parent.Name,
            SObjectType,
            PermissionsRead, PermissionsCreate, PermissionsEdit,
            PermissionsDelete, PermissionsViewAllRecords,
            PermissionsModifyAllRecords
            FROM ObjectPermissions
           WHERE (Parent.IsOwnedByProfile = false OR Parent.IsOwnedByProfile = null)
          " --json > "$DATA_DIR/permset_object_permissions.json"

          echo "ðŸ“Œ Collecting Critical Object Access"
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org "$ORG_ALIAS" --query "
              SELECT
                Parent.Profile.Id,
                Parent.Profile.Name,
                SObjectType,
                PermissionsRead, PermissionsCreate, PermissionsEdit,
                PermissionsDelete, PermissionsViewAllRecords,
                PermissionsModifyAllRecords
              FROM ObjectPermissions
             WHERE Parent.IsOwnedByProfile = true
               AND SObjectType IN $CRITICAL_OBJECTS
          " --json > "$DATA_DIR/critical_object_access.json"

          echo "ðŸ“Œ Collecting Active Users"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, Username, Name, ProfileId, Profile.Name,
            IsActive, LastLoginDate
            FROM User
            WHERE IsActive = true
            ORDER BY Profile.Name
          " --json > "$DATA_DIR/active_users.json"

          echo "ðŸ“Œ Collecting User Stats by Profile"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT ProfileId, Profile.Name, COUNT(Id) UserCount
            FROM User
            WHERE IsActive = true
            GROUP BY ProfileId, Profile.Name
          " --json > "$DATA_DIR/user_stats.json"

          echo "ðŸ“Œ Collecting Field Permissions (Critical Fields)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT Id, ParentId, SObjectType, Field,
            PermissionsRead, PermissionsEdit
            FROM FieldPermissions
            ORDER BY SObjectType, Field
          " --json > "$DATA_DIR/field_permissions.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/field_permissions.json"

          echo "ðŸ“Œ Collecting OWD (Via Organization Object)"
          sf data query --target-org "$ORG_ALIAS" --query "
            SELECT
              Name,
              AccountSharingModel,
              ContactSharingModel,
              CaseSharingModel,
              OpportunitySharingModel,
              LeadSharingModel
            FROM Organization
          " --json > "$DATA_DIR/owd_settings.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/owd_settings.json"

          echo "ðŸ“Œ Collecting Custom Object Sharing Model"
          sf data query --target-org "$ORG_ALIAS" --use-tooling-api --query "
            SELECT DeveloperName, SharingModel
            FROM CustomObject
            WHERE DeveloperName != null
          " --json > "$DATA_DIR/custom_object_sharing.json" || echo '{"result":{"records":[]}}' > "$DATA_DIR/custom_object_sharing.json"

          echo "âœ… All Salesforce data collection steps completed."

      - name: Validate Collected Data
        id: check-data
        run: |
          DATA_DIR="security-data"
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json" 2>/dev/null || echo 0)
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json" 2>/dev/null || echo 0)
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json" 2>/dev/null || echo 0)

          echo "Profiles: $profile_count"
          echo "Permission Sets: $permset_count"
          echo "Object Permissions: $object_perms_count"

          total=$((profile_count + permset_count + object_perms_count))
          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: security-data
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    timeout-minutes: 600
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis

          # Combine all data into single context
          jq -s '{
            profiles: [
              .[0].result.records[]? |
              select(type == "object" and .Id != null and .Name != null)
            ],
            community_profiles: [
              .[1].result.records[]? |
              select(type == "object" and .Id != null)
            ],
            permission_sets: [
              .[2].result.records[]? |
              select(type == "object" and .Id != null and .Name != null)
            ],
            assignments: [
              .[3].result.records[]? |
              select(type == "object" and .PermissionSetId != null)
            ],
            profile_object_permissions: [
              .[4].result.records[]? |
              select(type == "object")
            ],
            permset_object_permissions: [
              .[5].result.records[]? |
              select(type == "object")
            ],
            critical_access: [
              .[6].result.records[]? |
              select(type == "object")
            ],
            active_users: [
              .[7].result.records[]? |
              select(type == "object" and .Id != null)
            ],
            user_stats: [
              .[8].result.records[]? |
              select(type == "object" and .ProfileId != null)
            ],
            field_permissions: [
              .[9].result.records[]? |
              select(type == "object")
            ],
            owd_settings: [
              .[10].result.records[]? |
              select(type == "object")
            ],
            custom_object_sharing: [
              .[11].result.records[]? |
              select(type == "object")
            ],
          }' \
            data/profiles.json \
            data/community_profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/active_users.json \
            data/user_stats.json \
            data/field_permissions.json \
            data/owd_settings.json \
            data/custom_object_sharing.json \
            > analysis/context.json

          # Detect unused permission sets
          jq -r '
            ([.assignments[]? | .PermissionSetId | select(. != null)] | unique) as $assigned_ids
            | [.permission_sets[]? | select(.IsOwnedByProfile != true and .Id != null)]
            | map(select(.Id as $ps_id | $assigned_ids | index($ps_id) | not))
          ' analysis/context.json > analysis/unused_permission_sets.json

          # Compute enhanced stats
          jq --argjson unused_ps "$(cat analysis/unused_permission_sets.json)" '{
            total_profiles: (.profiles | length),
            community_profiles: (.community_profiles | length),
            total_permission_sets: (.permission_sets | length),
            total_assignments: (.assignments | length),
            unused_permission_sets: ($unused_ps | length),
            profiles_with_modify_all: ([.profiles[] | select(.PermissionsModifyAllData == true)] | length),
            profiles_with_view_all: ([.profiles[] | select(.PermissionsViewAllData == true)] | length),
            profiles_with_either_all_data_perm: ([.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)] | length),
            permsets_with_modify_all: ([.permission_sets[] | select(.PermissionsModifyAllData == true)] | length),
            permsets_with_view_all: ([.permission_sets[] | select(.PermissionsViewAllData == true)] | length),
            total_active_users: (.active_users | length),
            total_field_permissions: (.field_permissions | length)
          }' analysis/context.json > analysis/stats.json

      - name: Pre-process Overprivileged Profiles Data
        run: |
         # Extract overprivileged profiles with critical object access and user counts
         jq -r '
           ([.profiles[] | select(.PermissionsModifyAllData == true or .PermissionsViewAllData == true)]) as $overpriv_profiles
           | (.critical_access) as $critical_access
           | (.user_stats | map({(.ProfileId): .UserCount}) | add) as $user_counts
           | $overpriv_profiles | map(
               . as $profile
               | {
                   ProfileId: .Id,
                   ProfileName: .Name,
                   PermissionsModifyAllData: .PermissionsModifyAllData,
                   PermissionsViewAllData: .PermissionsViewAllData,
                   PermissionsViewSetup: .PermissionsViewSetup,
                   PermissionsManageUsers: .PermissionsManageUsers,
                   UserCount: ($user_counts[.Id] // 0),
                   CriticalObjects: (
                     [$critical_access[]? |
                        select(.Parent.Profile.Id and .Parent.Profile.Id == $profile.Id) | -- Added null check
                        .SObjectType
                     ] | unique | sort
                   )
               }
           )
         ' analysis/context.json > analysis/overprivileged_enriched.json

      - name: Generate Report Structure
        run: |
          MODEL="${{ env.MODEL_NAME }}"

          # Create header with metadata
          cat > security_analysis_report.md << EOF
          # Salesforce Security Analysis Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Org Alias:** ${{ env.ORG_ALIAS }}
          **Analysis Model:** ${{ env.MODEL_NAME }}
          **Report Version:** 2.0

          ---
          EOF

          # Generate executive summary
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          TOTAL_PROFILES=$(jq -r '.total_profiles' analysis/stats.json)
          TOTAL_USERS=$(jq -r '.total_active_users' analysis/stats.json)

          cat <<EOEXEC | ollama run "$MODEL" >> security_analysis_report.md
          You are a CISO presenting security findings to executives. Create a concise executive summary based on these statistics:

          - Total Profiles: $TOTAL_PROFILES
          - Total Users: $TOTAL_USERS
          - Overprivileged Profiles: $OVERPRIV_COUNT
          - Unused Permission Sets: $UNUSED_COUNT

          Write a 4-paragraph executive summary that includes:
          1. **Opening Statement**: Overall security posture
          2. **Critical Findings**: Number of overprivileged profiles and unused permission sets
          3. **Business Impact**: Risk to data security and compliance
          4. **Recommended Actions**: Top priority action with expected outcome

          Use plain business language, be direct and actionable.
          EOEXEC

          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md

      - name: Analyze High-Priority Risks (AI)
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)

          if [ "$OVERPRIV_COUNT" -gt 0 ]; then
            echo "## Overprivileged Profiles" >> security_analysis_report.md
            echo "" >> security_analysis_report.md
            echo "**Total Overprivileged:** $OVERPRIV_COUNT" >> security_analysis_report.md
            echo "" >> security_analysis_report.md

            # Generate profile details
            jq -r '.[] |
              "### \(.ProfileName)\n\n" +
              "- **Profile ID**: `\(.ProfileId)`\n" +
              "- **Active Users**: \(.UserCount)\n" +
              "- **Permissions**:\n" +
              " - Modify All Data: \(.PermissionsModifyAllData)\n" +
              " - View All Data: \(.PermissionsViewAllData)\n" +
              " - View Setup: \(.PermissionsViewSetup)\n" +
              " - Manage Users: \(.PermissionsManageUsers)\n\n" +
              "- **Critical Objects Access**: \n" +
              "  - " + (.CriticalObjects | join("\n  - ")) + "\n\n"
            ' analysis/overprivileged_enriched.json >> security_analysis_report.md

            # AI analysis for each profile
            cat <<-EOOVRPRIV | ollama run "$MODEL" >> security_analysis_report.md
          	You are a Salesforce security analyst. Review these overprivileged profiles:

          	$(jq -c '.' analysis/overprivileged_enriched.json)

          	For EACH profile, provide:
          	1. **Risk Assessment**: Why this combination of permissions is dangerous
          	2. **Impact**: Based on user count and critical object access
          	3. **Priority**: High/Critical with remediation recommendation

          	Use specific profile names and user counts from the data provided.
          	EOOVRPRIV
          fi

      - name: Analyze Unused Permission Sets
        run: |
          MODEL="${{ env.MODEL_NAME }}"
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)

          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## Unused Permission Sets" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "**Total Unused:** $UNUSED_COUNT" >> security_analysis_report.md
          echo "" >> security_analysis_report.md

          if [ "$UNUSED_COUNT" -gt 0 ]; then
            # Generate table for unused permission sets
            echo "| Permission Set Name | Label | Description | ID | Recommendation |" >> security_analysis_report.md
            echo "|---------------------|-------|-------------|-----|----------------|" >> security_analysis_report.md

            jq -r '.[] |
              "| \(.Name // "Unknown") | \(.Label // "N/A") | \(if .Description then .Description else "No description" end) | \(.Id // "N/A") | \(
                if (.Name // "" | test("(?i)(test|temp|demo|sandbox)")) then "Archive or deactivate (appears temporary)"
                elif (.Description // "" | test("(?i)(deprecated|obsolete|old)")) then "Deactivate (marked obsolete)"
                elif (.Label // "" | test("(?i)(legacy|retired)")) then "Archive for compliance"
                else "Review business need before deactivation"
                end
              ) |"
            ' analysis/unused_permission_sets.json >> security_analysis_report.md

            echo "" >> security_analysis_report.md

            # Get AI to provide strategic recommendations
            cat <<EOUNUSED | ollama run "${{ env.MODEL_NAME }}" >> security_analysis_report.md
          There are $UNUSED_COUNT unused permission sets in this org.
          Provide strategic recommendations for:
          1. Prioritization for deactivation
          2. Best practices for lifecycle management
          3. Compliance considerations

          Write your analysis now:
          EOUNUSED
          else
            echo "âœ… **No unused permission sets found** - Excellent permission set hygiene!" >> security_analysis_report.md
            echo "" >> security_analysis_report.md
            echo "**Recommendation:** Continue monitoring permission set assignments quarterly to maintain this clean state." >> security_analysis_report.md
          fi

      - name: Generate Additional Security Insights
        run: |
          MODEL="${{ env.MODEL_NAME }}"

          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## Additional Security Insights" >> security_analysis_report.md
          echo "" >> security_analysis_report.md

          # Get AI to analyze overall security posture
          cat <<EOINSIGHTS | ollama run "$MODEL" >> security_analysis_report.md
          You are a Salesforce security consultant. Based on these statistics:
          $(cat analysis/stats.json | jq -c .)

          Provide:
          1. **Overall Security Posture**: Health of the org's security configuration
          2. **Priority Actions**: Top 3 actions based on these numbers
          3. **Long-term Recommendations**: Governance practices for good security hygiene

          Be specific and actionable. Use the actual numbers from the statistics.
          EOINSIGHTS

      - name: Add Raw Data to Report
        run: |
          echo "" >> security_analysis_report.md
          echo "---" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo "## Appendix: Raw Statistics" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          cat analysis/stats.json >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

          echo "" >> security_analysis_report.md
          echo "## Appendix: Sample Enriched Data" >> security_analysis_report.md
          echo "" >> security_analysis_report.md
          echo '```json' >> security_analysis_report.md
          jq '.[0:2]' analysis/overprivileged_enriched.json >> security_analysis_report.md 2>/dev/null || echo "[]" >> security_analysis_report.md
          echo '```' >> security_analysis_report.md

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-report
          path: security_analysis_report.md
          retention-days: 7

      - name: Upload Analysis Debug Data
        uses: actions/upload-artifact@v4
        with:
          name: analysis-debug
          path: analysis/
          retention-days: 3

      - name: Generate Summary Comment
        run: |
          OVERPRIV_COUNT=$(jq 'length' analysis/overprivileged_enriched.json)
          UNUSED_COUNT=$(jq 'length' analysis/unused_permission_sets.json)
          TOTAL_PROFILES=$(jq -r '.total_profiles' analysis/stats.json)
          TOTAL_USERS=$(jq -r '.total_active_users' analysis/stats.json)

          cat > $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”’ Salesforce Security Analysis Complete

          ### ðŸ“Š Key Metrics

          | Metric | Count |
          |--------|-------|
          | Total Profiles | $TOTAL_PROFILES |
          | Active Users | $TOTAL_USERS |
          | Overprivileged Profiles | $OVERPRIV_COUNT |
          | Unused Permission Sets | $UNUSED_COUNT |

          ### âš ï¸ Priority Findings

          EOF

          if [ "$OVERPRIV_COUNT" -gt 0 ]; then
            echo "- ðŸ”´ **$OVERPRIV_COUNT overprivileged profiles** detected with ModifyAllData or ViewAllData permissions" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… No overprivileged profiles detected" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$UNUSED_COUNT" -gt 0 ]; then
            UNUSED_PERCENT=$(( (UNUSED_COUNT * 100) / $(jq -r '.total_permission_sets' analysis/stats.json) ))
            echo "- ðŸŸ¡ **$UNUSED_COUNT unused permission sets** ($UNUSED_PERCENT% of total)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… All permission sets are actively assigned" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF

          ### ðŸ“„ Report Artifacts

          Download the full security analysis report from the artifacts section above.

          - \`security-analysis-report.md\` - Complete analysis with AI insights
          - \`analysis-debug/\` - Raw data and intermediate processing files

          EOF
