name: AI Security & Permissions Analyzer
on:
  workflow_dispatch:
    inputs:
      org_alias:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      model_name:
        type: choice
        description: "Ollama model to use"
        options:
          - llama3:latest
          - gemma2:27b
          - mistral-large
        default: llama3:latest

env:
  ORG_ALIAS: ${{ github.event.inputs.org_alias }}
  MODEL_NAME: ${{ github.event.inputs.model_name }}
  NODE_VERSION: "20"
  DATA_DIR: "security-data"

jobs:
  collect-security-data:
    name: Collect Salesforce Security Data
    runs-on: ubuntu-latest
    outputs:
      has_data: ${{ steps.check-data.outputs.has_data }}
      profile_count: ${{ steps.check-data.outputs.profile_count }}
      permset_count: ${{ steps.check-data.outputs.permset_count }}
      object_perms_count: ${{ steps.check-data.outputs.object_perms_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf version

      - name: Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin

      - name: Collect Salesforce Data
        run: |
          mkdir -p "$DATA_DIR"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, UserLicense.Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile ORDER BY Name" --json > "$DATA_DIR/profiles.json"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, UserLicense.Name, PermissionsModifyAllData, PermissionsViewAllData FROM Profile WHERE UserLicense.Name LIKE '%Community%' ORDER BY Name" --json > "$DATA_DIR/community_profiles.json"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Name, Label, Description, IsOwnedByProfile FROM PermissionSet ORDER BY Name" --json > "$DATA_DIR/permission_sets.json"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, AssigneeId, PermissionSetId FROM PermissionSetAssignment WHERE Assignee.IsActive = true" --json > "$DATA_DIR/permission_set_assignments.json"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.ProfileId != null" --json > "$DATA_DIR/profile_object_permissions.json"
          sf data query --target-org $ORG_ALIAS --query "SELECT Id, ParentId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.IsOwnedByProfile = false" --json > "$DATA_DIR/permset_object_permissions.json"
          CRITICAL_OBJECTS="('Account','Contact','Lead','Opportunity','User','Profile','PermissionSet','PermissionSetAssignment','PermissionSetGroup')"
          sf data query --target-org $ORG_ALIAS --query "SELECT Parent.ProfileId, SObjectType, PermissionsRead, PermissionsCreate, PermissionsEdit, PermissionsDelete, PermissionsViewAllRecords, PermissionsModifyAllRecords FROM ObjectPermissions WHERE Parent.ProfileId != null AND SObjectType IN $CRITICAL_OBJECTS" --json > "$DATA_DIR/critical_object_access.json"
          sf data query --target-org $ORG_ALIAS --query "SELECT ProfileId, COUNT(Id) UserCount FROM User WHERE IsActive = true GROUP BY ProfileId" --json > "$DATA_DIR/user_stats.json"

      - name: Validate Collected Data
        id: check-data
        run: |
          profile_count=$(jq -r '.result.records | length' "$DATA_DIR/profiles.json")
          permset_count=$(jq -r '.result.records | length' "$DATA_DIR/permission_sets.json")
          object_perms_count=$(jq -r '.result.records | length' "$DATA_DIR/profile_object_permissions.json")

          total=$((profile_count + permset_count + object_perms_count))

          if [ "$total" -gt 0 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "profile_count=$profile_count" >> $GITHUB_OUTPUT
            echo "permset_count=$permset_count" >> $GITHUB_OUTPUT
            echo "object_perms_count=$object_perms_count" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Data
        uses: actions/upload-artifact@v4
        with:
          name: security-data
          path: ${{ env.DATA_DIR }}
          retention-days: 7

  analyze-security-config:
    name: AI-Powered Security Analysis
    runs-on: ubuntu-latest
    needs: collect-security-data
    if: needs.collect-security-data.outputs.has_data == 'true'
    steps:
      - name: Download Security Artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-data
          path: data

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          echo "$HOME/.ollama/bin" >> $GITHUB_PATH

      - name: Prepare Analysis Context
        run: |
          mkdir -p analysis

          jq -s '
            {
              profiles:                  (. [0].result.records // [] | map(select(type=="object"))),
              community_profiles:        (. [1].result.records // [] | map(select(type=="object"))),
              permission_sets:           (. [2].result.records // [] | map(select(type=="object"))),
              assignments:               (. [3].result.records // [] | map(select(type=="object"))),
              profile_object_permissions:(. [4].result.records // [] | map(select(type=="object"))),
              permset_object_permissions:(. [5].result.records // [] | map(select(type=="object"))),
              critical_access:           (. [6].result.records // [] | map(select(type=="object"))),
              user_stats:                (. [7].result.records // [] | map(select(type=="object")))
            }
          ' \
            data/profiles.json \
            data/community_profiles.json \
            data/permission_sets.json \
            data/permission_set_assignments.json \
            data/profile_object_permissions.json \
            data/permset_object_permissions.json \
            data/critical_object_access.json \
            data/user_stats.json \
            > analysis/context.json

          # FIXED — Safe indexing using local variables
          jq '
            (.permission_sets // []) as $ps |
            (.assignments // [] | map(.PermissionSetId)) as $assigned |
            {
              unused_permission_sets:
                ($ps | map(select(.Id as $id | $assigned | index($id) | not)))
            }
          ' analysis/context.json > analysis/unused_permission_sets.json

          jq '
            (.permission_sets // []) as $ps |
            (.assignments // [] | map(.PermissionSetId)) as $assigned |
            {
              total_profiles: (.profiles // [] | length),
              community_profiles: (.community_profiles // [] | length),
              total_permission_sets: (.permission_sets // [] | length),
              total_assignments: (.assignments // [] | length),
              unused_permission_sets: ($ps | map(select(.Id as $id | $assigned | index($id) | not)) | length),
              profiles_with_modify_all: (.profiles | map(select(.PermissionsModifyAllData==true)) | length),
              profiles_with_view_all: (.profiles | map(select(.PermissionsViewAllData==true)) | length)
            }
          ' analysis/context.json > analysis/stats.json

      - name: Initialize Partial Report
        run: |
          echo "# Detailed Security Findings" > analysis/partial_report.md
          echo "" >> analysis/partial_report.md

      # (All later analysis steps remain unchanged — only jq fixes required)
      # They are omitted for brevity but remain identical to your original pipeline.

