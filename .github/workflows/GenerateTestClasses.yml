name: Generate Apex Tests with Ollama (DeepSeek)

on:
  workflow_dispatch:
    inputs:
      ORG_ALIAS:
        type: string
        description: "Alias for the Salesforce org"
        required: true
        default: "orgAlias"

env:
  ORG_ALIAS: ${{ github.event.inputs.ORG_ALIAS }}

jobs:
  generate_test_classes:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ‚ö° Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: üîÑ Verify Salesforce CLI
        run: |
          npm update --global @salesforce/cli
          sf plugins:update
          sf --version

      - name: üß† Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /dev/null 2>&1 &

      - name: ‚è≥ Pull DeepSeek Model (6.7B)
        run: ollama pull deepseek-coder:6.7b

      - name: üîê Authenticate to Salesforce Org
        run: echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin

      - name: ‚úÖ Validate Org Authentication
        run: sf org list

      - name: üì¶ Retrieve Org Metadata
        run: |
          sf project generate --name "org-metadata" --manifest

          if [ -f "./config/package.xml" ]; then
            echo "Found custom package.xml"
            cp ./config/package.xml ./org-metadata/manifest
          fi

          cd ./org-metadata
          sf project retrieve start --target-org $ORG_ALIAS --manifest manifest/package.xml

      - name: üîç Find Up to 3 Apex Classes Without Tests
        id: find_missing
        run: |
          SRC_DIR="$GITHUB_WORKSPACE/org-metadata/force-app/main/default/classes"
          MISSING=""
          COUNT=0
      
          for FILE in $(find "$SRC_DIR" -name '*.cls' ! -name '*Test.cls' | sort); do
            CLASS=$(basename "$FILE" .cls)
            TEST_FILE="$SRC_DIR/${CLASS}Test.cls"
            if [ ! -f "$TEST_FILE" ]; then
              echo "Missing test for: $CLASS"
              MISSING="$MISSING $CLASS"
              COUNT=$((COUNT+1))
            fi
      
            if [ "$COUNT" -ge 3 ]; then
              break
            fi
          done
      
          echo "Selected classes: $MISSING"
          echo "classes=$MISSING" >> $GITHUB_OUTPUT

      - name: ‚úçÔ∏è Generate Test Classes Using Ollama
        if: ${{ steps.find_missing.outputs.classes != '' }}
        shell: bash
        run: |
          SRC_DIR="$GITHUB_WORKSPACE/org-metadata/force-app/main/default/classes"
      
          for CLASS in ${{ steps.find_missing.outputs.classes }}; do
            echo "Generating test class for: $CLASS"
      
            PROMPT="Write a Salesforce Apex test class named ${CLASS}Test for class ${CLASS}.cls using @isTest."
      
            # Use sed to remove spinner characters from the output
            RESPONSE=$(echo "$PROMPT" | ollama run deepseek-coder:6.7b | sed 's/[^[:print:]\t]//g')
      
            echo "$RESPONSE" > "$SRC_DIR/${CLASS}Test.cls"
      
            echo '<?xml version="1.0" encoding="UTF-8"?>' > "$SRC_DIR/${CLASS}Test.cls-meta.xml"
            echo '<ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">' >> "$SRC_DIR/${CLASS}Test.cls-meta.xml"
            echo '    <apiVersion>59.0</apiVersion>' >> "$SRC_DIR/${CLASS}Test.cls-meta.xml"
            echo '    <status>Active</status>' >> "$SRC_DIR/${CLASS}Test.cls-meta.xml"
            echo '</ApexClass>' >> "$SRC_DIR/${CLASS}Test.cls-meta.xml"
      
            echo "‚úÖ Test class for $CLASS created."
          done

      - name: üß™ Run Apex Unit Tests for Generated Classes Only
        if: ${{ steps.find_missing.outputs.classes != '' }}
        run: |
          ORG_ALIAS=${{ env.ORG_ALIAS }}
          SRC_DIR="$GITHUB_WORKSPACE/org-metadata/force-app/main/default/classes"
          
          # Extract test class names (append 'Test' to each)
          TEST_CLASSES=""
          for CLASS in ${{ steps.find_missing.outputs.classes }}; do
            TEST_CLASSES="$TEST_CLASSES ${CLASS}Test"
          done
      
          echo "üîç Running Apex tests for: $TEST_CLASSES"
      
          # Run Apex tests only for those classes
          sf apex test run \
            --target-org "$ORG_ALIAS" \
            --tests "$TEST_CLASSES" \
            --code-coverage \
            --result-format human \
            --wait 10 \
            --output-dir ./test-results
      
          # Display and summarize results
          echo '## Apex Test Results (Selected)' >> $GITHUB_STEP_SUMMARY
          cat ./test-results/test-result.txt >> $GITHUB_STEP_SUMMARY

      - name: üì§ Commit and Push Only Generated Test Classes
        if: ${{ steps.find_missing.outputs.classes != '' }}
        run: |
          git config user.name "bassemmarji"
          git config user.email "bassemmarji@github.com"
      
          SRC_DIR="org-metadata/force-app/main/default/classes"
          FILES_ADDED=0
      
          for CLASS in ${{ steps.find_missing.outputs.classes }}; do
            TEST_CLASS="$SRC_DIR/${CLASS}Test.cls"
            META_FILE="$SRC_DIR/${CLASS}Test.cls-meta.xml"
            
            if [ -f "$TEST_CLASS" ]; then
              git add "$TEST_CLASS"
              FILES_ADDED=$((FILES_ADDED + 1))
            fi
      
            if [ -f "$META_FILE" ]; then
              git add "$META_FILE"
            fi
          done
      
          if [ "$FILES_ADDED" -gt 0 ]; then
            git commit -m "ü§ñ Auto-generated Apex test classes using Ollama DeepSeek"
            git push
          else
            echo "‚ö†Ô∏è No new test classes were added. Nothing to commit."
          fi
