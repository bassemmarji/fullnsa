name: AI Powered Apex Tests Generator with (Qwen-Coder)

on:
  workflow_dispatch:
    inputs:
      ORG_ALIAS:
        type: string
        description: "Salesforce org alias"
        required: true
        default: "dev"
      CLASS_NAME:
        type: string
        description: "Name of the Apex class to generate test class for"
        required: true
        default: "GitHubActionTrigger"

env:
  ORG_ALIAS: ${{ github.event.inputs.ORG_ALIAS }}
  CLASS_NAME: ${{ github.event.inputs.CLASS_NAME }}

jobs:
  generate_test_class:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ‚ö° Install Dependencies
        run: |
          # Install Salesforce CLI
          npm install --global @salesforce/cli
          sf plugins:update
          sf --version
          # Install jq for JSON processing
          sudo apt-get update && sudo apt-get install -y jq

      - name: üß† Install Ollama And Pull Qwen-Coder Model
        run: |
          curl -fsSL https://ollama.com/install.sh  | sh
          nohup ollama serve > /dev/null 2>&1 &
          
          # Wait for Ollama to be ready
          for i in {1..30}; do
            if ollama list | grep -q "qwen"; then
              echo "Ollama is ready."
              break
            fi
            echo "Waiting for Ollama... ($i/30)"
            sleep 5
          done
      
          # ‚úÖ Use a valid model name
          ollama pull qwen2.5-coder:7b
    
      - name: üîê Authenticate to Salesforce Org
        run: |
          if [ -z "${{ secrets.ORG_SFDX_URL }}" ]; then
            echo "‚ùå Error: ORG_SFDX_URL secret is missing"
            exit 1
          fi
          echo "${{ secrets.ORG_SFDX_URL }}" | sf org login sfdx-url --alias $ORG_ALIAS --set-default --sfdx-url-stdin
          sf org list

      - name: üì¶ Retrieve Org Metadata
        run: |
          # Create full project structure
          sf project generate --name "org-metadata" --manifest
          cd ./org-metadata
          
          # Create package.xml
          mkdir -p manifest
          cat <<EOF > manifest/package.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <Package xmlns="http://soap.sforce.com/2006/04/metadata">
            <types>
              <members>${{ env.CLASS_NAME }}</members>
              <name>ApexClass</name>
            </types>
            <version>60.0</version>
          </Package>
          EOF
          sf project retrieve start --target-org $ORG_ALIAS --manifest manifest/package.xml

      - name: ‚úçÔ∏è Generate Test Class Using Ollama
        run: |
          SRC_DIR="$GITHUB_WORKSPACE/org-metadata/force-app/main/default/classes"
          GENERATED_DIR="$GITHUB_WORKSPACE/generated-tests/force-app/main/default/classes"
          mkdir -p "$GENERATED_DIR"
          
          CLASS="GitHubActionTrigger"
          echo "Generating test class for: $CLASS"
          
          CLASS_CONTENT=$(head -c 3000 "$SRC_DIR/${CLASS}.cls")
          if [ -z "$CLASS_CONTENT" ]; then
            echo "‚ö†Ô∏è Class content is empty or too small, skipping..."
            exit 1
          fi
          
          # Build a prompt string variable without heredoc/indentation issues
          PROMPT="Write a comprehensive Salesforce Apex test class named ${CLASS}Test for the following Apex class.
          Include proper test setup, positive/negative test cases, and assertions.
          Focus on testing the actual business logic in the class.
          
          Class to test:
          ${CLASS_CONTENT}
          
          Test class requirements:
          1. Must start with @isTest annotation
          2. Must include at least 75% code coverage
          3. Must follow Salesforce best practices
          4. Must include proper test data setup
          5. Must verify expected behavior through assertions
          6. Must handle error cases where appropriate
          7. Output ONLY the Apex code with no explanations, markdown, or comments outside the code
          8. Do not include any additional text before or after the class
          "
          
          # Call ollama with non-interactive settings
          RESPONSE=$(echo "$PROMPT" | timeout 900 env TERM=dumb ollama run qwen2.5-coder:7b 2>/dev/null)
          
          # Clean up response: remove ANSI codes, markdown fences, extra whitespace
          RESPONSE=$(echo "$RESPONSE" \
            | sed -E 's/\x1b\[[0-9;]*m?//g' \
            | sed -E 's/^```[a-zA-Z]*\s*//g' \
            | sed -E 's/^```$//g' \
            | sed '/^$/d' \
            | sed -z 's/\n*$/\n/' \
          )
          
          if [[ "$RESPONSE" == *"@isTest"* ]] && [[ "$RESPONSE" == *"class ${CLASS}Test"* ]]; then
            echo "$RESPONSE" > "$GENERATED_DIR/${CLASS}Test.cls"
            # heredoc must be flush left for no indentation in file!
            cat > "$GENERATED_DIR/${CLASS}Test.cls-meta.xml" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
              <apiVersion>60.0</apiVersion>
              <status>Active</status>
          </ApexClass>
          EOF
            echo "‚úÖ Successfully generated test class for $CLASS"
          else
            echo "// Auto-generated test class (failed)" > "$GENERATED_DIR/${CLASS}Test.cls"
            cat > "$GENERATED_DIR/${CLASS}Test.cls-meta.xml" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
              <apiVersion>60.0</apiVersion>
              <status>Active</status>
          </ApexClass>
          EOF
            echo "‚ö†Ô∏è Failed to generate valid test class for $CLASS"
          fi

      - name: ‚úÖ Validate Generated Test Class
        run: |
          GENERATED_DIR="$GITHUB_WORKSPACE/generated-tests/force-app/main/default/classes"
          CLASS="${{ env.CLASS_NAME }}"
          if ! grep -q "@isTest" "$GENERATED_DIR/${CLASS}Test.cls"; then
            echo "‚ùå Error: Missing @isTest in ${CLASS}Test.cls"
            exit 1
          fi
          if ! grep -q "class ${CLASS}Test" "$GENERATED_DIR/${CLASS}Test.cls"; then
            echo "‚ùå Error: Wrong class name in ${CLASS}Test.cls"
            exit 1
          fi

      - name: üöÄ Deploy Only Generated Test Class
        run: |
          GENERATED_TEST_CLASS="$GITHUB_WORKSPACE/generated-tests/force-app/main/default/classes/${CLASS}Test.cls"
          if [ ! -f "$GENERATED_TEST_CLASS" ]; then
            echo "‚ùå Generated test class not found: $GENERATED_TEST_CLASS"
            exit 1
          fi
          
          echo "üì¶ Deploying test class: ${CLASS}Test.cls"
          
          DEPLOY_RESULT=$(sf project deploy start \
            --source-dir "$GENERATED_TEST_CLASS" \
            --target-org "$ORG_ALIAS" \
            --wait 30 \
            --json \
            || true)
          
          if echo "$DEPLOY_RESULT" | jq -e '.status != 0' > /dev/null; then
            echo "‚ùå Deployment failed:"
            echo "$DEPLOY_RESULT" | jq -r '.result.details.componentFailures // .'
            exit 1
          fi
          echo "‚úÖ Successfully deployed ${CLASS}Test.cls"

      - name: üß™ Run Tests for Generated Class
        run: |
          TEST_CLASS="${{ env.CLASS_NAME }}Test"
          echo "üß™ Running Apex test: $TEST_CLASS"
    
          # Run test and capture result + exit code
          TEST_RESULT=$(sf apex run test \
            --tests "$TEST_CLASS" \
            --target-org "$ORG_ALIAS" \
            --wait 120 \
            --result-format json \
            --code-coverage \
            --json)
    
          EXIT_CODE=$?
    
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Test execution failed (compile error, timeout, or class not found):"
            echo "$TEST_RESULT" | jq -r '.message // "Unknown error"'
            exit 1
          fi
    
          # Save test result for downstream steps
          echo "test_result<<EOF" >> $GITHUB_ENV
          echo "$TEST_RESULT"
          echo "EOF"
    
          echo "Test Results Summary:"
          echo "$TEST_RESULT" | jq '.result.summary'
    
          # Check for test failures
          if echo "$TEST_RESULT" | jq -e '.result.summary.failures > 0' > /dev/null; then
            echo "‚ùå Some tests failed"
            echo "$TEST_RESULT" | jq '.result.failures'
            exit 1
          fi
    
          echo "‚úÖ All tests passed!"
    
      - name: üì¶ Upload ONLY Generated Apex Test Class as Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: generated-apex-test-class-qwen
          path: |
            ${{ github.workspace }}/generated-tests/force-app/main/default/classes/${{ env.CLASS_NAME }}Test.cls
            ${{ github.workspace }}/generated-tests/force-app/main/default/classes/${{ env.CLASS_NAME }}Test.cls-meta.xml
    
      - name: üìù Create Test Report
        if: always()
        run: |
          CLASS_NAME="${{ env.CLASS_NAME }}"
          TEST_CLASS="${CLASS_NAME}Test"
    
          echo "## üß™ Apex Test Generation Report (Qwen-Coder)" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Test Class" >> $GITHUB_STEP_SUMMARY
          echo "| Class Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${TEST_CLASS}.cls\` | ‚úÖ Generated & Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
    
          # Add test summary if available
          if [ -n "$TEST_RESULT" ]; then
            echo "### Test Execution Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$TEST_RESULT" | jq '.result.summary' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Test Execution Summary" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Test did not run or failed to execute." >> $GITHUB_STEP_SUMMARY
          fi
    
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Review the generated test class in **Artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "- üìä Check code coverage and assertion details" >> $GITHUB_STEP_SUMMARY
          echo "- üîÅ Refactor prompt or Apex logic if test fails" >> $GITHUB_STEP_SUMMARY
          echo "- üöÄ Promote to higher environments after validation" >> $GITHUB_STEP_SUMMARY
    
    
